<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ì¹´ì´ì œê³± êµì°¨í‘œ ë¶„ì„</title>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

<style>
  :root{
    --bg:#f4f5f7; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --success:#059669;
    --shadow:0 8px 30px rgba(16,24,40,0.06);
  }
  *{box-sizing:border-box}
  body{font-family:"Inter","Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111827;padding:24px;display:flex;gap:20px;min-height:100vh}
  .sidebar{width:260px;background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);height:fit-content}
  .sidebar h2{text-align:center;margin-bottom:10px}
  .menu-item{display:block;padding:10px 12px;border-radius:12px;color:#374151;margin-bottom:8px;cursor:pointer;transition:all .18s ease}
  .menu-item.active{background:var(--accent);color:white;font-weight:600;box-shadow:0 6px 18px rgba(37,99,235,0.14)}
  .main{flex:1;display:flex;flex-direction:column;gap:16px}
  .panel{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  h3{margin:0 0 15px 0;font-size:16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.success{background:var(--success);color:#fff}
  .btn.ghost{background:#f3f4f6;color:#111827}
  select,input[type="file"]{padding:8px;border-radius:8px;border:1px solid #e6eef7;margin-top:8px}
  input[type="file"]{width:auto}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .resultCard{margin-top:20px;padding:15px;background:#fafafa;border-radius:12px}
  .graphRow{display:flex;gap:20px;margin-top:10px}
  .graphCell{flex:1}
  .section{margin-bottom:15px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .var-select{width:220px;margin-top:6px}
  .interpretation{background:#f8fafc;border-left:4px solid #64748b;padding:15px;margin-top:15px;border-radius:8px;border:1px solid #e2e8f0}
  .interpretation h4{margin:0 0 10px 0;color:#334155}
</style>
</head>
<body>

  <div class="sidebar">
    <h2>ğŸ”„ ë¶„ì„ ë©”ë‰´</h2>
    <div id="menuList">
      <div class="menu-item active">ì¹´ì´ì œê³± êµì°¨í‘œ</div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <h1>ğŸ”„ ì¹´ì´ì œê³± êµì°¨í‘œ ë¶„ì„</h1>
      <div class="muted">CSV ì—…ë¡œë“œ â†’ ë³€ìˆ˜ ì„ íƒ â†’ ë¶„ì„ ì‹¤í–‰</div>
    </div>

    <div class="panel">
      <h3>ë°ì´í„° ì—…ë¡œë“œ</h3>
      <div class="inline">
        <input id="file" type="file" accept=".csv">
        <button id="loadExample" class="btn success">ì˜ˆì œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      
      <div id="varSelectPanel" class="section" style="margin-top:15px; display:none">
        <div style="margin-bottom:10px">
          <strong>ë²”ì£¼í˜• ë³€ìˆ˜ ì„ íƒ (ë‘ ê°œ ì„ íƒ):</strong><br>
          <select id="catSelect" multiple size="6" class="var-select"></select>
        </div>
        <div class="controls">
          <button id="runBasic" class="btn primary">ê¸°ë³¸ ë¶„ì„</button>
          <button id="runDetailed" class="btn success">ìƒì„¸ ë¶„ì„</button>
        </div>
      </div>
    </div>

    <div class="panel" id="resultPanel" style="display:none">
      <h3>ë¶„ì„ ê²°ê³¼</h3>
      <div id="results"></div>
    </div>

    <div class="panel" id="interpretationPanel" style="display:none">
      <h3>ê²°ê³¼ í•´ì„</h3>
      <div id="interpretation"></div>
    </div>
  </div>

<script>
let parsedData = null;
let analysisResults = null;

function parseCSV(text) {
  const { data, errors } = Papa.parse(text.trim(), {
    header: true,
    dynamicTyping: false,
    skipEmptyLines: true
  });
  if (errors && errors.length) throw new Error('CSV íŒŒì‹± ì˜¤ë¥˜: ' + errors[0].message);
  if (!data.length) throw new Error('ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.');

  const headers = Object.keys(data[0]);
  const catCols = headers.filter(h => {
    const values = data.map(row => row[h]).filter(v => v !== null && v !== "");
    const uniqueValues = [...new Set(values)];
    return uniqueValues.length >= 2 && uniqueValues.length <= Math.min(20, values.length * 0.8);
  });

  const catSelect = document.getElementById("catSelect");
  catSelect.innerHTML = "";
  catCols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; 
    opt.textContent = c;
    catSelect.appendChild(opt);
  });

  document.getElementById("varSelectPanel").style.display = "block";
  return { raw: data, catCols };
}

// í†µê³„ í•¨ìˆ˜ë“¤
function gammaln(x) {
  const cof = [76.18009172947146, -86.50532032941677, 24.01409824083091,
               -1.231739572450155, 0.1208650973866179e-2, -0.5395239384953e-5];
  let y = x; 
  let tmp = x + 5.5; 
  tmp -= (x + 0.5) * Math.log(tmp);
  let ser = 1.000000000190015;
  for (let j = 0; j < cof.length; j++) { 
    y += 1; 
    ser += cof[j] / y; 
  }
  return -tmp + Math.log(2.5066282746310005 * ser / x);
}

function regularizedGammaP(a, x) {
  if (x < 0 || a <= 0) return 0;
  if (x === 0) return 0;
  if (x < a + 1) {
    let ap = a, sum = 1 / a, del = sum;
    for (let n = 1; n <= 200; n++) {
      ap += 1; 
      del *= x / ap; 
      sum += del;
      if (Math.abs(del) < Math.abs(sum) * 1e-14) break;
    }
    return sum * Math.exp(-x + a * Math.log(x) - gammaln(a));
  } else {
    let b = x + 1 - a, c = 1 / 1e-30, d = 1 / b, h = d;
    for (let i = 1; i <= 200; i++) {
      const an = -i * (i - a);
      b += 2;
      d = an * d + b;
      if (Math.abs(d) < 1e-30) d = 1e-30;
      c = b + an / c;
      if (Math.abs(c) < 1e-30) c = 1e-30;
      d = 1 / d;
      const del = d * c;
      h *= del;
      if (Math.abs(del - 1.0) < 1e-14) break;
    }
    const Q = Math.exp(-x + a * Math.log(x) - gammaln(a)) * h;
    return 1 - Q;
  }
}

function cramersV(chi2, n, rows, cols) {
  const k = Math.min(rows, cols);
  return Math.sqrt(chi2 / (n * (k - 1)));
}

function pearsonResiduals(observed, expected) {
  return observed.map((row, i) => 
    row.map((cell, j) => 
      expected[i][j] > 0 ? (cell - expected[i][j]) / Math.sqrt(expected[i][j]) : 0
    )
  );
}

function calculateChiSquare(var1, var2) {
  if (!parsedData || !parsedData.raw) {
    throw new Error('ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }
  
  const data = parsedData.raw;
  
  // ìœ íš¨í•œ ê´€ì¸¡ì¹˜ë§Œ ì„ íƒ
  const validData = [];
  for (let i = 0; i < data.length; i++) {
    const v1 = data[i][var1];
    const v2 = data[i][var2];
    if (v1 && v1 !== "" && v1 !== null && v1 !== undefined &&
        v2 && v2 !== "" && v2 !== null && v2 !== undefined) {
      validData.push([String(v1).trim(), String(v2).trim()]);
    }
  }
  
  if (validData.length === 0) {
    throw new Error('ì„ íƒí•œ ë³€ìˆ˜ë“¤ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  const levels1 = [...new Set(validData.map(d => d[0]))].sort();
  const levels2 = [...new Set(validData.map(d => d[1]))].sort();
  
  const R = levels1.length;
  const C = levels2.length;
  const N = validData.length;
  
  if (R < 2 || C < 2) {
    throw new Error('ê° ë³€ìˆ˜ëŠ” ìµœì†Œ 2ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ê°’ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.');
  }
  
  // ê´€ì°°ë¹ˆë„ ê³„ì‚°
  const observed = Array.from({length: R}, () => Array(C).fill(0));
  validData.forEach(([v1, v2]) => {
    const i = levels1.indexOf(v1);
    const j = levels2.indexOf(v2);
    if (i >= 0 && j >= 0) {
      observed[i][j]++;
    }
  });
  
  // ì£¼ë³€ í•© ê³„ì‚°
  const rowSums = observed.map(row => row.reduce((sum, val) => sum + val, 0));
  const colSums = levels2.map((_, j) => observed.reduce((sum, row) => sum + row[j], 0));
  
  // ê¸°ëŒ€ë¹ˆë„ ê³„ì‚°
  const expected = Array.from({length: R}, () => Array(C).fill(0));
  for (let i = 0; i < R; i++) {
    for (let j = 0; j < C; j++) {
      expected[i][j] = (rowSums[i] * colSums[j]) / N;
    }
  }
  
  // ì¹´ì´ì œê³± í†µê³„ëŸ‰ ê³„ì‚°
  let chi2 = 0;
  for (let i = 0; i < R; i++) {
    for (let j = 0; j < C; j++) {
      if (expected[i][j] > 0) {
        chi2 += Math.pow(observed[i][j] - expected[i][j], 2) / expected[i][j];
      }
    }
  }
  
  const df = (R - 1) * (C - 1);
  const pvalue = df > 0 ? (1 - regularizedGammaP(df / 2, chi2 / 2)) : NaN;
  const cramersVValue = cramersV(chi2, N, R, C);
  const residuals = pearsonResiduals(observed, expected);
  
  return {
    observed,
    expected,
    residuals,
    rowSums,
    colSums,
    levels1,
    levels2,
    chi2,
    df,
    pvalue,
    cramersV: cramersVValue,
    N,
    R,
    C
  };
}

function renderChiSquareBasic(result, var1, var2) {
  let html = `<div class='resultCard'><h4>ì¹´ì´ì œê³± êµì°¨í‘œ: ${var1} Ã— ${var2}</h4>`;
  
  // ê¸°ë³¸ í†µê³„ëŸ‰ í…Œì´ë¸”
  html += `<table><thead><tr><th>í†µê³„ëŸ‰</th><th>ê°’</th></tr></thead>`;
  html += `<tbody>`;
  html += `<tr><td>ì¹´ì´ì œê³± í†µê³„ëŸ‰</td><td>${result.chi2.toFixed(4)}</td></tr>`;
  html += `<tr><td>ììœ ë„</td><td>${result.df}</td></tr>`;
  html += `<tr><td>p-ê°’</td><td>${result.pvalue < 0.001 ? result.pvalue.toExponential(3) : result.pvalue.toFixed(4)}</td></tr>`;
  html += `<tr><td>í¬ë˜ë¨¸ì˜ V</td><td>${result.cramersV.toFixed(4)}</td></tr>`;
  html += `<tr><td>í‘œë³¸ í¬ê¸°</td><td>${result.N}</td></tr>`;
  html += `</tbody></table>`;
  
  // êµì°¨í‘œ
  html += `<h5>êµì°¨í‘œ</h5>`;
  html += `<table><thead><tr><th>${var1} \\ ${var2}</th>${result.levels2.map(h=>`<th>${h}</th>`).join('')}<th>í•©ê³„</th></tr></thead>`;
  html += `<tbody>`;
  for(let i=0; i<result.R; i++){
    html += `<tr><td><strong>${result.levels1[i]}</strong></td>`;
    for(let j=0; j<result.C; j++){
      html += `<td>${result.observed[i][j]}</td>`;
    }
    html += `<td><strong>${result.rowSums[i]}</strong></td></tr>`;
  }
  html += `<tr><td><strong>í•©ê³„</strong></td>${result.colSums.map(sum => `<td><strong>${sum}</strong></td>`).join('')}<td><strong>${result.N}</strong></td></tr>`;
  html += `</tbody></table>`;
  
  html += `</div>`;
  return html;
}

function renderChiSquareDetailed(result, var1, var2) {
  let html = `<div class='resultCard'><h4>ì¹´ì´ì œê³± êµì°¨í‘œ (ìƒì„¸): ${var1} Ã— ${var2}</h4>`;
  
  // ê¸°ë³¸ í†µê³„ëŸ‰ í…Œì´ë¸”
  html += `<table><thead><tr><th>í†µê³„ëŸ‰</th><th>ê°’</th></tr></thead>`;
  html += `<tbody>`;
  html += `<tr><td>ì¹´ì´ì œê³± í†µê³„ëŸ‰</td><td>${result.chi2.toFixed(4)}</td></tr>`;
  html += `<tr><td>ììœ ë„</td><td>${result.df}</td></tr>`;
  html += `<tr><td>p-ê°’</td><td>${result.pvalue < 0.001 ? result.pvalue.toExponential(3) : result.pvalue.toFixed(4)}</td></tr>`;
  html += `<tr><td>í¬ë˜ë¨¸ì˜ V</td><td>${result.cramersV.toFixed(4)}</td></tr>`;
  html += `<tr><td>í‘œë³¸ í¬ê¸°</td><td>${result.N}</td></tr>`;
  html += `</tbody></table>`;
  
  // ê´€ì°°ë¹ˆë„ + ê¸°ëŒ€ë¹ˆë„ êµì°¨í‘œ
  html += `<h5>êµì°¨í‘œ (ê´€ì°°ë¹ˆë„ / ê¸°ëŒ€ë¹ˆë„)</h5>`;
  html += `<table><thead><tr><th>${var1} \\ ${var2}</th>${result.levels2.map(h=>`<th>${h}</th>`).join('')}<th>í•©ê³„</th></tr></thead>`;
  html += `<tbody>`;
  for(let i=0; i<result.R; i++){
    html += `<tr><td><strong>${result.levels1[i]}</strong></td>`;
    for(let j=0; j<result.C; j++){
      html += `<td>${result.observed[i][j]} <small style="color:#666">(E=${result.expected[i][j].toFixed(2)})</small></td>`;
    }
    html += `<td><strong>${result.rowSums[i]}</strong></td></tr>`;
  }
  html += `<tr><td><strong>í•©ê³„</strong></td>${result.colSums.map(sum => `<td><strong>${sum}</strong></td>`).join('')}<td><strong>${result.N}</strong></td></tr>`;
  html += `</tbody></table>`;
  
  // í‘œì¤€í™” ì”ì°¨ í…Œì´ë¸”
  html += `<h5>í‘œì¤€í™” ì”ì°¨</h5>`;
  html += `<table><thead><tr><th>${var1} \\ ${var2}</th>${result.levels2.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  html += `<tbody>`;
  for(let i=0; i<result.R; i++){
    html += `<tr><td><strong>${result.levels1[i]}</strong></td>`;
    for(let j=0; j<result.C; j++){
      const residual = result.residuals[i][j];
      const color = Math.abs(residual) > 2 ? 'color: red' : Math.abs(residual) > 1.96 ? 'color: orange' : '';
      html += `<td style="${color}">${residual.toFixed(3)}</td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  
  // ê°€ì • ê²€í† 
  let lowExpectedCells = 0;
  let minExpected = Infinity;
  for (let i = 0; i < result.R; i++) {
    for (let j = 0; j < result.C; j++) {
      if (result.expected[i][j] < 5) lowExpectedCells++;
      if (result.expected[i][j] < minExpected) minExpected = result.expected[i][j];
    }
  }
  const totalCells = result.R * result.C;
  const percentLowExpected = (lowExpectedCells / totalCells) * 100;
  
  html += `<h5>ê°€ì • ê²€í† </h5>`;
  html += `<ul>`;
  html += `<li>ê¸°ëŒ€ë¹ˆë„ 5 ë¯¸ë§Œì¸ ì…€: ${lowExpectedCells}ê°œ (${percentLowExpected.toFixed(1)}%)</li>`;
  html += `<li>ìµœì†Œ ê¸°ëŒ€ë¹ˆë„: ${minExpected.toFixed(2)}</li>`;
  html += `<li>ì „ì²´ ì…€ ìˆ˜: ${totalCells}ê°œ</li>`;
  html += `</ul>`;
  
  if (percentLowExpected <= 20 && minExpected >= 1) {
    html += `<div class="muted">âœ… ì¹´ì´ì œê³± ê²€ì •ì˜ ê°€ì •ì´ ì¶©ì¡±ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
  } else {
    html += `<div class="muted">âš ï¸ ê¸°ëŒ€ë¹ˆë„ê°€ ë‚®ì€ ì…€ì´ ë§ìŠµë‹ˆë‹¤. Fisher's exact testë‚˜ ë²”ì£¼ í•©ì¹˜ê¸°ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.</div>`;
  }
  
  html += `</div>`;
  
  // ì‹œê°í™”
  const divId1 = `heatmap_${var1}_${var2}`;
  const divId2 = `residual_${var1}_${var2}`;
  html += `<div class='graphRow'><div class='graphCell'><div id='${divId1}' style='height:300px'></div></div><div class='graphCell'><div id='${divId2}' style='height:300px'></div></div></div>`;
  
  setTimeout(() => {
    // ê´€ì°°ë¹ˆë„ íˆíŠ¸ë§µ
    Plotly.newPlot(divId1, [{
      z: result.observed,
      x: result.levels2,
      y: result.levels1,
      type: 'heatmap',
      colorscale: 'Blues',
      text: result.observed,
      texttemplate: "%{text}",
      textfont: {size: 12, color: "white"}
    }], {
      title: `ê´€ì°° ë¹ˆë„: ${var1} Ã— ${var2}`,
      xaxis: {title: var2},
      yaxis: {title: var1},
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
    
    // ì”ì°¨ íˆíŠ¸ë§µ
    Plotly.newPlot(divId2, [{
      z: result.residuals,
      x: result.levels2,
      y: result.levels1,
      type: 'heatmap',
      colorscale: 'RdBu',
      zmid: 0,
      text: result.residuals.map(row => row.map(val => val.toFixed(2))),
      texttemplate: "%{text}",
      textfont: {size: 12}
    }], {
      title: `í‘œì¤€í™” ì”ì°¨: ${var1} Ã— ${var2}`,
      xaxis: {title: var2},
      yaxis: {title: var1},
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
  }, 100);
  
  return html;
}

function generateInterpretation(result, var1, var2, isDetailed = false) {
  if (!result) return;

  let html = '<div class="interpretation">';
  html += '<h4>ğŸ”„ ì¹´ì´ì œê³± êµì°¨í‘œ ë¶„ì„ í•´ì„</h4>';
  
  // ê¸°ë³¸ ìœ ì˜ì„± ê²€ì • ê²°ê³¼
  if (result.pvalue < 0.001) {
    html += `<div style="margin-bottom:15px;"><strong>ë§¤ìš° ê°•í•œ ì—°ê´€ì„±:</strong><br>`;
    html += `â€¢ ${var1}ê³¼ ${var2} ê°„ì— í†µê³„ì ìœ¼ë¡œ ë§¤ìš° ìœ ì˜í•œ ì—°ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤ (Ï‡Â² = ${result.chi2.toFixed(3)}, df = ${result.df}, p < 0.001).<br>`;
  } else if (result.pvalue < 0.01) {
    html += `<div style="margin-bottom:15px;"><strong>ê°•í•œ ì—°ê´€ì„±:</strong><br>`;
    html += `â€¢ ${var1}ê³¼ ${var2} ê°„ì— í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ì—°ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤ (Ï‡Â² = ${result.chi2.toFixed(3)}, df = ${result.df}, p < 0.01).<br>`;
  } else if (result.pvalue < 0.05) {
    html += `<div style="margin-bottom:15px;"><strong>ìœ ì˜í•œ ì—°ê´€ì„±:</strong><br>`;
    html += `â€¢ ${var1}ê³¼ ${var2} ê°„ì— í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ì—°ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤ (Ï‡Â² = ${result.chi2.toFixed(3)}, df = ${result.df}, p = ${result.pvalue.toFixed(3)}).<br>`;
  } else {
    html += `<div style="margin-bottom:15px;"><strong>ì—°ê´€ì„± ì—†ìŒ:</strong><br>`;
    html += `â€¢ ${var1}ê³¼ ${var2} ê°„ì— í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•œ ì—°ê´€ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (Ï‡Â² = ${result.chi2.toFixed(3)}, df = ${result.df}, p = ${result.pvalue.toFixed(3)}).<br>`;
  }
  
  // íš¨ê³¼í¬ê¸° í•´ì„
  if (result.cramersV < 0.1) {
    html += `â€¢ í¬ë˜ë¨¸ì˜ V = ${result.cramersV.toFixed(3)}ìœ¼ë¡œ <strong>ë§¤ìš° ì•½í•œ ì—°ê´€ì„±</strong>ì…ë‹ˆë‹¤. ì‹¤ì§ˆì  ì˜ë¯¸ëŠ” ì œí•œì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>`;
  } else if (result.cramersV < 0.3) {
    html += `â€¢ í¬ë˜ë¨¸ì˜ V = ${result.cramersV.toFixed(3)}ìœ¼ë¡œ <strong>ì•½í•œ ì—°ê´€ì„±</strong>ì…ë‹ˆë‹¤. ì‘ì§€ë§Œ ì˜ë¯¸ìˆëŠ” ì—°ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤.<br>`;
  } else if (result.cramersV < 0.5) {
    html += `â€¢ í¬ë˜ë¨¸ì˜ V = ${result.cramersV.toFixed(3)}ìœ¼ë¡œ <strong>ì¤‘ê°„ ì •ë„ì˜ ì—°ê´€ì„±</strong>ì…ë‹ˆë‹¤. ì‹¤ì§ˆì ìœ¼ë¡œ ì˜ë¯¸ìˆëŠ” ì—°ê´€ì„±ì…ë‹ˆë‹¤.<br>`;
  } else {
    html += `â€¢ í¬ë˜ë¨¸ì˜ V = ${result.cramersV.toFixed(3)}ìœ¼ë¡œ <strong>ê°•í•œ ì—°ê´€ì„±</strong>ì…ë‹ˆë‹¤. ë§¤ìš° ê°•í•œ ì‹¤ì§ˆì  ì—°ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤.<br>`;
  }
  html += `</div>`;
  
  if (isDetailed) {
    // ì”ì°¨ ë¶„ì„
    let significantResiduals = [];
    for (let i = 0; i < result.R; i++) {
      for (let j = 0; j < result.C; j++) {
        if (Math.abs(result.residuals[i][j]) > 2) {
          const direction = result.residuals[i][j] > 0 ? 'ì˜ˆìƒë³´ë‹¤ ë§ìŒ' : 'ì˜ˆìƒë³´ë‹¤ ì ìŒ';
          significantResiduals.push(`${result.levels1[i]} Ã— ${result.levels2[j]}: ${direction} (ì”ì°¨ = ${result.residuals[i][j].toFixed(2)})`);
        }
      }
    }
    
    if (significantResiduals.length > 0) {
      html += `<div style="margin-bottom:15px;"><strong>ì£¼ëª©í•  ë§Œí•œ ì…€ë“¤:</strong><br>`;
      significantResiduals.forEach(item => {
        html += `â€¢ ${item}<br>`;
      });
      html += `</div>`;
    }
    
    // ì‹¤ìš©ì  í•´ì„
    if (result.pvalue < 0.05 && result.cramersV > 0.1) {
      html += `<div style="margin-bottom:15px;"><strong>ì‹¤ìš©ì  í•´ì„:</strong><br>`;
      html += `â€¢ <strong>${var1}</strong>ì˜ ê°’ì„ ì•Œë©´ <strong>${var2}</strong>ì˜ ë¶„í¬ë¥¼ ì–´ëŠ ì •ë„ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë‘ ë³€ìˆ˜ëŠ” ì„œë¡œ ë…ë¦½ì ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
    } else if (result.pvalue < 0.05 && result.cramersV <= 0.1) {
      html += `<div style="margin-bottom:15px;"><strong>ì‹¤ìš©ì  í•´ì„:</strong><br>`;
      html += `â€¢ í†µê³„ì ìœ¼ë¡œëŠ” ìœ ì˜í•˜ì§€ë§Œ ì‹¤ì§ˆì  ì—°ê´€ì„±ì€ ë§¤ìš° ì•½í•©ë‹ˆë‹¤. í‘œë³¸ í¬ê¸°ê°€ í´ ë•Œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆëŠ” í˜„ìƒì…ë‹ˆë‹¤.</div>`;
    } else {
      html += `<div style="margin-bottom:15px;"><strong>ì‹¤ìš©ì  í•´ì„:</strong><br>`;
      html += `â€¢ <strong>${var1}</strong>ê³¼ <strong>${var2}</strong>ëŠ” í†µê³„ì ìœ¼ë¡œ ë…ë¦½ì ì¸ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. í•œ ë³€ìˆ˜ì˜ ê°’ì´ ë‹¤ë¥¸ ë³€ìˆ˜ì˜ ë¶„í¬ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
    }
  }
  
  html += '</div>';
  
  document.getElementById('interpretation').innerHTML = html;
  document.getElementById('interpretationPanel').style.display = 'block';
}

function runBasicAnalysis() {
  if (!parsedData) {
    alert("CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”");
    return;
  }

  const selected = Array.from(document.getElementById("catSelect").selectedOptions).map(o => o.value);
  if (selected.length !== 2) {
    alert("ì •í™•íˆ ë‘ ê°œì˜ ë³€ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  try {
    const [var1, var2] = selected;
    const result = calculateChiSquare(var1, var2);
    
    analysisResults = result;
    
    let html = renderChiSquareBasic(result, var1, var2);
    
    document.getElementById("results").innerHTML = html;
    document.getElementById("resultPanel").style.display = "block";
    
    generateInterpretation(result, var1, var2, false);
  } catch (error) {
    alert("ë¶„ì„ ì˜¤ë¥˜: " + error.message);
  }
}

function runDetailedAnalysis() {
  if (!parsedData) {
    alert("CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”");
    return;
  }

  const selected = Array.from(document.getElementById("catSelect").selectedOptions).map(o => o.value);
  if (selected.length !== 2) {
    alert("ì •í™•íˆ ë‘ ê°œì˜ ë³€ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  try {
    const [var1, var2] = selected;
    const result = calculateChiSquare(var1, var2);
    
    analysisResults = result;
    
    let html = renderChiSquareDetailed(result, var1, var2);
    
    document.getElementById("results").innerHTML = html;
    document.getElementById("resultPanel").style.display = "block";
    
    generateInterpretation(result, var1, var2, true);
  } catch (error) {
    alert("ë¶„ì„ ì˜¤ë¥˜: " + error.message);
  }
}

// ì´ë²¤íŠ¸ ì²˜ë¦¬
document.getElementById("file").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  try {
    parsedData = parseCSV(text);
  } catch (error) {
    alert("íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: " + error.message);
  }
});

document.getElementById("loadExample").addEventListener("click", () => {
  const sampleData = `Gender,Education,Satisfaction,Age_Group
Male,High_School,High,Young
Female,College,Medium,Adult
Male,Graduate,High,Adult
Female,High_School,Low,Young
Male,College,Medium,Adult
Female,Graduate,High,Adult
Male,High_School,Medium,Young
Female,College,High,Adult
Male,Graduate,High,Adult
Female,High_School,Medium,Young
Male,College,Low,Adult
Female,Graduate,High,Adult
Male,High_School,High,Young
Female,College,Medium,Adult
Male,Graduate,Low,Adult
Female,High_School,Medium,Young
Male,College,High,Adult
Female,Graduate,Medium,Adult
Male,High_School,Low,Young
Female,College,High,Adult`;

  try {
    parsedData = parseCSV(sampleData);
  } catch (error) {
    alert("ì˜ˆì œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: " + error.message);
  }
});

document.getElementById("runBasic").addEventListener("click", runBasicAnalysis);
document.getElementById("runDetailed").addEventListener("click", runDetailedAnalysis);
</script>
</body>
</html>
