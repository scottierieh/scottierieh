<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìä IPA Survey Platform</title>

<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --accent:#3b82f6; --success:#10b981;
    --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6; --info:#06b6d4;
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1);
    --gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  }
  
  * {box-sizing:border-box;margin:0;padding:0;}
  
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#1e293b;line-height:1.6}
  
  /* Header Navigation */
  .header{background:white;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
  .header-content{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px}
  .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
  .logo-icon{width:40px;height:40px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white}
  
  .nav-tabs{display:flex;gap:4px;background:#f1f5f9;padding:4px;border-radius:12px}
  .nav-tab{padding:8px 16px;border-radius:8px;border:none;background:transparent;cursor:pointer;font-weight:500;color:#64748b;transition:all 0.2s}
  .nav-tab.active{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
  .nav-tab:hover:not(.active){color:#1e293b}
  
  .header-actions{display:flex;gap:12px;align-items:center}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
  
  /* Main Layout */
  .main-container{max-width:1400px;margin:0 auto;padding:24px}
  .content-area{display:none}
  .content-area.active{display:block}
  
  /* Cards and Panels */
  .card{background:white;border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:20px}
  .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #e2e8f0}
  .card-title{font-size:18px;font-weight:600;color:#1e293b}
  
  /* Buttons */
  .btn{border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn.primary{background:var(--accent);color:white}
  .btn.success{background:var(--success);color:white}
  .btn.warning{background:var(--warning);color:white}
  .btn.danger{background:var(--danger);color:white}
  .btn.ghost{background:#f1f5f9;color:#475569}
  .btn.small{padding:6px 12px;font-size:13px}
  .btn.large{padding:14px 28px;font-size:16px}
  
  /* Forms */
  input[type="text"],input[type="number"],input[type="email"],textarea,select{
    width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;font-family:inherit
  }
  input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
  label{display:block;margin-bottom:6px;font-weight:500;color:#475569;font-size:14px}
  .form-group{margin-bottom:20px}
  .form-hint{font-size:12px;color:var(--muted);margin-top:4px}
  
  /* Scale selector */
  .scale-selector{display:inline-flex;gap:8px;margin-left:12px}
  .scale-btn{padding:6px 12px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s}
  .scale-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
  
  /* IPA specific styles */
  .ipa-section{background:#f8fafc;border-radius:12px;padding:20px;margin-bottom:16px;border-left:4px solid var(--accent)}
  .attribute-item{background:white;border-radius:8px;padding:16px;margin-bottom:12px;border:1px solid #e2e8f0;position:relative}
  .attribute-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .attribute-name{flex:1;margin-right:12px}
  .attribute-controls{display:flex;gap:8px}
  .delete-btn{background:var(--danger);color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px}
  
  /* Likert Scale */
  .likert-scale{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:16px 0}
  .likert-item{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
  .likert-radio{width:32px;height:32px;border-radius:50%;border:2px solid #cbd5e1;cursor:pointer;position:relative;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:#94a3b8}
  .likert-radio:hover{border-color:var(--accent);transform:scale(1.1)}
  .likert-radio.selected{background:var(--accent);border-color:var(--accent);color:white;transform:scale(1.15)}
  .likert-label{font-size:11px;text-align:center;color:var(--muted);max-width:60px}
  
  /* Collapsible sections */
  .collapsible-section{background:white;border-radius:12px;margin-bottom:20px;overflow:hidden;box-shadow:var(--shadow)}
  .collapsible-header{padding:16px 20px;background:#f8fafc;border-bottom:2px solid #e2e8f0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s}
  .collapsible-header:hover{background:#f1f5f9}
  .collapsible-title{font-weight:600;color:#1e293b;display:flex;align-items:center;gap:8px}
  .collapsible-arrow{transition:transform 0.3s;font-size:20px;color:#64748b}
  .collapsible-content{padding:20px;display:none}
  .collapsible-section.active .collapsible-content{display:block}
  .collapsible-section.active .collapsible-arrow{transform:rotate(90deg)}
  
  /* Survey Settings */
  .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
  .setting-card{background:#f8fafc;border-radius:8px;padding:16px;border:1px solid #e2e8f0}
  .setting-label{font-weight:500;color:#475569;margin-bottom:8px;font-size:14px}
  .setting-input{width:100%}
  .code-display{background:#1e293b;color:#10b981;padding:12px;border-radius:6px;font-family:monospace;font-size:13px;margin-top:8px;word-break:break-all}
  
  /* Response Collection */
  .response-item{background:white;border-radius:8px;padding:16px;margin-bottom:12px;border:1px solid #e2e8f0}
  .response-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .response-id{font-weight:600;color:var(--accent)}
  .response-timestamp{font-size:12px;color:var(--muted)}
  .response-data{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .data-cell{background:#f8fafc;padding:8px;border-radius:4px;text-align:center}
  .data-label{font-size:11px;color:var(--muted);margin-bottom:2px}
  .data-value{font-weight:600}
  
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}
  .stat-card{background:white;padding:20px;border-radius:12px;border:1px solid #e2e8f0;position:relative;overflow:hidden}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient)}
  .stat-icon{width:48px;height:48px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px}
  .stat-value{font-size:32px;font-weight:700;color:#1e293b;margin-bottom:4px}
  .stat-label{font-size:14px;color:var(--muted)}
  
  /* Quick Entry Mode */
  .quick-entry{background:#e0f2fe;border-radius:12px;padding:20px;margin-bottom:20px}
  .quick-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .quick-entry-title{font-weight:600;color:#0369a1}
  .quick-entry-grid{display:grid;gap:12px}
  
  /* IPA Matrix Visualization */
  .ipa-matrix{position:relative;width:100%;height:500px;border:2px solid #e2e8f0;border-radius:8px;background:white}
  .ipa-quadrant{position:absolute;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;padding:8px}
  .ipa-point{position:absolute;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:white;font-size:12px;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
  .ipa-point:hover{transform:scale(1.2);z-index:10}
  .ipa-point-label{position:absolute;background:white;padding:4px 8px;border-radius:4px;font-size:11px;box-shadow:0 2px 4px rgba(0,0,0,0.1);white-space:nowrap;pointer-events:none}
  
  /* Notification styles */
  .notification{position:fixed;top:20px;right:20px;background:white;border-radius:8px;padding:16px;box-shadow:var(--shadow-lg);border-left:4px solid var(--success);z-index:1000;min-width:300px;transform:translateX(400px);transition:transform 0.3s}
  .notification.show{transform:translateX(0)}
  .notification-close{margin-left:auto;cursor:pointer;color:var(--muted)}
  
  /* Modal styles */
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);overflow:auto}
  .modal-content{background-color:white;margin:2% auto;padding:0;width:90%;max-width:800px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideIn 0.3s}
  @keyframes slideIn{from{transform:translateY(-100px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-header{padding:24px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center}
  .modal-close{color:white;font-size:28px;font-weight:bold;cursor:pointer;background:none;border:none;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.2s}
  .modal-close:hover{background:rgba(255,255,255,0.2)}
  .modal-body{padding:24px;max-height:70vh;overflow-y:auto}
  .preview-container{background:#f8fafc;padding:24px;border-radius:12px}
  .preview-title{font-size:24px;font-weight:700;color:#1e293b;margin-bottom:8px}
  .preview-description{color:#64748b;margin-bottom:24px}
  .preview-question{background:white;padding:20px;border-radius:8px;margin-bottom:16px;border:1px solid #e2e8f0}
  .preview-question-title{font-weight:600;margin-bottom:12px;color:#1e293b}
  .preview-scale{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .preview-scale-item{text-align:center;flex:1}
  .preview-scale-radio{width:20px;height:20px;margin:0 auto 4px}
  .preview-scale-label{font-size:11px;color:#64748b}
  
  /* Responsive */
  @media (max-width:768px){
    .header-content{padding:0 16px}
    .nav-tabs{display:none}
    .main-container{padding:16px}
    .stats-grid{grid-template-columns:1fr}
    .response-data{grid-template-columns:1fr}
    .modal-content{width:95%;margin:5% auto}
    .preview-scale{flex-wrap:wrap}
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">üìä</div>
      <span>IPA Survey</span>
    </div>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('design')">üé® Survey Design</button>
      <button class="nav-tab" onclick="switchTab('collect')">üìã Data Collection</button>
      <button class="nav-tab" onclick="switchTab('analysis')">üìà Analysis</button>
    </div>
    
    <div class="header-actions">
      <div class="user-avatar">Admin</div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">

  <!-- Design Tab -->
  <div id="design-tab" class="content-area active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-value" id="total-attributes">0</div>
        <div class="stat-label">Individual Satisfaction Items</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-value">1</div>
        <div class="stat-label">Overall Satisfaction</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="response-count">0</div>
        <div class="stat-label">Collected Responses</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üé® IPA Survey Design</h2>
        <div>
          <button class="btn ghost small" onclick="previewSurvey()">üëÅÔ∏è Preview</button>
          <button class="btn success small" onclick="loadSampleSurvey()">üìù Load Sample Survey</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>Survey Title</label>
        <input type="text" id="survey-title" placeholder="e.g., Customer Satisfaction Survey">
      </div>
      
      <div class="form-group">
        <label>Survey Description</label>
        <textarea id="survey-description" rows="2" placeholder="e.g., We value your opinion and would like to hear your feedback."></textarea>
      </div>
      
      <div class="form-group">
        <label>
          Scale Type
          <span class="scale-selector">
            <button class="scale-btn" onclick="setScale(5)" id="scale-5">5-Point Scale</button>
            <button class="scale-btn active" onclick="setScale(7)" id="scale-7">7-Point Scale</button>
          </span>
        </label>
        <div class="form-hint">The same scale will be applied to all questions</div>
      </div>
      
      <div class="ipa-section">
        <h3 style="margin-bottom:16px;font-size:16px;color:#1e293b;">üìã Individual Satisfaction Items Management</h3>
        
        <div class="form-group">
          <label>Add New Item</label>
          <div style="display:flex;gap:8px;">
            <input type="text" id="new-attribute" placeholder="e.g., Product quality, Service speed, Price fairness..." style="flex:1;">
            <button class="btn primary" onclick="addAttribute()">+ Add</button>
          </div>
        </div>
        
        <div id="attributes-container">
          <!-- Individual satisfaction items will be added here -->
        </div>
        
        <div style="margin-top:16px;padding:12px;background:#e0f2fe;border-radius:8px;">
          <small style="color:#0369a1;">
            üí° <strong>Tip:</strong> For IPA analysis, we recommend at least 5 or more individual satisfaction items.
          </small>
        </div>
      </div>
      
      <div style="background:#fef3c7;border-radius:12px;padding:20px;margin-top:20px;">
        <div style="font-size:18px;font-weight:600;color:#92400e;margin-bottom:16px;">‚≠ê Overall Satisfaction Setting</div>
        <div class="form-group" style="margin-bottom:0;">
          <label>Overall Satisfaction Question</label>
          <input type="text" id="overall-question" placeholder="e.g., Overall, how satisfied are you with our service?">
          <div class="form-hint">This question will be used as the dependent variable in IPA analysis.</div>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:24px;">
        <button class="btn primary large" onclick="saveToLocal()" style="padding:14px 40px;font-size:16px;">
          üíæ Save Survey
        </button>
      </div>
    </div>
  </div>

  <!-- Data Collection Tab -->
  <div id="collect-tab" class="content-area">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="total-responses">0</div>
        <div class="stat-label">Total Responses</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-value" id="avg-overall">0.0</div>
        <div class="stat-label">Average Overall Satisfaction</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="complete-rate">0%</div>
        <div class="stat-label">Completion Rate</div>
      </div>
    </div>
    
    <!-- Survey Settings Section -->
    <div class="collapsible-section" id="survey-settings-section">
      <div class="collapsible-header" onclick="toggleCollapse('survey-settings-section')">
        <div class="collapsible-title">
          ‚öôÔ∏è Survey Settings & Distribution
        </div>
        <span class="collapsible-arrow">‚ñ∂</span>
      </div>
      <div class="collapsible-content">
        <div class="settings-grid">
          <div class="setting-card">
            <div class="setting-label">üìÖ Survey Period Setting</div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input type="date" id="survey-start-date" class="setting-input" style="flex:1">
              <span style="align-self:center;">~</span>
              <input type="date" id="survey-end-date" class="setting-input" style="flex:1">
            </div>
            <button class="btn ghost small" onclick="setSurveyPeriod()">Set Period</button>
          </div>
          
          <div class="setting-card">
            <div class="setting-label">üîó Generate Survey Link</div>
            <button class="btn primary small" onclick="generateSurveyLink()">Generate Link</button>
            <div id="survey-link" class="code-display" style="display:none;"></div>
          </div>
          
          <div class="setting-card">
            <div class="setting-label">üì± Generate QR Code</div>
            <button class="btn ghost small" onclick="generateQRCode()">Generate QR</button>
            <div id="qr-placeholder" style="margin-top:8px;text-align:center;"></div>
          </div>
          
          <div class="setting-card">
            <div class="setting-label">üíª HTML Embed Code</div>
            <button class="btn ghost small" onclick="generateEmbedCode()">Generate Code</button>
            <div id="embed-code" class="code-display" style="display:none;"></div>
          </div>
          
          <div class="setting-card">
            <div class="setting-label">üìß Email Collection Setting</div>
            <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
              <input type="checkbox" id="collect-email" onchange="toggleEmailCollection()">
              <span style="font-size:14px;color:#475569;">Collect respondent email</span>
            </label>
          </div>
          
          <div class="setting-card">
            <div class="setting-label">üîí Access Control</div>
            <select id="access-control" onchange="updateAccessControl()" style="margin-top:8px;">
              <option value="public">Anyone can access</option>
              <option value="password">Password required</option>
              <option value="invite">Invited users only</option>
            </select>
            <input type="password" id="survey-password" placeholder="Enter password" style="margin-top:8px;display:none;">
          </div>
        </div>
        
        <div style="background:#e0f2fe;border-radius:8px;padding:16px;margin-top:16px;">
          <div style="font-weight:600;color:#0369a1;margin-bottom:8px;">üìù API Integration Code</div>
          <div class="code-display">
            POST /api/survey/submit<br>
            Headers: { "Content-Type": "application/json" }<br>
            Body: { "surveyId": "${Date.now()}", "responses": {...} }
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data Collection Section -->
    <div class="collapsible-section" id="data-entry-section">
      <div class="collapsible-header" onclick="toggleCollapse('data-entry-section')">
        <div class="collapsible-title">
          üìã Data Collection
          <span style="background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px;" id="data-entry-badge">
            0 responses
          </span>
        </div>
        <span class="collapsible-arrow">‚ñ∂</span>
      </div>
      <div class="collapsible-content">
        <div class="card" style="box-shadow:none;padding:0;">
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:16px;">
            <button class="btn ghost small" onclick="clearAllResponses()">üóëÔ∏è Clear All</button>
            <button class="btn ghost small" onclick="generateSampleData()">üé≤ Generate Sample Data</button>
            <button class="btn primary small" onclick="exportData()">üíæ Export CSV</button>
          </div>
          
          <!-- Quick Entry Mode -->
          <div class="quick-entry">
            <div class="quick-entry-header">
              <div class="quick-entry-title">‚ö° Quick Response Entry</div>
            </div>
            
            <div id="quick-response-form">
              <!-- Quick entry form will be generated here -->
            </div>
            
            <button class="btn success large" onclick="submitResponse()" style="width:100%;margin-top:16px;">
              üìù Submit Response
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Collected Responses Section -->
    <div class="collapsible-section" id="responses-section">
      <div class="collapsible-header" onclick="toggleCollapse('responses-section')">
        <div class="collapsible-title">
          üìä Collected Response Data
          <span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px;" id="responses-badge">
            0 items
          </span>
        </div>
        <span class="collapsible-arrow">‚ñ∂</span>
      </div>
      <div class="collapsible-content">
        <div id="responses-list">
          <!-- Response list will be displayed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Tab -->
  <div id="analysis-tab" class="content-area">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìà IPA Analysis</h2>
        <button class="btn primary" onclick="performAnalysis()">üîç Run Full Analysis</button>
      </div>
      
      <div id="analysis-results" style="margin-top:24px;">
        <div style="text-align:center;padding:60px;color:var(--muted);">
          <div style="font-size:48px;margin-bottom:16px;">üìä</div>
          <div>Analysis results will appear here when you run the analysis</div>
          <div style="font-size:14px;margin-top:8px;">At least 5 responses are needed for reliable analysis results.</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- Survey Preview Modal -->
<div id="preview-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="margin:0;">üìã Survey Preview</h2>
      <button class="modal-close" onclick="closePreview()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="preview-content">
        <!-- Preview content will be inserted here -->
      </div>
    </div>
  </div>
</div>

<script>
// Global state
let surveyData = {
  title: '',
  description: '',
  instructions: '',
  attributes: [],
  overallQuestion: '',
  responses: [],
  scaleType: 7 // 5 or 7 point scale
};

let currentResponse = {};
let quickMode = false;

// Immediately define global functions
window.toggleCollapse = function(sectionId) {
  const section = document.getElementById(sectionId);
  section.classList.toggle('active');
  
  // Update response count badges when toggling
  if (sectionId === 'data-entry-section' || sectionId === 'responses-section') {
    updateCollapsibleBadges();
  }
}

window.updateCollapsibleBadges = function() {
  const responseCount = surveyData.responses.length;
  const dataEntryBadge = document.getElementById('data-entry-badge');
  const responsesBadge = document.getElementById('responses-badge');
  
  if (dataEntryBadge) {
    dataEntryBadge.textContent = `${responseCount} responses`;
  }
  if (responsesBadge) {
    responsesBadge.textContent = `${responseCount} items`;
  }
}

window.setSurveyPeriod = function() {
  const startDate = document.getElementById('survey-start-date').value;
  const endDate = document.getElementById('survey-end-date').value;
  
  if (startDate && endDate) {
    surveyData.startDate = startDate;
    surveyData.endDate = endDate;
    saveToLocalStorage();
    showNotification('Setting Complete', `Survey period: ${startDate} ~ ${endDate}`, 'success');
  } else {
    showNotification('Warning', 'Please enter both start and end dates.', 'warning');
  }
}

window.generateSurveyLink = function() {
  const surveyId = Date.now();
  const baseUrl = window.location.origin;
  const surveyLink = `${baseUrl}/survey/${surveyId}`;
  
  const linkDisplay = document.getElementById('survey-link');
  linkDisplay.textContent = surveyLink;
  linkDisplay.style.display = 'block';
  
  // Copy to clipboard
  navigator.clipboard.writeText(surveyLink).then(() => {
    showNotification('Link Generated', 'Survey link has been generated and copied to clipboard.', 'success');
  });
}

window.generateQRCode = function() {
  const qrPlaceholder = document.getElementById('qr-placeholder');
  // In real implementation, use a QR code library
  qrPlaceholder.innerHTML = `
    <div style="width:150px;height:150px;margin:0 auto;background:#f0f0f0;display:flex;align-items:center;justify-content:center;border-radius:8px;">
      <span style="color:#666;">QR Code</span>
    </div>
    <div style="font-size:12px;color:#666;margin-top:8px;">QR code has been generated</div>
  `;
  showNotification('QR Generated', 'QR code has been generated.', 'success');
}

window.generateEmbedCode = function() {
  const surveyId = Date.now();
  const embedCode = `<iframe src="${window.location.origin}/embed/survey/${surveyId}" 
  width="100%" height="600" frameborder="0"></iframe>`;
  
  const codeDisplay = document.getElementById('embed-code');
  codeDisplay.textContent = embedCode;
  codeDisplay.style.display = 'block';
  
  navigator.clipboard.writeText(embedCode).then(() => {
    showNotification('Code Generated', 'HTML embed code has been generated and copied to clipboard.', 'success');
  });
}

window.toggleEmailCollection = function() {
  const collectEmail = document.getElementById('collect-email').checked;
  surveyData.collectEmail = collectEmail;
  saveToLocalStorage();
  showNotification('Setting Changed', collectEmail ? 'Email collection enabled' : 'Email collection disabled', 'info');
}

window.updateAccessControl = function() {
  const accessControl = document.getElementById('access-control').value;
  const passwordField = document.getElementById('survey-password');
  
  if (accessControl === 'password') {
    passwordField.style.display = 'block';
  } else {
    passwordField.style.display = 'none';
  }
  
  surveyData.accessControl = accessControl;
  saveToLocalStorage();
  showNotification('Access Setting', `Access control: ${accessControl === 'public' ? 'Public' : accessControl === 'password' ? 'Password' : 'Invite only'}`, 'info');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load saved data if exists, but don't auto-populate sample
  const saved = localStorage.getItem('ipaSurveyData');
  if (saved) {
    try {
      const loadedData = JSON.parse(saved);
      // Only load if it has been explicitly saved (has attributes)
      if (loadedData.attributes && loadedData.attributes.length > 0) {
        surveyData = loadedData;
        document.getElementById('survey-title').value = surveyData.title || '';
        document.getElementById('survey-description').value = surveyData.description || '';
        document.getElementById('survey-instructions').value = surveyData.instructions || '';
        document.getElementById('overall-question').value = surveyData.overallQuestion || '';
        
        // Set scale buttons
        if (surveyData.scaleType) {
          document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('active'));
          document.getElementById(`scale-${surveyData.scaleType}`).classList.add('active');
        }
        
        renderAttributes();
      }
    } catch (e) {
      console.error('Error loading saved data:', e);
      // Clear corrupted data
      localStorage.removeItem('ipaSurveyData');
    }
  }
  updateStats();
});

// Toggle collapsible sections
function toggleCollapse(sectionId) {
  const section = document.getElementById(sectionId);
  section.classList.toggle('active');
  
  // Update response count badges when toggling
  if (sectionId === 'data-entry-section' || sectionId === 'responses-section') {
    updateCollapsibleBadges();
  }
}

// Update collapsible section badges
function updateCollapsibleBadges() {
  const responseCount = surveyData.responses.length;
  const badges = document.querySelectorAll('.collapsible-title span');
  badges.forEach(badge => {
    if (badge.textContent.includes('responses') || badge.textContent.includes('items')) {
      badge.textContent = badge.textContent.includes('responses') ? 
        `${responseCount} responses` : `${responseCount} items`;
    }
  });
}

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.content-area').forEach(area => {
    area.classList.remove('active');
  });
  document.getElementById(tab + '-tab').classList.add('active');
  
  document.querySelectorAll('.nav-tab').forEach(navTab => {
    navTab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  if (tab === 'collect') {
    updateResponseForm();
    displayResponses();
  }
}

// Attribute management
function addAttribute() {
  const input = document.getElementById('new-attribute');
  const value = input.value.trim();
  
  if (value) {
    surveyData.attributes.push({
      id: Date.now(),
      name: value
    });
    input.value = '';
    renderAttributes();
    updateStats();
    saveToLocalStorage();
  }
}

window.removeAttribute = function(id) {
  if (confirm('Are you sure you want to delete this item?')) {
    surveyData.attributes = surveyData.attributes.filter(attr => attr.id !== id);
    renderAttributes();
    updateStats();
    saveToLocalStorage();
  }
}

function renderAttributes() {
  const container = document.getElementById('attributes-container');
  
  if (surveyData.attributes.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">No satisfaction items added yet.</div>';
    return;
  }
  
  container.innerHTML = surveyData.attributes.map((attr, index) => `
    <div class="attribute-item">
      <div class="attribute-header">
        <div class="attribute-name">
          <strong>${index + 1}. ${attr.name}</strong>
        </div>
        <div class="attribute-controls">
          <button class="delete-btn" onclick="window.removeAttribute(${attr.id})">Delete</button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--muted);">
        Satisfaction with this item will be measured on a ${surveyData.scaleType}-point scale
      </div>
    </div>
  `).join('');
}

// Scale type management
function setScale(scale) {
  surveyData.scaleType = scale;
  document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`scale-${scale}`).classList.add('active');
  
  // Clear existing responses if scale changes
  if (surveyData.responses.length > 0) {
    if (confirm('Changing the scale will delete existing response data. Continue?')) {
      surveyData.responses = [];
      updateStats();
    } else {
      // Revert scale change
      surveyData.scaleType = surveyData.scaleType === 5 ? 7 : 5;
      document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`scale-${surveyData.scaleType}`).classList.add('active');
      return;
    }
  }
  
  renderAttributes();
  saveToLocalStorage();
}

// Response form management
function updateResponseForm() {
  const container = document.getElementById('quick-response-form');
  
  if (surveyData.attributes.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">Please add satisfaction items in Survey Design first.</div>';
    return;
  }
  
  const maxScale = surveyData.scaleType;
  const scalePoints = Array.from({length: maxScale}, (_, i) => i + 1);
  
  let html = '<div class="quick-entry-grid">';
  
  // Response ID
  html += '<div style="margin-bottom:16px;">';
  html += '<label>Respondent ID (Optional)</label>';
  html += '<input type="text" id="respondent-id" placeholder="Auto-generated" style="max-width:200px;">';
  html += '</div>';
  
  // Individual satisfaction items
  surveyData.attributes.forEach((attr, index) => {
    html += `
      <div style="background:white;padding:12px;border-radius:8px;border:1px solid #e2e8f0;">
        <div style="font-weight:500;margin-bottom:8px;color:#1e293b;">${index + 1}. ${attr.name}</div>
        <div class="likert-scale">
          ${scalePoints.map(val => `
            <div class="likert-item">
              <div class="likert-radio" onclick="selectRating('attr-${attr.id}', ${val})" id="attr-${attr.id}-${val}">${val}</div>
              <div class="likert-label">${
                maxScale === 5 ? 
                  (val === 1 ? 'Very<br>Dissatisfied' : val === 3 ? 'Neutral' : val === 5 ? 'Very<br>Satisfied' : '') :
                  (val === 1 ? 'Very<br>Dissatisfied' : val === 4 ? 'Neutral' : val === 7 ? 'Very<br>Satisfied' : '')
              }</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  // Overall satisfaction
  html += `
    <div style="background:linear-gradient(135deg,#fef3c7,#fed7aa);padding:16px;border-radius:8px;border:2px solid var(--warning);">
      <div style="font-weight:600;margin-bottom:8px;color:#92400e;">‚≠ê ${surveyData.overallQuestion}</div>
      <div class="likert-scale">
        ${scalePoints.map(val => `
          <div class="likert-item">
            <div class="likert-radio" onclick="selectRating('overall', ${val})" id="overall-${val}" style="background:${currentResponse.overall === val ? '#f59e0b' : ''};border-color:#f59e0b;">${val}</div>
            <div class="likert-label">${
              maxScale === 5 ? 
                (val === 1 ? 'Very<br>Dissatisfied' : val === 3 ? 'Neutral' : val === 5 ? 'Very<br>Satisfied' : '') :
                (val === 1 ? 'Very<br>Dissatisfied' : val === 4 ? 'Neutral' : val === 7 ? 'Very<br>Satisfied' : '')
            }</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  html += '</div>';
  container.innerHTML = html;
}

// Rating selection
function selectRating(questionId, rating) {
  const maxScale = surveyData.scaleType;
  
  // Clear previous selections
  for (let i = 1; i <= maxScale; i++) {
    const elem = document.getElementById(`${questionId}-${i}`);
    if (elem) elem.classList.remove('selected');
  }
  
  // Select current rating
  const selectedElem = document.getElementById(`${questionId}-${rating}`);
  if (selectedElem) selectedElem.classList.add('selected');
  
  currentResponse[questionId] = rating;
}

// Submit response
function submitResponse() {
  const respondentId = document.getElementById('respondent-id').value || 
    `R${String(surveyData.responses.length + 1).padStart(3, '0')}`;
  
  // Check if all questions are answered
  const requiredQuestions = ['overall', ...surveyData.attributes.map(attr => `attr-${attr.id}`)];
  const missingAnswers = requiredQuestions.filter(q => !currentResponse[q]);
  
  if (missingAnswers.length > 0) {
    showNotification('Warning', `Please answer all items. (Unanswered: ${missingAnswers.length} items)`, 'warning');
    return;
  }
  
  // Create response object
  const response = {
    id: Date.now(),
    respondentId: respondentId,
    timestamp: new Date().toISOString(),
    overall: currentResponse.overall,
    attributes: {}
  };
  
  surveyData.attributes.forEach(attr => {
    response.attributes[attr.id] = currentResponse[`attr-${attr.id}`];
  });
  
  // Add to responses
  surveyData.responses.push(response);
  
  // Reset form
  currentResponse = {};
  updateResponseForm();
  updateStats();
  displayResponses();
  saveToLocalStorage();
  
  showNotification('Success', 'Response has been submitted successfully!', 'success');
}

// Display responses
function displayResponses() {
  const container = document.getElementById('responses-list');
  
  if (surveyData.responses.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">No responses collected yet.</div>';
    updateCollapsibleBadges();
    return;
  }
  
  const maxScale = surveyData.scaleType;
  
  container.innerHTML = surveyData.responses.map((response, index) => `
    <div class="response-item">
      <div class="response-header">
        <div class="response-id">Response #${index + 1} (${response.respondentId})</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="response-timestamp">${new Date(response.timestamp).toLocaleString()}</div>
          <button class="btn danger small" onclick="deleteResponse(${response.id})">Delete</button>
        </div>
      </div>
      <div class="response-data">
        <div class="data-cell" style="background:#fef3c7;">
          <div class="data-label">Overall Satisfaction</div>
          <div class="data-value">${response.overall}/${maxScale}</div>
        </div>
        ${surveyData.attributes.map(attr => `
          <div class="data-cell">
            <div class="data-label">${attr.name}</div>
            <div class="data-value">${response.attributes[attr.id]}/${maxScale}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
  
  updateCollapsibleBadges();
}

// Delete response
function deleteResponse(id) {
  if (confirm('Are you sure you want to delete this response?')) {
    surveyData.responses = surveyData.responses.filter(r => r.id !== id);
    updateStats();
    displayResponses();
    saveToLocalStorage();
    showNotification('Deleted', 'Response has been deleted.', 'info');
  }
}

// Make deleteResponse globally accessible
window.deleteResponse = deleteResponse;

// Clear all responses
function clearAllResponses() {
  if (confirm('Are you sure you want to delete all responses? This action cannot be undone.')) {
    surveyData.responses = [];
    updateStats();
    displayResponses();
    saveToLocalStorage();
    showNotification('All Cleared', 'All responses have been deleted.', 'warning');
  }
}

// Generate sample data
function generateSampleData() {
  if (surveyData.attributes.length === 0) {
    showNotification('Error', 'Please add survey items first.', 'error');
    return;
  }
  
  const sampleSize = 30;
  const maxScale = surveyData.scaleType;
  const midPoint = maxScale === 5 ? 3 : 4;
  
  for (let i = 0; i < sampleSize; i++) {
    const baseScore = midPoint + (Math.random() - 0.5) * 2; // Center around midpoint
    
    const response = {
      id: Date.now() + i,
      respondentId: `Sample${String(surveyData.responses.length + i + 1).padStart(3, '0')}`,
      timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
      overall: Math.max(1, Math.min(maxScale, Math.round(baseScore + (Math.random() - 0.5)))),
      attributes: {}
    };
    
    // Generate correlated scores
    surveyData.attributes.forEach(attr => {
      const variance = (Math.random() - 0.5) * 2;
      response.attributes[attr.id] = Math.max(1, Math.min(maxScale, Math.round(baseScore + variance)));
    });
    
    surveyData.responses.push(response);
  }
  
  updateStats();
  displayResponses();
  saveToLocalStorage();
  showNotification('Sample Generated', `${sampleSize} sample responses have been generated.`, 'success');
}

// Load sample survey
function loadSampleSurvey() {
  surveyData.attributes = [
    {id: 1, name: 'Product Quality'},
    {id: 2, name: 'Service Speed'},
    {id: 3, name: 'Price Fairness'},
    {id: 4, name: 'Staff Friendliness'},
    {id: 5, name: 'Accessibility/Convenience'},
    {id: 6, name: 'Customer Support'},
    {id: 7, name: 'Website/App Usability'}
  ];
  
  renderAttributes();
  updateStats();
  saveToLocalStorage();
  showNotification('Sample Loaded', 'Sample survey items have been added.', 'success');
}

// Update statistics
function updateStats() {
  document.getElementById('total-attributes').textContent = surveyData.attributes.length;
  document.getElementById('response-count').textContent = surveyData.responses.length;
  document.getElementById('total-responses').textContent = surveyData.responses.length;
  
  if (surveyData.responses.length > 0) {
    const avgOverall = surveyData.responses.reduce((sum, r) => sum + r.overall, 0) / surveyData.responses.length;
    document.getElementById('avg-overall').textContent = avgOverall.toFixed(1);
    document.getElementById('complete-rate').textContent = '100%';
  } else {
    document.getElementById('avg-overall').textContent = '0.0';
    document.getElementById('complete-rate').textContent = '0%';
  }
}

// Analysis functions
function performAnalysis() {
  if (surveyData.responses.length < 5) {
    showNotification('Warning', 'At least 5 responses are required for analysis.', 'warning');
    return;
  }
  
  const results = calculateAnalysis();
  displayAnalysisResults(results);
}

function calculateAnalysis() {
  const n = surveyData.responses.length;
  const results = {
    sampleSize: n,
    attributes: {},
    overallMean: 0
  };
  
  // Calculate overall mean
  results.overallMean = surveyData.responses.reduce((sum, r) => sum + r.overall, 0) / n;
  
  // Calculate for each attribute
  surveyData.attributes.forEach(attr => {
    const scores = surveyData.responses.map(r => r.attributes[attr.id]);
    const overallScores = surveyData.responses.map(r => r.overall);
    
    const mean = scores.reduce((sum, s) => sum + s, 0) / n;
    const correlation = calculatePearsonCorrelation(scores, overallScores);
    
    results.attributes[attr.id] = {
      name: attr.name,
      performance: mean,
      importance: Math.abs(correlation),
      correlation: correlation
    };
  });
  
  return results;
}

function calculatePearsonCorrelation(x, y) {
  const n = x.length;
  const sumX = x.reduce((sum, val) => sum + val, 0);
  const sumY = y.reduce((sum, val) => sum + val, 0);
  const sumXY = x.reduce((sum, val, i) => sum + val * y[i], 0);
  const sumX2 = x.reduce((sum, val) => sum + val * val, 0);
  const sumY2 = y.reduce((sum, val) => sum + val * val, 0);
  
  const numerator = n * sumXY - sumX * sumY;
  const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
  
  return denominator === 0 ? 0 : numerator / denominator;
}

function displayAnalysisResults(results) {
  const container = document.getElementById('analysis-results');
  
  // Calculate means for quadrants (not medians)
  const importanceValues = Object.values(results.attributes).map(a => a.importance);
  const performanceValues = Object.values(results.attributes).map(a => a.performance);
  const importanceMean = importanceValues.reduce((sum, val) => sum + val, 0) / importanceValues.length;
  const performanceMean = performanceValues.reduce((sum, val) => sum + val, 0) / performanceValues.length;
  
  // Get min and max for scaling
  const importanceMin = Math.min(...importanceValues);
  const importanceMax = Math.max(...importanceValues);
  const performanceMin = Math.min(...performanceValues);
  const performanceMax = Math.max(...performanceValues);
  
  // Categorize items based on mean values
  const quadrants = {
    keepUp: [],
    concentrate: [],
    lowPriority: [],
    overkill: []
  };
  
  Object.values(results.attributes).forEach(item => {
    if (item.importance >= importanceMean && item.performance >= performanceMean) {
      quadrants.keepUp.push(item);
    } else if (item.importance >= importanceMean && item.performance < performanceMean) {
      quadrants.concentrate.push(item);
    } else if (item.importance < importanceMean && item.performance >= performanceMean) {
      quadrants.overkill.push(item);
    } else {
      quadrants.lowPriority.push(item);
    }
  });
  
  const maxScale = surveyData.scaleType;
  
  // Calculate positions for mean lines
  const meanLineX = ((importanceMean - importanceMin) / (importanceMax - importanceMin)) * 90 + 5;
  const meanLineY = 95 - ((performanceMean - performanceMin) / (performanceMax - performanceMin)) * 90;
  
  let html = `
    <div style="background:white;border-radius:12px;padding:24px;">
      <h3 style="margin-bottom:24px;">üìä IPA Analysis Results</h3>
      
      <!-- Summary -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px;">
        <div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center;">
          <div style="font-size:24px;font-weight:600;color:var(--accent);">${results.sampleSize}</div>
          <div style="font-size:14px;color:var(--muted);">Total Responses</div>
        </div>
        <div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center;">
          <div style="font-size:24px;font-weight:600;color:var(--success);">${results.overallMean.toFixed(2)}</div>
          <div style="font-size:14px;color:var(--muted);">Average Overall Satisfaction</div>
        </div>
        <div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center;">
          <div style="font-size:24px;font-weight:600;color:var(--purple);">${performanceMean.toFixed(2)}</div>
          <div style="font-size:14px;color:var(--muted);">Performance Average</div>
        </div>
        <div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center;">
          <div style="font-size:24px;font-weight:600;color:var(--info);">${importanceMean.toFixed(3)}</div>
          <div style="font-size:14px;color:var(--muted);">Importance Average</div>
        </div>
      </div>
      
      <!-- IPA Matrix Visualization -->
      <div style="margin-bottom:32px;">
        <h4 style="margin-bottom:16px;">üéØ IPA Matrix</h4>
        <div class="ipa-matrix">
          <!-- Quadrant labels -->
          <div class="ipa-quadrant" style="top:10px;left:10px;color:#a16207;">III. Low Priority</div>
          <div class="ipa-quadrant" style="top:10px;right:10px;color:#166534;">I. Keep Up Good Work</div>
          <div class="ipa-quadrant" style="bottom:10px;left:10px;color:#7c3aed;">IV. Possible Overkill</div>
          <div class="ipa-quadrant" style="bottom:10px;right:10px;color:#dc2626;">II. Concentrate Here</div>
          
          <!-- Grid lines at mean values -->
          <div style="position:absolute;top:${meanLineY}%;left:0;width:100%;height:2px;background:#3b82f6;opacity:0.5;"></div>
          <div style="position:absolute;left:${meanLineX}%;top:0;width:2px;height:100%;background:#3b82f6;opacity:0.5;"></div>
          
          <!-- Axis labels with mean values -->
          <div style="position:absolute;bottom:-45px;left:50%;transform:translateX(-50%);font-size:12px;color:#64748b;text-align:center;">
            <strong>Importance</strong><br>
            Average: ${importanceMean.toFixed(3)}
          </div>
          <div style="position:absolute;left:-130px;top:50%;transform:translateY(-50%) rotate(-90deg);font-size:12px;color:#64748b;text-align:center;">
            <strong>Performance</strong><br>
            Average: ${performanceMean.toFixed(2)}
          </div>
          
          <!-- Min/Max labels -->
          <div style="position:absolute;bottom:-20px;left:5%;font-size:10px;color:#94a3b8;">
            ${importanceMin.toFixed(2)}
          </div>
          <div style="position:absolute;bottom:-20px;right:5%;font-size:10px;color:#94a3b8;">
            ${importanceMax.toFixed(2)}
          </div>
          <div style="position:absolute;left:-25px;bottom:5%;font-size:10px;color:#94a3b8;">
            ${performanceMin.toFixed(1)}
          </div>
          <div style="position:absolute;left:-25px;top:5%;font-size:10px;color:#94a3b8;">
            ${performanceMax.toFixed(1)}
          </div>
          
          <!-- Plot points -->
          ${Object.values(results.attributes).map((item, index) => {
            // Scale points based on actual min/max values
            const x = ((item.importance - importanceMin) / (importanceMax - importanceMin)) * 90 + 5;
            const y = 95 - ((item.performance - performanceMin) / (performanceMax - performanceMin)) * 90;
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            const color = colors[index % colors.length];
            
            return `
              <div class="ipa-point" style="left:${x}%;top:${y}%;background:${color};" 
                   title="${item.name}: Performance=${item.performance.toFixed(2)}, Importance=${item.importance.toFixed(3)}">
                ${index + 1}
              </div>
              <div class="ipa-point-label" style="left:${x}%;top:${y - 6}%;">
                ${item.name}
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <!-- Quadrant Analysis -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:32px;">
                  <div style="background:#fef3c7;border-radius:8px;padding:16px;">
          <h4 style="color:#a16207;margin-bottom:12px;">‚ö† III. Low Priority</h4>
          <div style="font-size:12px;color:#a16207;margin-bottom:8px;">Low Importance + Low Performance</div>
          ${quadrants.lowPriority.length > 0 ? 
            quadrants.lowPriority.map(item => `
              <div style="margin-bottom:8px;">‚Ä¢ ${item.name}<br>
                <span style="font-size:11px;color:#64748b;">Performance: ${item.performance.toFixed(2)}, Importance: ${item.importance.toFixed(3)}</span>
              </div>
            `).join('') :
            '<div style="color:#666;">No items in this category</div>'
          }
        </div>
        
        <div style="background:#dcfce7;border-radius:8px;padding:16px;">
          <h4 style="color:#166534;margin-bottom:12px;">‚úÖ I. Keep Up Good Work</h4>
          <div style="font-size:12px;color:#166534;margin-bottom:8px;">High Importance + High Performance</div>
          ${quadrants.keepUp.length > 0 ? 
            quadrants.keepUp.map(item => `
              <div style="margin-bottom:8px;">‚Ä¢ ${item.name}<br>
                <span style="font-size:11px;color:#64748b;">Performance: ${item.performance.toFixed(2)}, Importance: ${item.importance.toFixed(3)}</span>
              </div>
            `).join('') :
            '<div style="color:#666;">No items in this category</div>'
          }
        </div>
        
        <div style="background:#f3e8ff;border-radius:8px;padding:16px;">
          <h4 style="color:#7c3aed;margin-bottom:12px;">‚ö° IV. Possible Overkill</h4>
          <div style="font-size:12px;color:#7c3aed;margin-bottom:8px;">Low Importance + High Performance</div>
          ${quadrants.overkill.length > 0 ? 
            quadrants.overkill.map(item => `
              <div style="margin-bottom:8px;">‚Ä¢ ${item.name}<br>
                <span style="font-size:11px;color:#64748b;">Performance: ${item.performance.toFixed(2)}, Importance: ${item.importance.toFixed(3)}</span>
              </div>
            `).join('') :
            '<div style="color:#666;">No items in this category</div>'
          }
        </div>
        
        <div style="background:#fee2e2;border-radius:8px;padding:16px;">
          <h4 style="color:#dc2626;margin-bottom:12px;">üö® II. Concentrate Here</h4>
          <div style="font-size:12px;color:#dc2626;margin-bottom:8px;">High Importance + Low Performance</div>
          ${quadrants.concentrate.length > 0 ? 
            quadrants.concentrate.map(item => `
              <div style="margin-bottom:8px;">‚Ä¢ ${item.name}<br>
                <span style="font-size:11px;color:#64748b;">Performance: ${item.performance.toFixed(2)}, Importance: ${item.importance.toFixed(3)}</span>
              </div>
            `).join('') :
            '<div style="color:#666;">No items in this category</div>'
          }
        </div>
      </div>
      
      <!-- Detail Table -->
      <div>
        <h4 style="margin-bottom:16px;">üìã Detailed Analysis Results</h4>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Item</th>
              <th style="padding:12px;text-align:center;border:1px solid #e2e8f0;">Performance</th>
              <th style="padding:12px;text-align:center;border:1px solid #e2e8f0;">Importance</th>
              <th style="padding:12px;text-align:center;border:1px solid #e2e8f0;">Quadrant</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(results.attributes).sort((a, b) => b.importance - a.importance).map(item => {
              let quadrant = '';
              let quadrantColor = '';
              
              if (item.importance >= importanceMean && item.performance >= performanceMean) {
                quadrant = 'I. Keep Up Good Work';
                quadrantColor = '#dcfce7';
              } else if (item.importance >= importanceMean && item.performance < performanceMean) {
                quadrant = 'II. Concentrate Here';
                quadrantColor = '#fee2e2';
              } else if (item.importance < importanceMean && item.performance >= performanceMean) {
                quadrant = 'IV. Possible Overkill';
                quadrantColor = '#f3e8ff';
              } else {
                quadrant = 'III. Low Priority';
                quadrantColor = '#fef3c7';
              }
              
              return `
                <tr>
                  <td style="padding:12px;border:1px solid #e2e8f0;font-weight:500;">${item.name}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #e2e8f0;">${item.performance.toFixed(2)}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #e2e8f0;">${item.importance.toFixed(3)}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #e2e8f0;">
                    <span style="background:${quadrantColor};padding:4px 8px;border-radius:4px;font-size:12px;">${quadrant}</span>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
      
      <!-- Recommendations -->
      <div style="margin-top:32px;background:#e0f2fe;border-radius:8px;padding:20px;">
        <h4 style="color:#0369a1;margin-bottom:16px;">üí° Improvement Recommendations</h4>
        <ol style="padding-left:20px;line-height:1.8;">
          ${quadrants.concentrate.length > 0 ? 
            `<li><strong>Top Priority Improvement (Quadrant II):</strong> ${quadrants.concentrate.map(i => i.name).join(', ')}</li>` : ''
          }
          ${quadrants.keepUp.length > 0 ? 
            `<li><strong>Maintain Current Level (Quadrant I):</strong> ${quadrants.keepUp.map(i => i.name).join(', ')}</li>` : ''
          }
          ${quadrants.overkill.length > 0 ? 
            `<li><strong>Consider Resource Reallocation (Quadrant IV):</strong> ${quadrants.overkill.map(i => i.name).join(', ')}</li>` : ''
          }
          ${quadrants.lowPriority.length > 0 ? 
            `<li><strong>Low Priority (Quadrant III):</strong> ${quadrants.lowPriority.map(i => i.name).join(', ')}</li>` : ''
          }
          <li>Recommend re-surveying after 3 months to measure improvement effectiveness</li>
        </ol>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  showNotification('Analysis Complete', 'IPA analysis has been completed.', 'success');
}

// Helper function to calculate median
function median(values) {
  const sorted = [...values].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

// Export data
function exportData() {
  if (surveyData.responses.length === 0) {
    showNotification('Warning', 'No data to export.', 'warning');
    return;
  }
  
  let csv = 'ResponseID,RespondentID,Timestamp,OverallSatisfaction';
  
  surveyData.attributes.forEach(attr => {
    csv += `,${attr.name.replace(/,/g, ';')}`;
  });
  csv += '\n';
  
  surveyData.responses.forEach((response, index) => {
    csv += `${index + 1},${response.respondentId},${response.timestamp},${response.overall}`;
    surveyData.attributes.forEach(attr => {
      csv += `,${response.attributes[attr.id]}`;
    });
    csv += '\n';
  });
  
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `ipa_data_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showNotification('Export Complete', 'CSV file has been downloaded.', 'success');
}

// Save and Load functions
function saveToLocal() {
  // Update survey data from form fields
  surveyData.title = document.getElementById('survey-title').value;
  surveyData.description = document.getElementById('survey-description').value;
  surveyData.instructions = document.getElementById('survey-instructions').value;
  surveyData.overallQuestion = document.getElementById('overall-question').value;
  
  saveToLocalStorage();
  
  // Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ ÏòµÏÖò Ï∂îÍ∞Ä
  const goBack = confirm('Survey saved! Return to dashboard?');
  if (goBack) {
    window.location.href = './mypage.html';
  } else {
    showNotification('Save Complete', 'Data has been saved to browser storage.', 'success');
  }
}
function loadFromLocal() {
  if (confirm('Load saved data? Current data will be overwritten.')) {
    loadFromLocalStorage();
    renderAttributes();
    updateStats();
    showNotification('Load Complete', 'Saved data has been loaded.', 'success');
  }
}

function saveToLocalStorage() {
  localStorage.setItem('ipaSurveyData', JSON.stringify(surveyData));
}

function loadFromLocalStorage() {
  const saved = localStorage.getItem('ipaSurveyData');
  if (saved) {
    surveyData = JSON.parse(saved);
    document.getElementById('survey-title').value = surveyData.title || '';
    document.getElementById('survey-description').value = surveyData.description || '';
    document.getElementById('survey-instructions').value = surveyData.instructions || '';
    document.getElementById('overall-question').value = surveyData.overallQuestion || '';
    renderAttributes();
  }
}

// Notification system
function showNotification(title, message, type = 'info') {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  const colors = {
    success: '#10b981',
    warning: '#f59e0b',
    error: '#ef4444',
    info: '#3b82f6'
  };
  
  notification.style.borderLeftColor = colors[type] || colors.info;
  
  notification.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:600;margin-bottom:4px;">${title}</div>
        <div style="font-size:14px;color:var(--muted);">${message}</div>
      </div>
      <span class="notification-close" onclick="this.parentElement.parentElement.remove()">‚úï</span>
    </div>
  `;
  
  container.appendChild(notification);
  setTimeout(() => notification.classList.add('show'), 10);
  
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// Preview survey
function previewSurvey() {
  if (surveyData.attributes.length === 0) {
    showNotification('Warning', 'At least 1 item is required for preview.', 'warning');
    return;
  }
  
  const modal = document.getElementById('preview-modal');
  const content = document.getElementById('preview-content');
  
  const maxScale = surveyData.scaleType;
  const scalePoints = Array.from({length: maxScale}, (_, i) => i + 1);
  
  // Update survey data from form
  surveyData.title = document.getElementById('survey-title').value;
  surveyData.description = document.getElementById('survey-description').value;
  surveyData.overallQuestion = document.getElementById('overall-question').value;
  
  let html = `
    <div class="preview-container">
      <div class="preview-title">${surveyData.title}</div>
      <div class="preview-description">${surveyData.description}</div>
      
      <div style="margin-bottom:20px;padding:12px;background:#f0f9ff;border-radius:8px;">
        <div style="font-size:13px;color:#0369a1;">
          <strong>Rating Scale:</strong> 1 point (Very Dissatisfied) ~ ${maxScale} points (Very Satisfied)
        </div>
      </div>
      
      ${surveyData.attributes.map((attr, index) => `
        <div class="preview-question">
          <div class="preview-question-title">${index + 1}. ${attr.name}</div>
          <div class="preview-scale">
            ${scalePoints.map(val => `
              <div class="preview-scale-item">
                <input type="radio" name="preview-${attr.id}" class="preview-scale-radio" disabled>
                <div class="preview-scale-label">
                  ${val}<br>
                  ${maxScale === 5 ? 
                    (val === 1 ? 'Very<br>Dissatisfied' : val === 3 ? 'Neutral' : val === 5 ? 'Very<br>Satisfied' : '') :
                    (val === 1 ? 'Very<br>Dissatisfied' : val === 4 ? 'Neutral' : val === 7 ? 'Very<br>Satisfied' : '')
                  }
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('')}
      
      <div class="preview-question" style="background:linear-gradient(135deg,#fef3c7,#fed7aa);border:2px solid var(--warning);">
        <div class="preview-question-title" style="color:#92400e;">
          <span style="font-size:20px;margin-right:8px;">‚≠ê</span>
          ${surveyData.overallQuestion}
        </div>
        <div class="preview-scale">
          ${scalePoints.map(val => `
            <div class="preview-scale-item">
              <input type="radio" name="preview-overall" class="preview-scale-radio" disabled>
              <div class="preview-scale-label">
                ${val}<br>
                ${maxScale === 5 ? 
                  (val === 1 ? 'Very<br>Dissatisfied' : val === 3 ? 'Neutral' : val === 5 ? 'Very<br>Satisfied' : '') :
                  (val === 1 ? 'Very<br>Dissatisfied' : val === 4 ? 'Neutral' : val === 7 ? 'Very<br>Satisfied' : '')
                }
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div style="text-align:center;margin-top:24px;">
        <button class="btn success large" style="opacity:0.5;cursor:not-allowed;" disabled>
          Submit
        </button>
      </div>
      
      <div style="margin-top:20px;padding:16px;background:#f0fdf4;border-radius:8px;border:1px solid #86efac;">
        <div style="font-size:13px;color:#166534;">
          <strong>üìä Survey Information</strong><br>
          ‚Ä¢ Total questions: ${surveyData.attributes.length + 1} (Individual ${surveyData.attributes.length} + Overall satisfaction 1)<br>
          ‚Ä¢ Scale type: ${maxScale}-point scale<br>
          ‚Ä¢ Estimated time: About ${Math.ceil((surveyData.attributes.length + 1) * 0.5)} minutes
        </div>
      </div>
    </div>
  `;
  
  content.innerHTML = html;
  modal.style.display = 'block';
}

function closePreview() {
  document.getElementById('preview-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('preview-modal');
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}

// Make preview functions globally accessible
window.previewSurvey = previewSurvey;
window.closePreview = closePreview;

// Make functions globally accessible for onclick handlers
window.switchTab = switchTab;
window.addAttribute = addAttribute;
window.setScale = setScale;
window.selectRating = selectRating;
window.submitResponse = submitResponse;
window.clearAllResponses = clearAllResponses;
window.generateSampleData = generateSampleData;
window.loadSampleSurvey = loadSampleSurvey;
window.performAnalysis = performAnalysis;
window.exportData = exportData;
window.saveToLocal = saveToLocal;
window.loadFromLocal = loadFromLocal;
window.previewSurvey = previewSurvey;
window.closePreview = closePreview;
</script>

</body>
</html>
