<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>📊 Analytics Platform - Normality Test</title>

<!-- CSV Parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --accent:#3b82f6; --success:#10b981;
    --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6; --info:#06b6d4;
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1);
    --gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  }
  
  * {box-sizing:border-box;margin:0;padding:0;}
  
  body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#1e293b;line-height:1.6;margin:0;padding:0}
  
  /* Header Navigation */
  .header{background:white;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
  .header-content{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px}
  .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
  .logo-icon{width:40px;height:40px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
  
  /* Navigation with Dropdown */
  .nav-tabs{display:flex;gap:4px;background:#f1f5f9;padding:4px;border-radius:12px;}
  .nav-item{position:relative;}
  .nav-tab{padding:8px 16px;border-radius:8px;border:none;background:transparent;cursor:pointer;font-weight:500;color:#64748b;transition:all 0.2s;white-space:nowrap;font-size:14px;display:flex;align-items:center;gap:4px;}
  .nav-tab:hover{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  .nav-tab.active{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  .dropdown{position:absolute;top:100%;left:50%;transform:translateX(-50%);background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);padding:8px;min-width:200px;opacity:0;visibility:hidden;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none;z-index:1000;}
  .dropdown.active{opacity:1;visibility:visible;pointer-events:all;}
  .nav-item:hover .dropdown{opacity:1;visibility:visible;pointer-events:all;}
  .dropdown-item{padding:10px 16px;border-radius:8px;cursor:pointer;transition:all 0.2s;font-size:13px;color:#475569;display:block;}
  .dropdown-item:hover{background:#f8fafc;color:#1e293b;transform:translateX(4px);}

  .relationship .dropdown-item:hover{background:linear-gradient(to right,#3b82f615,#06b6d415);color:#3b82f6}
  .difference .dropdown-item:hover{background:linear-gradient(to right,#8b5cf615,#a855f715);color:#8b5cf6}
  .assumption .dropdown-item:hover{background:linear-gradient(to right,#10b98115,#05966915);color:#10b981}
  .multivariate .dropdown-item:hover{background:linear-gradient(to right,#f59e0b15,#f9731615);color:#f59e0b}
  .specialized .dropdown-item:hover{background:linear-gradient(to right,#ef444415,#f8717115);color:#ef4444}
  
  .header-actions{display:flex;gap:12px;align-items:center}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
  
  /* Main Container */
  .main-container{max-width:1400px;margin:0 auto;padding:24px}
  .content-area{display:none}
  .content-area.active{display:block}
  
  /* Panel Styles */
  .main{max-width:100%;margin:auto;display:flex;flex-direction:column;gap:16px}
  .panel{background:var(--card);border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:16px}
  h1{margin:0;font-size:24px;color:#1e293b;font-weight:700}
  h2{margin:20px 0 12px 0;font-size:18px;color:var(--accent);font-weight:600}
  h3{margin:16px 0 12px 0;font-size:16px;color:#374151;font-weight:600}
  h4{margin:12px 0 8px 0;font-size:14px;color:var(--accent);font-weight:600}
  
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.success{background:var(--success);color:#fff}
  .btn.ghost{background:#f1f5f9;color:#475569}
  .btn.warning{background:var(--warning);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.small{padding:6px 12px;font-size:13px}
  .btn.icon{padding:8px;width:36px;height:36px;justify-content:center}

  /* Table with Scrollbar */
  .table-container{
    overflow-x:auto;
    overflow-y:auto;
    max-height:400px;
    border-radius:8px;
    border:1px solid #e2e8f0;
    margin-top:12px;
  }
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px;}
  th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:center}
  th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:1}
  tr:hover{background:#f8fafc}
  
  .muted{color:var(--muted);font-size:13px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px}
  
  /* Model Cards */
  .model-card {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    background: white;
  }
  .model-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  .model-card.selected {
    border-color: var(--accent);
    background: #f0f9ff;
  }
  .model-card h4 {
    margin: 0 0 12px 0;
    color: var(--accent);
    font-size: 18px;
  }
  .model-card .desc {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.5;
  }
  
  /* Enhanced Forms */
  select,input[type="text"],input[type="number"],input[type="checkbox"]{
    padding:8px 12px;
    border:2px solid #e2e8f0;
    border-radius:8px;
    font-size:14px;
    background:white;
    cursor:pointer;
  }
  select:focus,input[type="text"]:focus,input[type="number"]:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
  }
  
  .hypothesis-box{
    background:#f8fafc;border-left:4px solid var(--accent);padding:16px;margin:16px 0;
    border-radius:0 8px 8px 0;
  }
  .interpretation-box{
    background:#f0fdf4;border-left:4px solid var(--success);padding:20px;margin:20px 0;
    border-radius:0 8px 8px 0;
  }
  .interpretation-box.warning{
    background:#fef3c7;border-left-color:var(--warning);
  }
  .interpretation-box.info{
    background:#f0f9ff;border-left-color:var(--info);
  }
  .interpretation-box.reject{
    background:#fef2f2;border-left-color:var(--danger);
  }
  .interpretation-box.accept{
    background:#f0fdf4;border-left-color:var(--success);
  }
  
  .normality-indicator{
    display:inline-block;padding:4px 8px;border-radius:6px;font-weight:600;
    color:white;margin-left:8px;
  }
  .normal{background:var(--success);}
  .non-normal{background:var(--danger);}
  
  .assumption-check{
    background:#fffbeb;border:1px solid #fed7aa;padding:20px;border-radius:12px;margin:16px 0;
  }
  
  .sig{color:var(--success);font-weight:700;}
  .nsig{color:var(--danger);font-weight:700;}
  
  .plot-container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
    margin-top:20px;
  }
  .plot-full{
    grid-column:1/-1;
  }
  .plot-item{
    height:350px;
    width:100%;
    border-radius:8px;
    border:1px solid #e2e8f0;
    overflow:hidden;
  }
  
  .stat-card{
    background:#f8fafc;padding:16px;border-radius:8px;text-align:center;border:1px solid #e2e8f0;
  }
  .stat-card .value{font-size:18px;font-weight:700;color:var(--accent);}
  .stat-card .label{font-size:12px;color:var(--muted);margin-top:4px;}
  
  .test-result-row{
    background:#f9fafb;
  }
  .test-result-row.significant{
    background:#fef2f2;
  }
  .test-result-row.not-significant{
    background:#f0fdf4;
  }
  
  .variable-selection{
    background:#f8fafc;
    padding:16px;
    border-radius:8px;
    border:1px solid #e2e8f0;
    margin:12px 0;
  }
  
  .var-checkbox-container{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:12px;
  }
  
  .var-checkbox-item{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    background:white;
    border:1px solid #e2e8f0;
    border-radius:6px;
    cursor:pointer;
    transition:all 0.2s;
  }
  
  .var-checkbox-item:hover{
    border-color:var(--accent);
    background:#f0f9ff;
  }
  
  .var-checkbox-item input[type="checkbox"]{
    margin:0;
    padding:0;
    width:16px;
    height:16px;
  }
  
  @media (max-width: 768px) {
    .header-content{padding:0 16px}
    .nav-tabs{display:none}
    .main-container{padding:16px}
    .grid-2, .grid-3, .grid-4 {
      grid-template-columns: 1fr;
    }
    .plot-container{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<!-- Header Navigation -->
<div class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">📊</div>
      <span>Skari</span>
    </div>

    <div class="nav-tabs">
      <!-- 1. Descriptive Statistics -->
      <div class="nav-item descriptives">
        <button class="nav-tab" onclick="selectAnalysis('descriptive.html')">📊 Descriptive</button>
      </div>
    
      <div class="nav-item assumption">
        <button class="nav-tab active">🔍 Assumption Check <span style="font-size:10px">▼</span></button>
        <div class="dropdown">
          <div class="dropdown-item" onclick="selectAnalysis('normality.html')">Normality Test</div>
          <div class="dropdown-item" onclick="selectAnalysis('homogeneity.html')">Homogeneity Test</div>
        </div>
      </div>
    
      <!-- 2. Difference Tests -->
      <div class="nav-item difference">
        <button class="nav-tab">⚖️ Difference Tests <span style="font-size:10px">▼</span></button>
        <div class="dropdown">
          <div class="dropdown-item" onclick="selectAnalysis('t_test.html')">t-Test</div>
          <div class="dropdown-item" onclick="selectAnalysis('anova.html')">ANOVA</div>
          <div class="dropdown-item" onclick="selectAnalysis('chi_square.html')">Chi-square Test</div>
          <div class="dropdown-item" onclick="selectAnalysis('nonparametric.html')">Nonparametric Tests</div>
        </div>
      </div>
    
      <!-- 3. Relationship Analysis -->
      <div class="nav-item relationship">
        <button class="nav-tab">📈 Relationship <span style="font-size:10px">▼</span></button>
        <div class="dropdown">
          <div class="dropdown-item" onclick="selectAnalysis('correlation.html')">Correlation Analysis</div>
          <div class="dropdown-item" onclick="selectAnalysis('regression.html')">Regression Analysis</div>
        </div>
      </div>
    
      <!-- 4. Multivariate Analysis -->
      <div class="nav-item multivariate">
        <button class="nav-tab">🎯 Multivariate <span style="font-size:10px">▼</span></button>
        <div class="dropdown">
          <div class="dropdown-item" onclick="selectAnalysis('EFA.html')">EFA</div>
          <div class="dropdown-item" onclick="selectAnalysis('CFA.html')">CFA</div>
          <div class="dropdown-item" onclick="selectAnalysis('cluster.html')">Cluster Analysis</div>
          <div class="dropdown-item" onclick="selectAnalysis('discriminant.html')">Discriminant Analysis</div>
          <div class="dropdown-item" onclick="selectAnalysis('pca.html')">PCA</div>
          <div class="dropdown-item" onclick="selectAnalysis('mds.html')">MDS</div>
          <div class="dropdown-item" onclick="selectAnalysis('correspondence.html')">Correspondence Analysis</div>
        </div>
      </div>
    
      <!-- 6. Specialized Analyses -->
      <div class="nav-item specialized">
        <button class="nav-tab">🔬 Specialized <span style="font-size:10px">▼</span></button>
        <div class="dropdown">
          <div class="dropdown-item" onclick="selectAnalysis('survival.html')">Survival Analysis</div>
          <div class="dropdown-item" onclick="selectAnalysis('timeseries.html')">Time Series Analysis (ARIMA, etc.)</div>
        </div>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="btn ghost icon" onclick="showNotifications()">🔔</button>
      <button class="btn ghost icon" onclick="showSettings()">⚙️</button>
      <button class="btn primary small" onclick="exportToPDF()">📄 Export PDF</button>
      <div class="user-avatar">AD</div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">
  <!-- Normality Test Tab -->
  <div id="normality-tab" class="content-area active">
    <div class="main">
      <div class="panel">
        <h1>📈 Normality Test</h1>
        <div class="muted">Upload CSV → Select Test Types → Choose Variables → Set Significance Level → Run Analysis</div>
      </div>

      <div class="panel">
        <div class="controls">
          <input id="fileInput" type="file" accept=".csv" style="padding:8px;">
          <button class="btn success" onclick="loadExample()">📊 Load Sample Data</button>
          <button class="btn ghost" onclick="resetAll()">🔄 Reset</button>
          <button class="btn ghost" onclick="showHelp()">❓ Help</button>
        </div>
        <div id="dataPreview"></div>
      </div>

      <div class="panel" id="testTypePanel" style="display:none;">
        <h2>⚙️ Normality Test Selection</h2>
        <div class="grid-4">
          <div class="model-card" onclick="selectTest('shapiro')" id="card-shapiro">
            <h4>🔍 Shapiro-Wilk</h4>
            <div class="desc">• Most powerful test<br>• Sample size < 5000<br>• Widely recommended</div>
          </div>
          <div class="model-card" onclick="selectTest('jarque-bera')" id="card-jarque-bera">
            <h4>📊 Jarque-Bera</h4>
            <div class="desc">• Tests skewness & kurtosis<br>• Large sample sizes<br>• Asymptotic test</div>
          </div>
          <div class="model-card" onclick="selectTest('anderson')" id="card-anderson">
            <h4>🔍 Anderson-Darling</h4>
            <div class="desc">• Sensitive to tails<br>• All sample sizes<br>• More stringent test</div>
          </div>
          <div class="model-card" onclick="selectTest('ks')" id="card-ks">
            <h4>📉 Kolmogorov-Smirnov</h4>
            <div class="desc">• Distribution-free approach<br>• Conservative test<br>• Classic method</div>
          </div>
          <div class="model-card" onclick="selectTest('dagostino')" id="card-dagostino">
            <h4>🎯 D'Agostino-Pearson</h4>
            <div class="desc">• Omnibus test approach<br>• Skewness & kurtosis<br>• Good statistical power</div>
          </div>
          <div class="model-card" onclick="selectTest('lilliefors')" id="card-lilliefors">
            <h4>📋 Lilliefors</h4>
            <div class="desc">• Modified K-S test<br>• Unknown parameters<br>• Better for normality</div>
          </div>
          <div class="model-card" onclick="selectTest('all')" id="card-all">
            <h4>🔬 Comprehensive Suite</h4>
            <div class="desc">• All tests included<br>• Compare results<br>• Best practice approach</div>
          </div>
        </div>
      </div>

      <div class="panel" id="varPanel" style="display:none;">
        <h2>🎛️ Analysis Configuration</h2>
        
        <div class="variable-selection">
          <h3>Select Variables for Testing</h3>
          <div id="variableCheckboxes" class="var-checkbox-container"></div>
        </div>
        
        <!-- Analysis Options -->
        <div style="margin-top:20px;">
          <div>
            <div style="margin-bottom:4px;font-weight:500;">Significance Level (α)</div>
            <select id="alphaLevel">
              <option value="0.05">0.05 (5%)</option>
              <option value="0.01">0.01 (1%)</option>
              <option value="0.10">0.10 (10%)</option>
            </select>
          </div>
        </div>

        <div class="controls" style="margin-top:24px;">
          <button class="btn primary" onclick="runNormalityTest()">🚀 Run Analysis</button>
          <button class="btn ghost" onclick="saveConfiguration()">💾 Save Config</button>
        </div>
      </div>

      <div class="panel" id="resultsPanel" style="display:none;">
        <h2>📈 Normality Test Results</h2>
        
        <!-- Hypothesis Setup -->
        <div id="hypothesisSection"></div>
        
        <!-- Descriptive Statistics -->
        <div id="descriptiveStats"></div>
        
        <!-- Test Results -->
        <div id="testResults"></div>
        
        <!-- Visualization Section -->
        <div id="visualizationSection" style="display:none;">
          <h3>Visualizations</h3>
          <div id="vizTabs" class="nav-tabs" style="margin-bottom:20px;"></div>
          <div class="plot-container">
            <div id="histogramPlot" class="plot-item"></div>
            <div id="qqPlot" class="plot-item"></div>
            <div id="boxPlot" class="plot-item"></div>
            <div id="ppPlot" class="plot-item"></div>
          </div>
        </div>
        
        <!-- Transformation Results (if applicable) -->
        <div id="transformationSection"></div>
        
        <!-- Result Interpretation -->
        <div id="interpretationSection"></div>
        
        <!-- Recommendations -->
        <div id="recommendationSection"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables
var currentData = null;
var selectedTestType = null;
var selectedVariables = [];
var currentNormalityVariable = null;

// Gaussian random number generator (Box-Muller)
function gaussianRandom() {
  var u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function loadExample() {
  var n = 100;
  var data = [];
  
  // Generate different distributions
  for (var i = 0; i < n; i++) {
    var row = {};
    
    // Normal distribution
    row.normal = gaussianRandom() * 15 + 100;
    
    // Skewed distribution (log-normal)
    row.skewed = Math.exp(gaussianRandom() * 0.5 + 3);
    
    // Heavy-tailed distribution
    row.heavy_tailed = gaussianRandom() * (Math.random() > 0.9 ? 5 : 1) * 10 + 50;
    
    // Uniform distribution
    row.uniform = Math.random() * 100;
    
    // Bimodal distribution
    row.bimodal = Math.random() > 0.5 ? 
      gaussianRandom() * 5 + 30 : 
      gaussianRandom() * 5 + 70;
    
    // Exponential-like
    row.exponential = -Math.log(1 - Math.random()) * 20;
    
    data.push(row);
  }
  
  processData(data);
}

function processData(data) {
  if (!data || data.length === 0) {
    console.error('No data provided');
    return;
  }
  
  currentData = data;
  var headers = Object.keys(data[0]);
  
  var preview = '<h3>📋 Data Preview</h3>';
  preview += '<div class="table-container">';
  preview += '<table><thead><tr>';
  headers.forEach(function(h) { preview += '<th>' + h + '</th>'; });
  preview += '</tr></thead><tbody>';
  
  data.slice(0, 10).forEach(function(r) {
    preview += '<tr>';
    headers.forEach(function(h) { 
      var value = typeof r[h] === 'number' ? r[h].toFixed(2) : r[h];
      preview += '<td>' + value + '</td>'; 
    });
    preview += '</tr>';
  });
  
  preview += '</tbody></table></div>';
  preview += '<div class="muted" style="margin-top:12px;">📊 Rows: ' + data.length + ' | 🔢 Columns: ' + headers.length + '</div>';
  
  document.getElementById('dataPreview').innerHTML = preview;
  document.getElementById('testTypePanel').style.display = 'block';
}

// Test Selection
function selectTest(testType) {
  selectedTestType = testType;
  
  // Update UI
  document.querySelectorAll('.model-card').forEach(function(card) {
    card.classList.remove('selected');
  });
  document.getElementById('card-' + testType).classList.add('selected');
  
  updateVarUI();
  document.getElementById('varPanel').style.display = 'block';
}

// Variable UI Update
function updateVarUI() {
  if (!currentData) return;
  
  var headers = Object.keys(currentData[0]);
  var numericHeaders = headers.filter(function(h) {
    var values = currentData.map(function(d) { return d[h]; }).filter(function(v) { return v !== null && v !== ''; });
    return values.length > 0 && values.every(function(v) { return !isNaN(parseFloat(v)); });
  });
  
  var html = '';
  numericHeaders.forEach(function(h) {
    html += '<div class="var-checkbox-item">' +
      '<input type="checkbox" class="var-checkbox" value="' + h + '" checked>' +
      '<span>' + h + '</span>' +
      '</div>';
  });
  
  document.getElementById('variableCheckboxes').innerHTML = html;
}

// Statistical Functions
function mean(arr) {
  return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
}

function variance(arr) {
  var m = mean(arr);
  return arr.reduce(function(sum, x) { return sum + Math.pow(x - m, 2); }, 0) / (arr.length - 1);
}

function std(arr) {
  return Math.sqrt(variance(arr));
}

function median(arr) {
  var sorted = arr.slice().sort(function(a, b) { return a - b; });
  var mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

function skewness(arr) {
  var n = arr.length;
  var m = mean(arr);
  var s = std(arr);
  var sum = arr.reduce(function(acc, x) { return acc + Math.pow((x - m) / s, 3); }, 0);
  return (n * sum) / ((n - 1) * (n - 2));
}

function kurtosis(arr) {
  var n = arr.length;
  var m = mean(arr);
  var s = std(arr);
  var sum = arr.reduce(function(acc, x) { return acc + Math.pow((x - m) / s, 4); }, 0);
  return ((n * (n + 1) * sum) / ((n - 1) * (n - 2) * (n - 3))) - 
         (3 * (n - 1) * (n - 1)) / ((n - 2) * (n - 3));
}

// Error function
function erf(x) {
  var sign = x >= 0 ? 1 : -1;
  x = Math.abs(x);
  var a1 =  0.254829592;
  var a2 = -0.284496736;
  var a3 =  1.421413741;
  var a4 = -1.453152027;
  var a5 =  1.061405429;
  var p  =  0.3275911;
  var t = 1.0 / (1.0 + p * x);
  var y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
  return sign * y;
}

// Normal CDF
function normalCDF(x) {
  return 0.5 * (1 + erf(x / Math.sqrt(2)));
}

// Log Gamma function
function logGamma(z) {
  if (z < 0.5) {
    return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
  }
  z -= 1;
  var x = 0.99999999999999709182;
  var cof = [57.156235665862923517, -59.597960355475491248, 14.136097974741747174];
  for (var i = 0; i < cof.length; i++) {
    x += cof[i] / (z + i + 1);
  }
  var t = z + cof.length - 0.5;
  return Math.log(Math.sqrt(2 * Math.PI)) + (z + 0.5) * Math.log(t) - t + Math.log(x);
}

// Gamma CDF (simplified)
function gammaCDF(x, a) {
  if (x <= 0) return 0;
  
  var sum = 0;
  var term = 1 / a;
  
  for (var n = 1; n < 100; n++) {
    sum += term;
    term *= x / (a + n);
    if (term < 1e-10) break;
  }
  
  return sum * Math.exp(-x + a * Math.log(x) - logGamma(a));
}

// Chi-square CDF
function chiSquareCDF(x, df) {
  if (x <= 0) return 0;
  return gammaCDF(x / 2, df / 2);
}

// Normal quantile function (inverse CDF)
function quantileNormal(p) {
  // Rational approximation
  var a = [2.515517, 0.802853, 0.010328];
  var b = [1.432788, 0.189269, 0.001308];
  
  var q = p < 0.5 ? p : 1 - p;
  var t = Math.sqrt(-2 * Math.log(q));
  
  var z = t - (a[0] + a[1] * t + a[2] * t * t) / 
              (1 + b[0] * t + b[1] * t * t + b[2] * t * t * t);
  
  return p < 0.5 ? -z : z;
}

// Shapiro-Wilk Test
function shapiroWilk(data) {
  var n = data.length;
  if (n < 3 || n > 5000) {
    return { W: null, p: null, error: 'Sample size must be between 3 and 5000' };
  }
  
  var sorted = data.slice().sort(function(a, b) { return a - b; });
  var m = mean(sorted);
  
  // Calculate a coefficients (simplified but more accurate)
  var a = [];
  for (var i = 0; i < Math.floor(n / 2); i++) {
    var ai = 2 * (i + 1) - n - 1;
    a.push(ai / Math.sqrt(n * (n - 1)));
  }
  
  // Calculate W statistic
  var numerator = 0;
  for (var i = 0; i < Math.floor(n / 2); i++) {
    numerator += a[i] * (sorted[n - 1 - i] - sorted[i]);
  }
  numerator = numerator * numerator;
  
  var denominator = sorted.reduce(function(sum, x) { return sum + Math.pow(x - m, 2); }, 0);
  
  var W = numerator / denominator;
  
  // Better p-value approximation
  var z = Math.log(1 - W);
  var mu = -1.2725 * Math.log(n) - 1.0521;
  var sigma = 0.0223 * Math.sqrt(n) + 0.459;
  
  var standardizedZ = (z - mu) / sigma;
  var p = 1 - normalCDF(standardizedZ);
  
  return { W: W, p: Math.max(0, Math.min(1, p)) };
}

// Jarque-Bera Test
function jarqueBera(data) {
  var n = data.length;
  var s = skewness(data);
  var k = kurtosis(data);
  
  var JB = (n / 6) * (s * s + (k * k) / 4);
  var p = 1 - chiSquareCDF(JB, 2);
  
  return { JB: JB, p: p, skewness: s, kurtosis: k };
}

// Kolmogorov-Smirnov Test
function kolmogorovSmirnov(data) {
  var n = data.length;
  var sorted = data.slice().sort(function(a, b) { return a - b; });
  var m = mean(sorted);
  var s = std(sorted);
  
  // Standardize data
  var standardized = sorted.map(function(x) { return (x - m) / s; });
  
  // Calculate D statistic
  var D = 0;
  for (var i = 0; i < n; i++) {
    var empirical = (i + 1) / n;
    var theoretical = normalCDF(standardized[i]);
    D = Math.max(D, Math.abs(empirical - theoretical));
  }
  
  // Approximate p-value
  var sqrtN = Math.sqrt(n);
  var lambda = (sqrtN + 0.12 + 0.11 / sqrtN) * D;
  var p = 0;
  
  for (var k = 1; k <= 100; k++) {
    p += 2 * Math.pow(-1, k - 1) * Math.exp(-2 * k * k * lambda * lambda);
  }
  
  return { D: D, p: Math.max(0, Math.min(1, 1 - p)) };
}

// Anderson-Darling Test
function andersonDarling(data) {
  var n = data.length;
  var sorted = data.slice().sort(function(a, b) { return a - b; });
  var m = mean(sorted);
  var s = std(sorted);
  
  var standardized = sorted.map(function(x) { return (x - m) / s; });
  
  var S = 0;
  for (var i = 0; i < n; i++) {
    var Fi = normalCDF(standardized[i]);
    var Fni = normalCDF(standardized[n - 1 - i]);
    if (Fi > 0 && Fi < 1 && Fni > 0 && Fni < 1) {
      S += (2 * (i + 1) - 1) * (Math.log(Fi) + Math.log(1 - Fni));
    }
  }
  
  var A2 = -n - S / n;
  var A2star = A2 * (1 + 0.75 / n + 2.25 / (n * n));
  
  var p;
  if (A2star < 0.2) {
    p = 1 - Math.exp(-13.436 + 101.14 * A2star - 223.73 * A2star * A2star);
  } else if (A2star < 0.34) {
    p = 1 - Math.exp(-8.318 + 42.796 * A2star - 59.938 * A2star * A2star);
  } else if (A2star < 0.6) {
    p = Math.exp(0.9177 - 4.279 * A2star - 1.38 * A2star * A2star);
  } else {
    p = Math.exp(1.2937 - 5.709 * A2star + 0.0186 * A2star * A2star);
  }
  
  return { A2: A2, p: Math.max(0, Math.min(1, p)) };
}

// D'Agostino-Pearson Test
function dagostinoPearson(data) {
  var n = data.length;
  var s = skewness(data);
  var k = kurtosis(data);
  
  // Transform to z-scores (simplified)
  var zs = s * Math.sqrt(n / 6);
  var zk = k * Math.sqrt(n / 24);
  
  var K2 = zs * zs + zk * zk;
  var p = 1 - chiSquareCDF(K2, 2);
  
  return { K2: K2, p: p, zs: zs, zk: zk };
}

// Lilliefors Test
function lilliefors(data) {
  var n = data.length;
  var sorted = data.slice().sort(function(a, b) { return a - b; });
  var m = mean(sorted);
  var s = std(sorted);
  
  var standardized = sorted.map(function(x) { return (x - m) / s; });
  
  var D = 0;
  for (var i = 0; i < n; i++) {
    var empirical = (i + 1) / n;
    var theoretical = normalCDF(standardized[i]);
    D = Math.max(D, Math.abs(empirical - theoretical));
  }
  
  var sqrtN = Math.sqrt(n);
  var lambda = (sqrtN + 0.15 + 0.08 / sqrtN) * D;
  var p = 0;
  
  for (var k = 1; k <= 100; k++) {
    p += 2 * Math.pow(-1, k - 1) * Math.exp(-2 * k * k * lambda * lambda);
  }
  
  return { D: D, p: Math.max(0, Math.min(1, 1 - p * 1.2)) };
}

// Q-Q Plot Data Generation
function generateQQData(data) {
  var n = data.length;
  var sorted = data.slice().sort(function(a, b) { return a - b; });
  var m = mean(sorted);
  var s = std(sorted);
  
  var theoretical = [];
  var empirical = [];
  
  for (var i = 0; i < n; i++) {
    var p = (i + 0.5) / n;
    var z = quantileNormal(p);
    theoretical.push(z * s + m);
    empirical.push(sorted[i]);
  }
  
  return { theoretical: theoretical, empirical: empirical };
}

// Create Visualizations with Tabbed Interface
function createNormalityPlots(allStats) {
  if (selectedVariables.length === 0) return;
  
  document.querySelector('#visualizationSection').style.display = 'block';
  
  var tabsHtml = '';
  selectedVariables.forEach(function(variable, index) {
    var isActive = index === 0 ? 'active' : '';
    tabsHtml += '<button class="nav-tab viz-tab ' + isActive + '" onclick="switchNormalityTab(\'' + variable + '\')">📊 ' + variable + '</button>';
  });
  
  document.getElementById('vizTabs').innerHTML = tabsHtml;
  
  if (selectedVariables.length > 0) {
    currentNormalityVariable = selectedVariables[0];
    updateNormalityVisualization(selectedVariables[0], allStats);
  }
}

function switchNormalityTab(variable) {
  document.querySelectorAll('.viz-tab').forEach(function(tab) {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  currentNormalityVariable = variable;
  
  var allStats = {};
  selectedVariables.forEach(function(varName) {
    var values = currentData.map(function(d) { return parseFloat(d[varName]); }).filter(function(v) { return !isNaN(v); });
    var stats = {
      n: values.length,
      mean: mean(values),
      median: median(values),
      std: std(values),
      skewness: skewness(values),
      kurtosis: kurtosis(values),
      min: Math.min.apply(Math, values),
      max: Math.max.apply(Math, values)
    };
    allStats[varName] = { values: values, stats: stats };
  });
  
  updateNormalityVisualization(variable, allStats);
}

function updateNormalityVisualization(variable, allStats) {
  var data = allStats[variable].values;
  var stats = allStats[variable].stats;
  
  // 1. Histogram with normal curve
  var histData = [{
    x: data,
    type: 'histogram',
    name: 'Data',
    opacity: 0.7,
    marker: { color: '#3b82f6' },
    histnorm: 'probability density'
  }];
  
  // Add normal curve
  var m = stats.mean;
  var s = stats.std;
  var xRange = [];
  var yRange = [];
  var min = Math.min.apply(Math, data);
  var max = Math.max.apply(Math, data);
  var step = (max - min) / 100;
  
  for (var x = min - s; x <= max + s; x += step) {
    xRange.push(x);
    yRange.push((1 / (s * Math.sqrt(2 * Math.PI))) * 
                Math.exp(-0.5 * Math.pow((x - m) / s, 2)));
  }
  
  histData.push({
    x: xRange,
    y: yRange,
    type: 'scatter',
    mode: 'lines',
    name: 'Normal curve',
    line: { color: '#ef4444', width: 2 }
  });
  
  var histLayout = {
    title: { text: 'Histogram: ' + variable, font: { size: 16 } },
    xaxis: { title: 'Value' },
    yaxis: { title: 'Density' },
    showlegend: true,
    plot_bgcolor: '#f8fafc',
    paper_bgcolor: 'white',
    margin: { t: 60, r: 20, b: 60, l: 60 },
    autosize: true
  };
  
  // 2. Q-Q Plot
  var qqData = generateQQData(data);
  var qqPlotData = [{
    x: qqData.theoretical,
    y: qqData.empirical,
    mode: 'markers',
    type: 'scatter',
    name: 'Data points',
    marker: { color: '#3b82f6', size: 5 }
  }];
  
  var minVal = Math.min.apply(Math, qqData.theoretical);
  var maxVal = Math.max.apply(Math, qqData.theoretical);
  qqPlotData.push({
    x: [minVal, maxVal],
    y: [minVal, maxVal],
    mode: 'lines',
    type: 'scatter',
    name: 'Reference line',
    line: { color: '#ef4444', dash: 'dash' }
  });
  
  var qqLayout = {
    title: { text: 'Q-Q Plot: ' + variable, font: { size: 16 } },
    xaxis: { title: 'Theoretical Quantiles' },
    yaxis: { title: 'Sample Quantiles' },
    showlegend: true,
    plot_bgcolor: '#f8fafc',
    paper_bgcolor: 'white',
    margin: { t: 60, r: 20, b: 60, l: 60 },
    autosize: true
  };
  
  // 3. Box plot
  var boxData = [{
    y: data,
    type: 'box',
    name: variable,
    marker: { color: '#3b82f6' }
  }];
  
  var boxLayout = {
    title: { text: 'Box Plot: ' + variable, font: { size: 16 } },
    yaxis: { title: 'Value' },
    plot_bgcolor: '#f8fafc',
    paper_bgcolor: 'white',
    margin: { t: 60, r: 20, b: 60, l: 60 },
    autosize: true
  };
  
  // 4. P-P Plot
  var sortedData = data.slice().sort(function(a, b) { return a - b; });
  var empiricalCDF = [];
  var theoreticalCDF = [];
  
  for (var i = 0; i < sortedData.length; i++) {
    empiricalCDF.push((i + 0.5) / sortedData.length);
    theoreticalCDF.push(normalCDF((sortedData[i] - m) / s));
  }
  
  var ppPlotData = [{
    x: theoreticalCDF,
    y: empiricalCDF,
    mode: 'markers',
    type: 'scatter',
    name: 'Data points',
    marker: { color: '#3b82f6', size: 5 }
  }];
  
  ppPlotData.push({
    x: [0, 1],
    y: [0, 1],
    mode: 'lines',
    type: 'scatter',
    name: 'Reference line',
    line: { color: '#ef4444', dash: 'dash' }
  });
  
  var ppLayout = {
    title: { text: 'P-P Plot: ' + variable, font: { size: 16 } },
    xaxis: { title: 'Theoretical CDF', range: [0, 1] },
    yaxis: { title: 'Empirical CDF', range: [0, 1] },
    showlegend: true,
    plot_bgcolor: '#f8fafc',
    paper_bgcolor: 'white',
    margin: { t: 60, r: 20, b: 60, l: 60 },
    autosize: true
  };
  
  // Render plots
  setTimeout(function() {
    Plotly.newPlot('histogramPlot', histData, histLayout, {displayModeBar: false, responsive: true});
    Plotly.newPlot('qqPlot', qqPlotData, qqLayout, {displayModeBar: false, responsive: true});
    Plotly.newPlot('boxPlot', boxData, boxLayout, {displayModeBar: false, responsive: true});
    Plotly.newPlot('ppPlot', ppPlotData, ppLayout, {displayModeBar: false, responsive: true});
  }, 100);
}

// Main Analysis Function
function runNormalityTest() {
  if (!selectedTestType || !currentData) {
    alert('Please select a test type and variables first.');
    return;
  }
  
  selectedVariables = Array.from(document.querySelectorAll('.var-checkbox:checked'))
    .map(function(cb) { return cb.value; });
  
  if (selectedVariables.length === 0) {
    alert('Please select at least one variable to test.');
    return;
  }
  
  var alpha = parseFloat(document.getElementById('alphaLevel').value);
  
  var hypothesisHTML = '<div class="hypothesis-box">' +
    '<h3>🎯 Hypothesis Setup</h3>' +
    '<div><strong>Null Hypothesis (H₀):</strong> The data follows a normal distribution</div>' +
    '<div><strong>Alternative Hypothesis (H₁):</strong> The data does not follow a normal distribution</div>' +
    '<div><strong>Significance Level:</strong> α = ' + alpha + '</div>' +
    '</div>';
  
  var descriptiveHTML = '<h3>📊 Descriptive Statistics</h3><div class="grid-3">';
  var allStats = {};
  
  selectedVariables.forEach(function(varName) {
    var values = currentData.map(function(d) { return parseFloat(d[varName]); }).filter(function(v) { return !isNaN(v); });
    var stats = {
      n: values.length,
      mean: mean(values),
      median: median(values),
      std: std(values),
      skewness: skewness(values),
      kurtosis: kurtosis(values),
      min: Math.min.apply(Math, values),
      max: Math.max.apply(Math, values)
    };
    allStats[varName] = { values: values, stats: stats };
    
    descriptiveHTML += '<div class="stat-card">' +
      '<h4>' + varName + '</h4>' +
      '<div><strong>n:</strong> ' + stats.n + '</div>' +
      '<div><strong>Mean:</strong> ' + stats.mean.toFixed(2) + '</div>' +
      '<div><strong>SD:</strong> ' + stats.std.toFixed(2) + '</div>' +
      '<div><strong>Skewness:</strong> ' + stats.skewness.toFixed(3) + '</div>' +
      '<div><strong>Kurtosis:</strong> ' + stats.kurtosis.toFixed(3) + '</div>' +
      '</div>';
  });
  descriptiveHTML += '</div>';
  
  var testResultsHTML = '<h3>🔬 Test Results</h3>';
  var testResults = {};
  
  selectedVariables.forEach(function(varName) {
    var data = allStats[varName].values;
    var results = {};
    
    if (selectedTestType === 'all' || selectedTestType === 'shapiro') {
      results.shapiro = shapiroWilk(data);
    }
    if (selectedTestType === 'all' || selectedTestType === 'jarque-bera') {
      results.jarqueBera = jarqueBera(data);
    }
    if (selectedTestType === 'all' || selectedTestType === 'ks') {
      results.ks = kolmogorovSmirnov(data);
    }
    if (selectedTestType === 'all' || selectedTestType === 'anderson') {
      results.anderson = andersonDarling(data);
    }
    if (selectedTestType === 'all' || selectedTestType === 'dagostino') {
      results.dagostino = dagostinoPearson(data);
    }
    if (selectedTestType === 'all' || selectedTestType === 'lilliefors') {
      results.lilliefors = lilliefors(data);
    }
    
    testResults[varName] = results;
    
    testResultsHTML += '<h4>' + varName + '</h4>';
    testResultsHTML += '<div class="table-container">';
    testResultsHTML += '<table><thead><tr>' +
      '<th>Test</th><th>Statistic</th><th>p-value</th><th>Decision (α=' + alpha + ')</th>' +
      '</tr></thead><tbody>';
    
    for (var testName in results) {
      var result = results[testName];
      if (result.error) continue;
      
      var isNormal = result.p > alpha;
      var rowClass = isNormal ? 'not-significant' : 'significant';
      var decision = isNormal ? 
        '<span class="sig">Normal</span>' : 
        '<span class="nsig">Not Normal</span>';
      
      var statName = 'Statistic';
      var statValue = '';
      
      if (testName === 'shapiro') {
        statName = 'W';
        statValue = result.W ? result.W.toFixed(4) : 'N/A';
      } else if (testName === 'jarqueBera') {
        statName = 'JB';
        statValue = result.JB ? result.JB.toFixed(4) : 'N/A';
      } else if (testName === 'ks') {
        statName = 'D';
        statValue = result.D ? result.D.toFixed(4) : 'N/A';
      } else if (testName === 'anderson') {
        statName = 'A²';
        statValue = result.A2 ? result.A2.toFixed(4) : 'N/A';
      } else if (testName === 'dagostino') {
        statName = 'K²';
        statValue = result.K2 ? result.K2.toFixed(4) : 'N/A';
      } else if (testName === 'lilliefors') {
        statName = 'D';
        statValue = result.D ? result.D.toFixed(4) : 'N/A';
      }
      
      var testDisplayName = {
        shapiro: 'Shapiro-Wilk',
        jarqueBera: 'Jarque-Bera',
        ks: 'Kolmogorov-Smirnov',
        anderson: 'Anderson-Darling',
        dagostino: "D'Agostino-Pearson",
        lilliefors: 'Lilliefors'
      }[testName];
      
      testResultsHTML += '<tr class="test-result-row ' + rowClass + '">' +
        '<td>' + testDisplayName + '</td>' +
        '<td>' + statName + ' = ' + statValue + '</td>' +
        '<td>' + (result.p < 0.001 ? '< 0.001' : (result.p ? result.p.toFixed(4) : 'N/A')) + '</td>' +
        '<td>' + decision + '</td>' +
        '</tr>';
    }
    
    testResultsHTML += '</tbody></table></div>';
  });
  
  createNormalityPlots(allStats);
  
  var interpretationHTML = generateInterpretation(testResults, allStats, alpha);
  var recommendationHTML = generateRecommendations(testResults, allStats, alpha);
  
  document.getElementById('hypothesisSection').innerHTML = hypothesisHTML;
  document.getElementById('descriptiveStats').innerHTML = descriptiveHTML;
  document.getElementById('testResults').innerHTML = testResultsHTML;
  document.getElementById('interpretationSection').innerHTML = interpretationHTML;
  document.getElementById('recommendationSection').innerHTML = recommendationHTML;
  
  document.getElementById('resultsPanel').style.display = 'block';
}

function generateInterpretation(testResults, allStats, alpha) {
  var html = '';
  
  selectedVariables.forEach(function(varName) {
    var results = testResults[varName];
    var stats = allStats[varName].stats;
    
    var normalCount = 0;
    var totalTests = 0;
    
    for (var testName in results) {
      var result = results[testName];
      if (result.p !== undefined && !result.error) {
        totalTests++;
        if (result.p > alpha) normalCount++;
      }
    }
    
    var isNormal = normalCount > totalTests / 2;
    var boxClass = isNormal ? 'accept' : 'warning';
    
    html += '<div class="interpretation-box ' + boxClass + '">' +
      '<h3>🎯 Interpretation: ' + varName + '</h3>' +
      '<div><strong>Overall Assessment:</strong> ' + 
      (isNormal ? 'The data appears to follow a normal distribution' : 'The data appears to deviate from normal distribution') +
      '<span class="normality-indicator ' + (isNormal ? 'normal' : 'non-normal') + '">' + (isNormal ? 'Normal' : 'Non-Normal') + '</span>' +
      '</div>' +
      '<div><strong>Test Agreement:</strong> ' + normalCount + '/' + totalTests + ' tests suggest normality</div>' +
      '<div><strong>Distribution Characteristics:</strong></div>' +
      '<ul style="margin:8px 0;">' +
      '<li><strong>Skewness:</strong> ' + (Math.abs(stats.skewness) < 0.5 ? 'Approximately symmetric' : 
                      stats.skewness > 0 ? 'Right-skewed (positive skew)' : 
                      'Left-skewed (negative skew)') + ' (' + stats.skewness.toFixed(3) + ')</li>' +
      '<li><strong>Kurtosis:</strong> ' + (Math.abs(stats.kurtosis) < 0.5 ? 'Approximately mesokurtic' : 
                      stats.kurtosis > 0 ? 'Leptokurtic (heavy-tailed)' : 
                      'Platykurtic (light-tailed)') + ' (' + stats.kurtosis.toFixed(3) + ')</li>' +
      '</ul>';
      
    if (!isNormal) {
      html += '<div style="margin-top:8px;color:#d97706;">' +
        '⚠️ <strong>Note:</strong> Non-normality detected. Consider data transformation or non-parametric methods.' +
        '</div>';
    }
    
    html += '</div>';
  });
  
  return html;
}

function generateRecommendations(testResults, allStats, alpha) {
  var html = '<div class="interpretation-box info">' +
    '<h3>💡 Recommendations</h3>';
  
  selectedVariables.forEach(function(varName) {
    var results = testResults[varName];
    var stats = allStats[varName].stats;
    
    var normalCount = 0;
    var totalTests = 0;
    
    for (var testName in results) {
      var result = results[testName];
      if (result.p !== undefined && !result.error) {
        totalTests++;
        if (result.p > alpha) normalCount++;
      }
    }
    
    var isNormal = normalCount > totalTests / 2;
    
    html += '<h4>' + varName + ':</h4><ul>';
    
    if (isNormal) {
      html += '<li>✅ Data appears normally distributed - parametric tests are appropriate</li>' +
        '<li>Consider using: t-tests, ANOVA, linear regression</li>';
    } else {
      html += '<li>⚠️ Data shows non-normality - consider the following:</li>' +
        '<li><strong>Transformations:</strong> ' + 
        (stats.skewness > 1 ? 'Try log or square root transformation' :
         stats.skewness < -1 ? 'Try square or cubic transformation' :
         Math.abs(stats.kurtosis) > 2 ? 'Try Box-Cox transformation' :
         'Try log, square root, or Box-Cox transformation') + '</li>' +
        '<li><strong>Non-parametric alternatives:</strong> Mann-Whitney U test, Wilcoxon signed-rank test, Kruskal-Wallis test</li>' +
        '<li><strong>Robust methods:</strong> Consider robust regression, bootstrapping, or permutation tests</li>';
    }
    
    html += '</ul>';
  });
  
  return html + '<div style="margin-top:12px;padding:8px;background:#f0f9ff;border-radius:6px;">' +
    '<strong>📌 General Guidelines:</strong>' +
    '<ul style="margin:4px 0;">' +
    '<li>For sample sizes > 30, moderate deviations from normality may be acceptable due to CLT</li>' +
    '<li>Visual inspection (Q-Q plot) often provides better insight than tests alone</li>' +
    '<li>Consider the context and purpose of your analysis when deciding on methods</li>' +
    '</ul>' +
    '</div>' +
    '</div>';
}

// Utility functions
function showNotifications() {
  alert('🔔 Notifications:\n\n• Normality tests completed\n• Distribution assessment performed\n• Visualizations generated\n• Statistical recommendations provided');
}

function showSettings() {
  alert('⚙️ Settings:\n\n• Multiple test options: Shapiro-Wilk, Jarque-Bera, K-S, etc.\n• Significance levels: 1%, 5%, 10%\n• Missing data handling options\n• Outlier detection and handling');
}

async function exportToPDF() {
  if (!selectedVariables || selectedVariables.length === 0) {
    alert('No results to export. Please run a normality test first.');
    return;
  }
  
  try {
    // Show loading indicator
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'pdf-loading';
    loadingDiv.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1001; text-align: center; min-width: 200px;
    `;
    loadingDiv.innerHTML = `
      <div style="margin-bottom: 16px; font-weight: 600; color: #1e293b;">Generating PDF Report...</div>
      <div style="color: #64748b; font-size: 14px;">Taking screenshot of results...</div>
    `;
    document.body.appendChild(loadingDiv);
    
    // Capture the results panel
    const resultsPanel = document.getElementById('resultsPanel');
    if (!resultsPanel || resultsPanel.style.display === 'none') {
      alert('No results to export. Please run a normality test first.');
      document.body.removeChild(loadingDiv);
      return;
    }
    
    // Take screenshot of the results
    const canvas = await html2canvas(resultsPanel, {
      backgroundColor: '#f8fafc',
      scale: 1.5,
      useCORS: true,
      allowTaint: false,
      width: resultsPanel.offsetWidth,
      height: resultsPanel.scrollHeight
    });
    
    // Create PDF
    const { jsPDF } = window.jspdf;
    const imgWidth = 210; // A4 width in mm
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    // Check if we need multiple pages
    const pageHeight = 297; // A4 height in mm
    let heightLeft = imgHeight;
    let position = 0;
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Add title page
    pdf.setFontSize(20);
    pdf.setTextColor(40, 40, 40);
    pdf.text('Normality Test Report', 20, 30);
    
    pdf.setFontSize(12);
    pdf.setTextColor(100, 100, 100);
    pdf.text('Generated on: ' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(), 20, 45);
    
    if (selectedTestType) {
      pdf.setTextColor(60, 130, 246);
      pdf.text('Test Type: ' + selectedTestType.charAt(0).toUpperCase() + selectedTestType.slice(1), 20, 60);
    }
    
    pdf.setTextColor(40, 40, 40);
    pdf.text('Variables: ' + selectedVariables.join(', '), 20, 75);
    
    // Add new page for results
    pdf.addPage();
    
    // Add the screenshot
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    // Add more pages if content is too long
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    // Save the PDF
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    pdf.save('normality-test-report-' + timestamp + '.pdf');
    
    // Remove loading indicator
    document.body.removeChild(loadingDiv);
    
  } catch (error) {
    console.error('PDF generation error:', error);
    const loadingDiv = document.getElementById('pdf-loading');
    if (loadingDiv) document.body.removeChild(loadingDiv);
    alert('Error generating PDF. Please try again.');
  }
}

function showHelp() {
  alert('📈 Normality Test Guide:\n\n• Shapiro-Wilk: Most powerful test, recommended for n < 5000\n• Jarque-Bera: Tests skewness and kurtosis\n• Kolmogorov-Smirnov: Distribution-free approach\n• Anderson-Darling: Sensitive to tail deviations\n• D\'Agostino-Pearson: Omnibus test\n• Lilliefors: Modified K-S test for unknown parameters\n\nInterpretation:\n• p > α: Accept normality (fail to reject H₀)\n• p ≤ α: Reject normality (evidence against H₀)\n• Use Q-Q plots for visual assessment\n• Consider transformations for non-normal data');
}

function saveConfiguration() {
  var config = {
    testType: selectedTestType,
    alpha: document.getElementById('alphaLevel').value
  };
  localStorage.setItem('normalityConfig', JSON.stringify(config));
  alert('Configuration saved successfully!');
}

function resetAll() {
  currentData = null;
  selectedTestType = null;
  selectedVariables = [];
  currentNormalityVariable = null;
  
  document.getElementById('dataPreview').innerHTML = '';
  document.getElementById('testTypePanel').style.display = 'none';
  document.getElementById('varPanel').style.display = 'none';
  document.getElementById('resultsPanel').style.display = 'none';
  document.getElementById('visualizationSection').style.display = 'none';
  document.getElementById('fileInput').value = '';
  
  document.querySelectorAll('.model-card').forEach(function(card) {
    card.classList.remove('selected');
  });
  
  ['histogramPlot', 'qqPlot', 'boxPlot', 'ppPlot'].forEach(function(plotId) {
    var plotDiv = document.getElementById(plotId);
    if (plotDiv && typeof Plotly !== 'undefined') {
      Plotly.purge(plotDiv);
    }
  });
  
  alert('Normality test reset successfully!');
}

// CSV File Loading
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('fileInput')) {
    document.getElementById('fileInput').addEventListener('change', function(event) {
      var file = event.target.files[0];
      if (file && file.type === "text/csv") {
        Papa.parse(file, {
          complete: function(results) {
            if (results.data && results.data.length > 1) {
              var headers = results.data[0];
              var data = results.data.slice(1).map(function(row) {
                var obj = {};
                headers.forEach(function(header, index) {
                  obj[header] = row[index];
                });
                return obj;
              }).filter(function(row) {
                return Object.values(row).some(function(val) {
                  return val !== null && val !== '';
                });
              });
              processData(data);
            }
          },
          header: false,
          dynamicTyping: true,
          skipEmptyLines: true
        });
      }
    });
  }
});
</script>
</body>
</html>
