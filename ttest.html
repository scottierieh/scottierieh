<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>t-검정 올인원 도구</title>

<!-- CSV 파싱 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
  :root{
    --bg:#f4f5f7; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --success:#059669;
    --fail:#9ca3af; --shadow:0 8px 30px rgba(16,24,40,0.06);
  }
  body{font-family:"Inter","Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111827;padding:24px}
  .main{max-width:950px;margin:auto;display:flex;flex-direction:column;gap:16px}
  .panel{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  h1{margin:0;font-size:22px;color:var(--accent)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.success{background:var(--success);color:#fff}
  .btn.ghost{background:#f3f4f6;color:#111827}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:8px 12px;border-bottom:1px solid #eef2f7;text-align:center}
  th{background:#f8fafc;font-weight:600}
  .muted{color:var(--muted);font-size:13px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .sig{color:var(--success);font-weight:700;}
  .nsig{color:var(--fail);font-weight:700;}
</style>
</head>
<body>
  <div class="main">
    <div class="panel">
      <h1>t-검정 올인원 도구</h1>
      <div class="muted">CSV 업로드 → 검정 종류 선택 → 변수 설정 → 실행</div>
    </div>

    <div class="panel">
      <div class="controls">
        <input id="fileInput" type="file" accept=".csv">
        <button class="btn success" onclick="loadExample()">예제 불러오기</button>
        <button class="btn ghost" onclick="resetAll()">초기화</button>
      </div>
      <div id="dataPreview"></div>
    </div>

    <div class="panel" id="varPanel" style="display:none;">
      <div>검정 종류</div>
      <select id="testType" onchange="updateVarUI()">
        <option value="one">단일표본 t-검정</option>
        <option value="independent">독립표본 t-검정 (Student)</option>
        <option value="welch">독립표본 t-검정 (Welch)</option>
        <option value="paired">대응표본 t-검정</option>
      </select>

      <div id="varSettings" style="margin-top:16px;"></div>
      <div class="controls"><button class="btn primary" onclick="runTtest()">🚀 실행</button></div>
    </div>

    <div class="panel" id="resultsPanel" style="display:none;">
      <div class="section-title">분석 결과</div>
      <div id="resultTables"></div>
      <div id="ttestPlot" style="height:350px;margin-top:20px;"></div>
    </div>
  </div>

<script>
let currentData=null;

// ✅ 예제 데이터
function loadExample(){
  const example=[
    {group:"남", score:85, pre:70, post:80},
    {group:"남", score:78, pre:68, post:74},
    {group:"남", score:90, pre:72, post:88},
    {group:"여", score:88, pre:75, post:85},
    {group:"여", score:92, pre:77, post:90},
    {group:"여", score:95, pre:74, post:93}
  ];
  processData(example);
}

// CSV 파일 로드
document.getElementById('fileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {   // ✅ MIME type 체크 제거
    Papa.parse(file, {
      complete: function(results) {
        processData(results.data.slice(1).map(row => {
          const obj = {};
          results.data[0].forEach((header, index) => {
            obj[header] = row[index];
          });
          return obj;
        }));
      },
      header: false
    });
  }
});

// ✅ 데이터 처리
function processData(data){
  currentData=data;
  const headers=Object.keys(data[0]);
  let preview='<table><thead><tr>';
  headers.forEach(h=>preview+=`<th>${h}</th>`); preview+='</tr></thead><tbody>';
  data.slice(0,5).forEach(r=>{
    preview+='<tr>';
    headers.forEach(h=>preview+=`<td>${r[h]}</td>`);
    preview+='</tr>';
  });
  preview+='</tbody></table>';
  document.getElementById('dataPreview').innerHTML=preview;
  updateVarUI(headers);
  document.getElementById('varPanel').style.display='block';
}

// ✅ 변수 UI 업데이트
function updateVarUI(headers=null){
  if(!headers&&currentData) headers=Object.keys(currentData[0]);
  const type=document.getElementById('testType').value;
  let html="";
  if(type==="one"){
    html=`<div class="grid-2">
      <div><div>분석 변수</div><select id="oneVar">${headers.map(h=>`<option>${h}</option>`).join('')}</select></div>
      <div><div>비교 기준값 μ₀</div><input id="mu0" type="number" value="80"></div></div>`;
  }else if(type==="independent"||type==="welch"){
    html=`<div class="grid-2">
      <div><div>집단 변수</div><select id="groupVar">${headers.map(h=>`<option>${h}</option>`).join('')}</select></div>
      <div><div>분석 변수</div><select id="indVar">${headers.map(h=>`<option>${h}</option>`).join('')}</select></div></div>`;
  }else if(type==="paired"){
    html=`<div class="grid-2">
      <div><div>변수 1 (사전)</div><select id="pair1">${headers.map(h=>`<option>${h}</option>`).join('')}</select></div>
      <div><div>변수 2 (사후)</div><select id="pair2">${headers.map(h=>`<option>${h}</option>`).join('')}</select></div></div>`;
  }
  document.getElementById('varSettings').innerHTML=html;
}

// t분포 확률밀도함수
function tPdf(x, df) {
  const gamma1 = Math.exp(logGamma((df + 1) / 2));
  const gamma2 = Math.exp(logGamma(df / 2));
  return (gamma1 / (Math.sqrt(df * Math.PI) * gamma2)) * Math.pow(1 + x * x / df, -(df + 1) / 2);
}

// 감마함수의 로그
function logGamma(z) {
  if (z < 0.5) {
    return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
  }
  z -= 1;
  let x = 0.99999999999999709182;
  const cof = [57.156235665862923517, -59.597960355475491248, 14.136097974741747174, -0.49191381609762019978, 0.33994649984811888699e-4, 0.46523628927048575665e-4, -0.98374475304879564677e-4, 0.15808870322491248884e-3, -0.21026444172410488319e-3, 0.21743961811521264320e-3, -0.16431810653676389022e-3, 0.84418223983852743293e-4, -0.26190838401581408670e-4, 0.36899182659531622704e-5];
  for (let i = 0; i < cof.length; i++) {
    x += cof[i] / (z + i + 1);
  }
  const t = z + cof.length - 0.5;
  return Math.log(Math.sqrt(2 * Math.PI)) + (z + 0.5) * Math.log(t) - t + Math.log(x);
}

// t분포 누적분포함수 (간단 근사)
function tCdf(t, df) {
  if (t === 0) return 0.5;
  const x = t / Math.sqrt(df);
  const a = Math.atan(x) / Math.PI + 0.5;
  if (df === 1) return a;
  if (df === 2) return 0.5 + x / (2 * Math.sqrt(1 + x * x));
  return 0.5 + 0.5 * Math.sign(t) * (1 - Math.exp(-2 * t * t / Math.PI));
}

// ✅ 실행
function runTtest(){
  const type=document.getElementById('testType').value;
  let result="", plotData=[], layout={}, pval=1;

  if(type==="one"){
    const v=document.getElementById('oneVar').value;
    const mu0=parseFloat(document.getElementById('mu0').value);
    const x=currentData.map(r=>parseFloat(r[v])).filter(n=>!isNaN(n));
    const m=mean(x), s=std(x), n=x.length;
    const t=(m-mu0)/(s/Math.sqrt(n));
    const df=n-1; 
    pval=2*(1-tCdf(Math.abs(t),df));
    const d=(m-mu0)/s;
    
    result+=tableHTML(
      ["N","평균","표준편차","t","df","p","Cohen's d"],
      [[n,m.toFixed(2),s.toFixed(2),t.toFixed(3),df,formatP(pval),d.toFixed(3)]]
    );
    ...
  }
  // (독립/웰치/대응 부분 생략, 그대로 유지)
  document.getElementById('resultTables').innerHTML=result;
  document.getElementById('resultsPanel').style.display='block';
  Plotly.newPlot('ttestPlot',plotData,layout,{displayModeBar:false});
}

// ✅ 유틸
function tableHTML(headers,rows){...}
function mean(a){...}
function std(a){...}
function formatP(p){...}
function resetAll(){...}

// 🔑 전역 등록
window.runTtest = runTtest;
window.loadExample = loadExample;
window.resetAll = resetAll;

</script>
</body>
</html>
