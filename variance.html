<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ANOVA / ANCOVA í†µí•©ë„êµ¬ (ê°œì„ )</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
  <style>
    :root {
      --bg: #f4f5f7; 
      --card: #ffffff; 
      --muted: #6b7280; 
      --accent: #2563eb; 
      --success: #059669;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #06b6d4;
      --shadow: 0 8px 30px rgba(16,24,40,0.06);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif; 
      margin: 0; 
      background: var(--bg); 
      color: #111827; 
      padding: 24px; 
      display: flex; 
      gap: 20px; 
      min-height: 100vh;
    }
    
    .sidebar {
      width: 280px; 
      background: var(--card); 
      border-radius: 16px; 
      padding: 18px; 
      box-shadow: var(--shadow); 
      height: fit-content;
    }
    
    .sidebar h2 { 
      text-align: center; 
      margin: 6px 0 12px 0; 
      font-size: 18px; 
      color: #1f2937;
    }
    
    .menu-item { 
      display: block; 
      padding: 10px 12px; 
      border-radius: 12px; 
      color: #374151; 
      margin-bottom: 6px; 
      cursor: pointer; 
      transition: all .18s ease;
    }
    
    .menu-item:hover {
      background: #f3f4f6;
    }
    
    .menu-item.active { 
      background: var(--accent); 
      color: white; 
      font-weight: 600; 
      box-shadow: 0 6px 18px rgba(37,99,235,0.14);
    }
    
    .menu-category {
      margin-top: 14px;
      margin-bottom: 6px;
      font-weight: 700;
      color: #111827;
      font-size: 14px;
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .main { 
      flex: 1; 
      display: none;
      flex-direction: column; 
      gap: 16px;
    }
    
    .main.active {
      display: flex;
    }
    
    .panel { 
      background: var(--card); 
      border-radius: 16px; 
      padding: 18px; 
      box-shadow: var(--shadow);
    }
    
    h1 { 
      margin: 0; 
      font-size: 20px; 
      color: #1f2937;
    }
    
    h3 { 
      margin: 0 0 12px 0; 
      font-size: 16px; 
      color: #1f2937;
    }
    
    .controls { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-top: 12px;
      align-items: center;
    }
    
    .btn { 
      border: 0; 
      padding: 10px 12px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 14px; 
      transition: all 0.2s;
    }
    
    .btn.primary { 
      background: var(--accent); 
      color: #fff;
    }
    
    .btn.success { 
      background: var(--success); 
      color: #fff;
    }
    
    .btn.ghost { 
      background: #f3f4f6; 
      color: #111827;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    select, input[type="file"] { 
      padding: 8px 12px; 
      border-radius: 8px; 
      border: 1px solid #e6eef7; 
      margin-top: 8px; 
      font-size: 14px;
    }
    
    input[type="file"] { 
      width: auto; 
    }
    
    input[type="checkbox"] {
      margin-right: 6px;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 12px; 
      font-size: 13px; 
      background: white;
    }
    
    th, td { 
      padding: 8px; 
      border-bottom: 1px solid #eef2f7; 
      text-align: center;
    }
    
    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }
    
    .muted { 
      color: var(--muted); 
      font-size: 13px;
    }
    
    .inline { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      flex-wrap: wrap; 
      margin-bottom: 15px;
    }
    
    .var-select { 
      width: 260px; 
      margin-top: 6px;
    }
    
    .data-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow: auto;
    }
    
    .data-preview h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #374151;
    }
    
    .data-table {
      font-size: 12px;
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #e2e8f0;
      padding: 6px 8px;
      font-weight: 600;
      font-size: 11px;
    }
    
    .data-table td {
      padding: 4px 8px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .section { 
      margin-bottom: 15px;
    }
    
    .var-section {
      background: #fafbfc;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .var-section label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: #374151;
      margin-bottom: 6px;
    }
    
    .analysis-options {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    
    .analysis-options label {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    
    .result-card {
      margin-top: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 12px;
    }
    
    /* í•´ì„ ê´€ë ¨ ìŠ¤íƒ€ì¼ - t-ê²€ì • ìŠ¤íƒ€ì¼ê³¼ í†µì¼ */
    .interpretation-box {
      background: #f0fdf4;
      border-left: 4px solid var(--success);
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .interpretation-box.reject {
      background: #fef2f2;
      border-left-color: var(--danger);
    }
    
    .interpretation-box.accept {
      background: #f0fdf4;
      border-left-color: var(--success);
    }
    
    .interpretation-box.warning {
      background: #fffbeb;
      border-left-color: var(--warning);
    }
    
    .interpretation-box h3 {
      margin: 0 0 10px 0;
      color: #334155;
    }
    
    .interpretation-item {
      margin-bottom: 8px;
    }
    
    .effect-size {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      margin-left: 8px;
    }
    
    .effect-small { background: #10b981; }
    .effect-medium { background: var(--warning); }
    .effect-large { background: #ef4444; }
    
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 12px; 
      margin-top: 12px;
    }
    
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .resultCard {
      margin-top: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 12px;
    }
    
    .interpretation-card {
      background: #f8fafc;
      border-left: 4px solid #64748b;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .interpretation-card h4 {
      margin: 0 0 10px 0;
      color: #334155;
    }
    
    .significant {
      color: #dc2626;
      font-weight: 600;
    }
    
    .not-significant {
      color: #059669;
      font-weight: 600;
    }
    
    .warning {
      color: #f59e0b;
      font-weight: 600;
    }
    
    #plotArea, #diagArea { 
      margin-top: 14px;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2>ğŸ“Š ë¶„ì„ ë©”ë‰´</h2>
    <div id="menuList">
      <div class="menu-category">ë°ì´í„° íƒìƒ‰</div>
      <div class="menu-item" data-target="descriptive.html">ê¸°ìˆ í†µê³„</div>

      <div class="menu-category">ì§‘ë‹¨ ê°„ ì°¨ì´ ê²€ì •</div>
      <div class="menu-item" data-target="main-ttest">t-ê²€ì • (ë…ë¦½/ëŒ€ì‘)</div>
      <div class="menu-item" data-target="main-chi">ì¹´ì´ì œê³± ê²€ì •</div>
      <div class="menu-item" data-target="main-nonparam">ë¹„ëª¨ìˆ˜ ê²€ì •</div>
      <div class="menu-item active" data-target="variance.html">ë¶„ì‚°ë¶„ì„ (ANOVA)</div>

      <div class="menu-category">ë³€ìˆ˜ ê°„ ê´€ê³„ ë¶„ì„</div>
      <div class="menu-item" data-target="main-corr">ìƒê´€ë¶„ì„</div>
      <div class="menu-item" data-target="main-reg">íšŒê·€ë¶„ì„</div>
      <div class="menu-item" data-target="main-probit">í”„ë¡œë¹—ë¶„ì„</div>
      <div class="menu-item" data-target="main-mediation">ë§¤ê°œíš¨ê³¼</div>
      <div class="menu-item" data-target="main-moderation">ì¡°ì ˆíš¨ê³¼</div>
      <div class="menu-item" data-target="main-discriminant">íŒë³„ë¶„ì„</div>
      <div class="menu-item" data-target="main-sem">SEM (êµ¬ì¡°ë°©ì •ì‹ ëª¨í˜•)</div>

      <div class="menu-category">ì°¨ì› ì¶•ì†Œ / êµ°ì§‘í™”</div>
      <div class="menu-item" data-target="main-pca">PCA</div>
      <div class="menu-item" data-target="main-efa">íƒìƒ‰ì  ìš”ì¸ë¶„ì„ (EFA)</div>
      <div class="menu-item" data-target="main-cfa">í™•ì¸ì  ìš”ì¸ë¶„ì„ (CFA)</div>
      <div class="menu-item" data-target="main-cluster">êµ°ì§‘ë¶„ì„</div>
    </div>
  </div>

  <!-- ë¶„ì‚°ë¶„ì„ (ANOVA) ë©”ì¸ -->
  <div class="main active" id="main-anova">
    <div class="panel">
      <h1>ë¶„ì‚°ë¶„ì„ (ANOVA)</h1>
      <div class="muted">CSV ì—…ë¡œë“œ â†’ ë³€ìˆ˜ ì„ íƒ â†’ ë¶„ì„ ì‹¤í–‰</div>
    </div>

    <div class="panel">
      <h3>ë°ì´í„° ì—…ë¡œë“œ</h3>
      <div class="inline">
        <input type="file" id="fileInput" accept=".csv">
        <button onclick="loadExample()" class="btn success">ğŸ“Š ì˜ˆì œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div class="muted">CSV ì²« í–‰ì€ ë³€ìˆ˜ëª…, ì‰¼í‘œ êµ¬ë¶„</div>
      
      <div id="dataPreview" style="display:none;" class="data-preview">
        <h4>ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 10í–‰)</h4>
        <div id="previewContent"></div>
      </div>
    </div>

    <div class="panel" id="analysisPanel" style="display:none;">
      <h3>ë¶„ì„ ì„¤ì •</h3>
      
      <div class="var-section">
        <label>ë¶„ì„ìœ í˜•</label>
        <select id="analysisType" onchange="renderVarSelectors()">
          <option value="oneway">ì¼ì› ë¶„ì‚°ë¶„ì„</option>
          <option value="twoway">ì´ì› ë¶„ì‚°ë¶„ì„</option>
          <option value="repeated">ë°˜ë³µì¸¡ì • ë¶„ì‚°ë¶„ì„ (ê°„ë‹¨ í‰ê· )</option>
          <option value="ancova">ANCOVA (ê³µë³€ëŸ‰ë¶„ì„)</option>
        </select>
      </div>
      
      <div id="varSelectors"></div>
      
      <div class="analysis-options">
        <label><input type="checkbox" id="doPosthoc" checked> ì‚¬í›„ê²€ì •(Tukey)</label>
        <label><input type="checkbox" id="doDiag" checked> ì§„ë‹¨(Levene/ì”ì°¨)</label>
      </div>
      
      <div class="controls">
        <button onclick="runAnalysis()" class="btn primary">ë¶„ì„ ì‹¤í–‰</button>
        <span id="msg" class="muted"></span>
      </div>
    </div>

    <div class="panel" id="resultPanel" style="display:none;">
      <h3>ë¶„ì„ ê²°ê³¼</h3>
      <div id="outputArea"></div>
    </div>

    <div id="plotArea"></div>
    <div id="diagArea"></div>
  </div>

  <!-- (ìŠ¤í…) ë‹¤ë¥¸ ë¶„ì„ í™”ë©´ì€ ë‚˜ì¤‘ì— êµ¬í˜„ ì˜ˆì • -->
  <div class="main" id="main-descriptive"><div class="panel"><h1>ğŸ“Š ê¸°ìˆ í†µê³„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-ttest"><div class="panel"><h1>ğŸ“Š t-ê²€ì •</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-chi"><div class="panel"><h1>ğŸ“Š ì¹´ì´ì œê³± ê²€ì •</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-nonparam"><div class="panel"><h1>ğŸ“Š ë¹„ëª¨ìˆ˜ ê²€ì •</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-corr"><div class="panel"><h1>ğŸ“Š ìƒê´€ë¶„ì„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-reg"><div class="panel"><h1>ğŸ“Š íšŒê·€ë¶„ì„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-probit"><div class="panel"><h1>ğŸ“Š í”„ë¡œë¹—ë¶„ì„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-mediation"><div class="panel"><h1>ğŸ“Š ë§¤ê°œíš¨ê³¼</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-moderation"><div class="panel"><h1>ğŸ“Š ì¡°ì ˆíš¨ê³¼</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-discriminant"><div class="panel"><h1>ğŸ“Š íŒë³„ë¶„ì„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-sem"><div class="panel"><h1>ğŸ“Š SEM</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-pca"><div class="panel"><h1>ğŸ“Š PCA</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-efa"><div class="panel"><h1>ğŸ“Š íƒìƒ‰ì  ìš”ì¸ë¶„ì„ (EFA)</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-cfa"><div class="panel"><h1>ğŸ“Š í™•ì¸ì  ìš”ì¸ë¶„ì„ (CFA)</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>
  <div class="main" id="main-cluster"><div class="panel"><h1>ğŸ“Š êµ°ì§‘ë¶„ì„</h1><div class="muted">ì¤€ë¹„ì¤‘</div></div></div>

<script>
let data = [];
let headers = [];

/* ---------------- CSV ë¡œë”©/íŒŒì‹± ---------------- */
function parseCSV(text) {
  const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
  headers = rows[0].map(h => h.trim());
  return rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h,i) => {
      const v = r[i]!==undefined ? r[i].trim() : "";
      const num = Number(v);
      obj[h] = (v!=="" && !Number.isNaN(num) && /^-?\d+(\.\d+)?$/.test(v)) ? num : v;
    });
    return obj;
  });
}

function showDataPreview(data) {
  if (!data || data.length === 0) return;
  
  const preview = data.slice(0, 10);
  const headers = Object.keys(preview[0]);
  
  let html = '<table class="data-table">';
  html += '<thead><tr>';
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  
  preview.forEach(row => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  
  document.getElementById('previewContent').innerHTML = html;
  document.getElementById('dataPreview').style.display = 'block';
  document.getElementById('analysisPanel').style.display = 'block';
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ - íŒŒì¼ ì…ë ¥ë§Œ ë”°ë¡œ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
  // ë©”ë‰´ í•¸ë“¤ëŸ¬ ì¶”ê°€
  document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      item.classList.add('active');
      const targetId = item.getAttribute('data-target');
      document.querySelectorAll('.main').forEach(p => p.classList.remove('active'));
      const target = document.getElementById(targetId);
      if(target) target.classList.add('active');
    });
  });

  document.getElementById("fileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        data = parseCSV(evt.target.result);
        showDataPreview(data);
        renderVarSelectors();
      } catch (error) {
        alert("íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: " + error.message);
      }
    };
    reader.readAsText(file, "utf-8");
  });
});
/* ---------------- ì˜ˆì œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ---------------- */
function loadExample(){
  const csv = `ID,ì„±ë³„,êµìœ¡ë°©ë²•,ì‚¬ì „ì ìˆ˜,ì‚¬í›„ì ìˆ˜,ë§Œì¡±ë„,ì—°ë ¹
1,ë‚¨,ì˜¨ë¼ì¸,75,85,4.2,25
2,ë‚¨,ì˜¨ë¼ì¸,72,82,4.1,27
3,ë‚¨,ì˜¨ë¼ì¸,78,88,4.5,24
4,ë‚¨,ì˜¤í”„ë¼ì¸,70,78,3.8,26
5,ë‚¨,ì˜¤í”„ë¼ì¸,74,80,3.9,28
6,ë‚¨,ì˜¤í”„ë¼ì¸,76,84,4.0,25
7,ì—¬,ì˜¨ë¼ì¸,80,92,4.6,23
8,ì—¬,ì˜¨ë¼ì¸,78,90,4.4,25
9,ì—¬,ì˜¨ë¼ì¸,82,95,4.7,24
10,ì—¬,ì˜¤í”„ë¼ì¸,75,88,4.2,27
11,ì—¬,ì˜¤í”„ë¼ì¸,79,91,4.3,26
12,ì—¬,ì˜¤í”„ë¼ì¸,77,89,4.1,28`;
  data = parseCSV(csv);
  showDataPreview(data);
  renderVarSelectors();
}

/* ---------------- UI: ë³€ìˆ˜ ì„ íƒ ---------------- */
function renderVarSelectors(){
  if (data.length===0) {
    document.getElementById("varSelectors").innerHTML = `<div class="muted">ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.</div>`;
    return;
  }
  
  const vars = Object.keys(data[0]);
  const opts = vars.map(v=>`<option value="${v}">${v}</option>`).join("");
  const at = document.getElementById("analysisType").value;
  let html = "";

  if(at==="oneway"){
    html += `<div class="var-section"><label>ì¢…ì†ë³€ìˆ˜ Y</label><select id="dep" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ì§‘ë‹¨ë³€ìˆ˜ G</label><select id="grpA" class="var-select">${opts}</select></div>`;
  }else if(at==="twoway"){
    html += `<div class="var-section"><label>ì¢…ì†ë³€ìˆ˜ Y</label><select id="dep" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ìš”ì¸ A</label><select id="grpA" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ìš”ì¸ B</label><select id="grpB" class="var-select">${opts}</select></div>`;
  }else if(at==="repeated"){
    html += `<div class="var-section"><label>í”¼í—˜ì ID</label><select id="subj" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ë°˜ë³µì¸¡ì • ë³€ìˆ˜ë“¤ (2ê°œ ì´ìƒ ì„ íƒ)</label><select id="rep" multiple size="4" class="var-select">${opts}</select></div>`;
    html += `<div class="muted">ì˜ˆ: ì‚¬ì „ì ìˆ˜, ì‚¬í›„ì ìˆ˜, ë§Œì¡±ë„ ë“± ì‹œê°„ì— ë”°ë¥¸ ì¸¡ì •ê°’ë“¤ì„ ì„ íƒí•˜ì„¸ìš”</div>`;
    html += `<div class="muted" style="margin-top:8px; font-size:12px; color:#6b7280;">
      ğŸ’¡ <strong>êµ¬í˜•ì„± ê°€ì •:</strong> 2ì¡°ê±´=ìë™ë§Œì¡±, 3ì¡°ê±´ì´ìƒ=ê²€ì •í›„ í•„ìš”ì‹œ êµì •(GG/HF)
    </div>`;
  }else if(at==="ancova"){
    html += `<div class="var-section"><label>ì¢…ì†ë³€ìˆ˜ Y</label><select id="dep" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ì§‘ë‹¨ë³€ìˆ˜(ë²”ì£¼)</label><select id="grpA" class="var-select">${opts}</select></div>`;
    html += `<div class="var-section"><label>ê³µë³€ëŸ‰ X(ì—°ì†)</label><select id="cov" class="var-select">${opts}</select></div>`;
  }
  document.getElementById("varSelectors").innerHTML = html;
}

/* ---------------- ë„ìš°ë¯¸ ---------------- */
const uniq = arr => [...new Set(arr)];
const flatten = arr => [].concat(...arr);
function mean(arr){ return arr.reduce((a,b)=>a+b,0) / arr.length; }
function sumsq(arr, m){ return arr.reduce((s,v)=> s + Math.pow(v-m,2), 0); }
function variance(arr){ const m=mean(arr); return sumsq(arr,m)/(arr.length-1); }

function pValueF(F, df1, df2){ 
  return "-";
}

/* ---------------- íš¨ê³¼í¬ê¸° í•´ì„ í•¨ìˆ˜ ì¶”ê°€ ---------------- */
function interpretEffectSize(eta2, type = "eta") {
  if (type === "eta") {
    if (eta2 < 0.01) return { level: "ë¯¸ë¯¸í•¨", class: "effect-small", text: "ê±°ì˜ íš¨ê³¼ ì—†ìŒ" };
    if (eta2 < 0.06) return { level: "ì‘ìŒ", class: "effect-small", text: "ì‘ì€ íš¨ê³¼" };
    if (eta2 < 0.14) return { level: "ì¤‘ê°„", class: "effect-medium", text: "ì¤‘ê°„ íš¨ê³¼" };
    return { level: "í¼", class: "effect-large", text: "í° íš¨ê³¼" };
  }
  return { level: "-", class: "effect-small", text: "" };
}

function interpretFValue(F, threshold = 1.0) {
  if (F > 4.0) return "ë§¤ìš° ê°•í•œ ì°¨ì´";
  if (F > 2.5) return "ê°•í•œ ì°¨ì´";
  if (F > threshold) return "ì•½í•œ ì°¨ì´";
  return "ì°¨ì´ ì—†ìŒ";
}

/* ---------------- Tukey HSD ---------------- */
const qTable = {
  10:  {2:2.98,3:3.80,4:4.17,5:4.39,6:4.54,7:4.65,8:4.73,9:4.80,10:4.86},
  20:  {2:2.86,3:3.59,4:3.94,5:4.16,6:4.31,7:4.42,8:4.50,9:4.56,10:4.62},
  30:  {2:2.82,3:3.52,4:3.86,5:4.08,6:4.22,7:4.33,8:4.41,9:4.47,10:4.52},
  40:  {2:2.80,3:3.49,4:3.83,5:4.04,6:4.19,7:4.29,8:4.37,9:4.43,10:4.48},
  60:  {2:2.77,3:3.45,4:3.78,5:4.00,6:4.14,7:4.24,8:4.32,9:4.38,10:4.43},
  120: {2:2.75,3:3.41,4:3.74,5:3.95,6:4.09,7:4.19,8:4.27,9:4.33,10:4.38},
  inf: {2:2.77,3:3.31,4:3.63,5:3.83,6:3.97,7:4.08,8:4.15,9:4.23,10:4.29}
};

function qCritical(k, df){
  const keys=[10,20,30,40,60,120,Number.POSITIVE_INFINITY];
  const row = keys.find(x => df <= x) || Number.POSITIVE_INFINITY;
  const key = (row===Number.POSITIVE_INFINITY) ? 'inf' : row;
  const kk = Math.max(2, Math.min(10, k));
  return qTable[key][kk];
}

function tukeyKramer(groups, MSw, dfw){
  const keys = Object.keys(groups);
  const res = [];
  const q = qCritical(keys.length, dfw);
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      const g1=keys[i], g2=keys[j];
      const m1=mean(groups[g1]), m2=mean(groups[g2]);
      const n1=groups[g1].length, n2=groups[g2].length;
      const diff = Math.abs(m1-m2);
      const SE = Math.sqrt(MSw/2*(1/n1 + 1/n2));
      const HSD = q*SE;
      res.push({g1,g2,diff,SE,HSD,sig: diff>HSD ? "*" : "ns"});
    }
  }
  return res;
}

function leveneTest(arrByGroup){
  const keys = Object.keys(arrByGroup);
  const Z = {};
  keys.forEach(k=>{
    const arr = arrByGroup[k];
    const med = arr.slice().sort((a,b)=>a-b)[Math.floor(arr.length/2)];
    Z[k] = arr.map(v => Math.abs(v - med));
  });
  
  const allZ = flatten(Object.values(Z));
  const grand = mean(allZ);
  let SSb=0, SSw=0, N=0;
  keys.forEach(k=>{
    const mk = mean(Z[k]);
    SSb += Z[k].length * Math.pow(mk - grand, 2);
    SSw += sumsq(Z[k], mk);
    N += Z[k].length;
  });
  const k = keys.length;
  const df1 = k-1, df2 = N-k;
  const MSb = SSb/df1, MSw = SSw/df2;
  const F = MSb/MSw;
  return {F, df1, df2, SSb, SSw, MSb, MSw};
}

/* ---------------- ì‹¤í–‰ ---------------- */
function runAnalysis(){
  document.getElementById("outputArea").innerHTML = "";
  document.getElementById("plotArea").innerHTML = "";
  document.getElementById("diagArea").innerHTML = "";
  document.getElementById("resultPanel").style.display = "block";
  
  const at = document.getElementById("analysisType").value;
  if(at==="oneway") runOneWay();
  else if(at==="twoway") runTwoWay();
  else if(at==="repeated") runRepeated();
  else if(at==="ancova") runANCOVA();
}

/* ---------------- ì¼ì›ë¶„ì‚°ë¶„ì„ ---------------- */
function runOneWay(){
  const dep = document.getElementById("dep").value;
  const grp = document.getElementById("grpA").value;

  const groups = {};
  data.forEach(r=>{
    const g = r[grp], y = Number(r[dep]);
    if(!Number.isNaN(y)) (groups[g] ??= []).push(y);
  });
  const keys = Object.keys(groups);
  if(keys.length < 2){ alert("ì§‘ë‹¨ì€ 2ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤."); return; }

  const all = flatten(Object.values(groups));
  const grand = mean(all);
  const k = keys.length, N = all.length;

  let SSb=0, SSw=0;
  keys.forEach(kv=>{
    const m = mean(groups[kv]);
    SSb += groups[kv].length * Math.pow(m-grand,2);
    SSw += sumsq(groups[kv], m);
  });
  const dfb=k-1, dfw=N-k;
  const MSb=SSb/dfb, MSw=SSw/dfw;
  const F=MSb/MSw;
  const SSt = SSb + SSw;

  const eta2 = SSb / SSt;
  const omega2 = (SSb - dfb*MSw) / (SSt + MSw);

  let tukeyHTML = "";
  let tukeyResults = [];
  if(document.getElementById("doPosthoc").checked){
    const tk = tukeyKramer(groups, MSw, dfw);
    tukeyResults = tk;
    tukeyHTML = `<div class="result-card"><h4>ì‚¬í›„ê²€ì •: Tukey HSD (Î±=0.05 ê·¼ì‚¬)</h4>
      <table><tr><th>ë¹„êµ</th><th>|ì°¨ì´|</th><th>SE</th><th>HSD</th><th>ìœ ì˜</th></tr>
      ${tk.map(o=>`<tr><td>${o.g1} - ${o.g2}</td><td>${o.diff.toFixed(3)}</td><td>${o.SE.toFixed(3)}</td><td>${o.HSD.toFixed(3)}</td><td>${o.sig}</td></tr>`).join("")}
      </table></div>`;
  }

  // í•´ì„ ì¶”ê°€
  const effectSize = interpretEffectSize(eta2);
  const fInterpret = interpretFValue(F);
  const significantPairs = tukeyResults.filter(r => r.sig === "*").length;
  
  let interpretationHTML = `
    <div class="interpretation-box ${F > 2.5 ? 'reject' : 'accept'}">
      <h3>ë¶„ì„ ê²°ê³¼ í•´ì„</h3>
      
      <div class="interpretation-item">
        <strong>ì£¼íš¨ê³¼ ê²€ì •:</strong> F(${dfb}, ${dfw}) = ${F.toFixed(3)}
        <span class="effect-size ${effectSize.class}">${effectSize.level}</span>
        <br><small>${fInterpret} (${effectSize.text})</small>
      </div>
      
      <div class="interpretation-item">
        <strong>íš¨ê³¼í¬ê¸° í•´ì„:</strong><br>
        â€¢ Î·Â² = ${eta2.toFixed(3)} (ì „ì²´ ë³€ëŸ‰ì˜ ${(eta2*100).toFixed(1)}%ë¥¼ ì§‘ë‹¨ ì°¨ì´ê°€ ì„¤ëª…)<br>
        â€¢ Ï‰Â² = ${omega2.toFixed(3)} (ëª¨ì§‘ë‹¨ íš¨ê³¼í¬ê¸° ì¶”ì •ì¹˜)
      </div>`;
  
  if (tukeyResults.length > 0) {
    interpretationHTML += `
      <div class="interpretation-item">
        <strong>ì‚¬í›„ê²€ì • ìš”ì•½:</strong><br>
        â€¢ ì´ ${tukeyResults.length}ê°œ ë¹„êµ ì¤‘ ${significantPairs}ê°œ ìœ ì˜í•œ ì°¨ì´<br>
        â€¢ ìœ ì˜í•œ ì§‘ë‹¨ ìŒ: ${tukeyResults.filter(r => r.sig === "*").map(r => `${r.g1}-${r.g2}`).join(", ") || "ì—†ìŒ"}
      </div>`;
  }
  
  // ì§‘ë‹¨ë³„ ê¸°ìˆ í†µê³„
  const groupStats = keys.map(k => ({
    group: k,
    n: groups[k].length,
    mean: mean(groups[k]),
    sd: Math.sqrt(variance(groups[k]))
  }));
  
  interpretationHTML += `
      <div class="interpretation-item">
        <strong>ì§‘ë‹¨ë³„ ê¸°ìˆ í†µê³„:</strong><br>
        ${groupStats.map(s => `â€¢ ${s.group}: M=${s.mean.toFixed(2)}, SD=${s.sd.toFixed(2)} (n=${s.n})`).join("<br>")}
      </div>
    </div>`;

  document.getElementById("outputArea").innerHTML = `
    <div class="result-card">
      <h4>ì¼ì› ë¶„ì‚°ë¶„ì„ (${grp} â†’ ${dep})</h4>
      <table>
        <tr><th>ìš”ì¸</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p</th></tr>
        <tr><td>Between</td><td>${SSb.toFixed(3)}</td><td>${dfb}</td><td>${MSb.toFixed(3)}</td><td>${F.toFixed(3)}</td><td>${pValueF(F,dfb,dfw)}</td></tr>
        <tr><td>Within</td><td>${SSw.toFixed(3)}</td><td>${dfw}</td><td>${MSw.toFixed(3)}</td><td>-</td><td>-</td></tr>
        <tr><td>Total</td><td>${SSt.toFixed(3)}</td><td>${N-1}</td><td>-</td><td>-</td><td>-</td></tr>
      </table>
      <div style="margin-top:10px;">íš¨ê³¼í¬ê¸°: Î·Â²=${eta2.toFixed(3)}, Ï‰Â²=${omega2.toFixed(3)}</div>
    </div>
    ${tukeyHTML}
    ${interpretationHTML}`;

  const traces = keys.map(kv=>{
    const arr = groups[kv];
    const m = mean(arr);
    const se = Math.sqrt(variance(arr)/arr.length);
    return { x:[kv], y:[m], type:"bar", name:kv,
      error_y:{type:"data", array:[se], visible:true} };
  });
  Plotly.newPlot("plotArea", traces, {title:`ì§‘ë‹¨ë³„ í‰ê·  Â± SE (${dep})`});

  if(document.getElementById("doDiag").checked){
    const lev = leveneTest(groups);
    const resid = flatten(keys.map(kv=>{
      const m=mean(groups[kv]); return groups[kv].map(v=>v-m);
    }));
    
    let diagInterpretation = `
      <div class="interpretation-box ${lev.F > 2.0 ? 'warning' : 'accept'}">
        <h3>ê°€ì • ê²€í† </h3>
        <div class="interpretation-item">
          <strong>ë“±ë¶„ì‚°ì„± (Levene ê²€ì •):</strong><br>
          F(${lev.df1}, ${lev.df2}) = ${lev.F.toFixed(3)}<br>
          <small>${lev.F > 2.0 ? "ë“±ë¶„ì‚°ì„± ê°€ì •ì´ ì˜ì‹¬ë©ë‹ˆë‹¤" : "ë“±ë¶„ì‚°ì„± ê°€ì •ì´ ë§Œì¡±ë©ë‹ˆë‹¤"}</small>
        </div>
        <div class="interpretation-item">
          <strong>ì •ê·œì„±:</strong><br>
          <small>ì”ì°¨ íˆìŠ¤í† ê·¸ë¨ì„ í†µí•´ ì •ê·œë¶„í¬ í˜•íƒœë¥¼ í™•ì¸í•˜ì„¸ìš”. ì¢… ëª¨ì–‘ì´ë©´ ì •ê·œì„± ê°€ì •ì´ ë§Œì¡±ë©ë‹ˆë‹¤.</small>
        </div>
      </div>`;
    
    document.getElementById("diagArea").innerHTML = `
      <div class="panel">
        <h3>ì§„ë‹¨</h3>
        <div>Levene ë“±ë¶„ì‚°ì„±: F(${lev.df1}, ${lev.df2})=${lev.F.toFixed(3)} (pâ‰ˆ-)</div>
        <div class="muted">ì •ê·œì„±ì€ ì”ì°¨ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ì ê²€(ê°„ë‹¨ í‘œì‹œ)</div>
        <div id="hist"></div>
        ${diagInterpretation}
      </div>`;
    const hist = { x: resid, type: "histogram", nbinsx: Math.min(30, Math.max(10, Math.floor(Math.sqrt(resid.length)))) };
    Plotly.newPlot("hist", [hist], {title:"ì”ì°¨ íˆìŠ¤í† ê·¸ë¨"});
  }
}

/* ---------------- ì´ì›ë¶„ì‚°ë¶„ì„ ---------------- */
function runTwoWay(){
  const dep=document.getElementById("dep").value;
  const A=document.getElementById("grpA").value;
  const B=document.getElementById("grpB").value;

  const levelsA = uniq(data.map(r=>r[A]));
  const levelsB = uniq(data.map(r=>r[B]));
  const cells = {};
  levelsA.forEach(a=>{ levelsB.forEach(b=>{ cells[a+","+b]=[]; }); });
  data.forEach(r=>{
    const a=r[A], b=r[B], y=Number(r[dep]);
    if(!Number.isNaN(y) && cells[a+","+b]) cells[a+","+b].push(y);
  });

  const all = flatten(Object.values(cells));
  const grand = mean(all);
  const meanA = {};
  const meanB = {};
  levelsA.forEach(a=>{
    meanA[a] = mean(flatten(levelsB.map(b=>cells[a+","+b])));
  });
  levelsB.forEach(b=>{
    meanB[b] = mean(flatten(levelsA.map(a=>cells[a+","+b])));
  });

  const nAB = {}; levelsA.forEach(a=>levelsB.forEach(b=>{ nAB[a+","+b]=cells[a+","+b].length; }));
  const SSA = levelsA.reduce((s,a)=> s + (levelsB.reduce((ss,b)=> ss + nAB[a+","+b],0)) * Math.pow(meanA[a]-grand,2), 0);
  const SSB = levelsB.reduce((s,b)=> s + (levelsA.reduce((ss,a)=> ss + nAB[a+","+b],0)) * Math.pow(meanB[b]-grand,2), 0);
  const SSAB = levelsA.reduce((s,a)=> s + levelsB.reduce((ss,b)=>{
      const mAB = mean(cells[a+","+b]);
      return ss + nAB[a+","+b] * Math.pow(mAB - meanA[a] - meanB[b] + grand, 2);
  },0),0);
  const SSW = levelsA.reduce((s,a)=> s + levelsB.reduce((ss,b)=>{
      const mAB = mean(cells[a+","+b]);
      return ss + sumsq(cells[a+","+b], mAB);
  },0),0);

  const N = all.length, a=levelsA.length, b=levelsB.length;
  const dfA=a-1, dfB=b-1, dfAB=(a-1)*(b-1), dfW=N-a*b;

  const MSA=SSA/dfA, MSB=SSB/dfB, MSAB=SSAB/dfAB, MSW=SSW/dfW;
  const FA=MSA/MSW, FB=MSB/MSW, FAB=MSAB/MSW;

  const etapA = SSA/(SSA+SSW);
  const etapB = SSB/(SSB+SSW);
  const etapAB = SSAB/(SSAB+SSW);

  let posthocHTML = "";
  let tukeyA = [], tukeyB = [];
  if(document.getElementById("doPosthoc").checked){
    const gA = {}; levelsA.forEach(a=>{ gA[a]=flatten(levelsB.map(b=>cells[a+","+b])); });
    tukeyA = tukeyKramer(gA, MSW, dfW);
    const gB = {}; levelsB.forEach(b=>{ gB[b]=flatten(levelsA.map(a=>cells[a+","+b])); });
    tukeyB = tukeyKramer(gB, MSW, dfW);

    posthocHTML = `
      <div class="result-card"><h4>ì‚¬í›„ê²€ì • (Tukey-Kramer, ì£¼íš¨ê³¼ ê¸°ì¤€)</h4>
      <div class="grid">
        <div>
          <div><b>${A}</b></div>
          <table><tr><th>ë¹„êµ</th><th>|ì°¨ì´|</th><th>SE</th><th>HSD</th><th>ìœ ì˜</th></tr>
            ${tukeyA.map(o=>`<tr><td>${o.g1} - ${o.g2}</td><td>${o.diff.toFixed(3)}</td><td>${o.SE.toFixed(3)}</td><td>${o.HSD.toFixed(3)}</td><td>${o.sig}</td></tr>`).join("")}
          </table>
        </div>
        <div>
          <div><b>${B}</b></div>
          <table><tr><th>ë¹„êµ</th><th>|ì°¨ì´|</th><th>SE</th><th>HSD</th><th>ìœ ì˜</th></tr>
            ${tukeyB.map(o=>`<tr><td>${o.g1} - ${o.g2}</td><td>${o.diff.toFixed(3)}</td><td>${o.SE.toFixed(3)}</td><td>${o.HSD.toFixed(3)}</td><td>${o.sig}</td></tr>`).join("")}
          </table>
        </div>
      </div></div>`;
  }

  // ì´ì›ë¶„ì‚°ë¶„ì„ í•´ì„ ì¶”ê°€
  const effectA = interpretEffectSize(etapA);
  const effectB = interpretEffectSize(etapB);
  const effectAB = interpretEffectSize(etapAB);
  
  const fInterpretA = interpretFValue(FA);
  const fInterpretB = interpretFValue(FB);
  const fInterpretAB = interpretFValue(FAB);
  
  let interpretationHTML = `
    <div class="interpretation-box ${(FA > 2.5 || FB > 2.5 || FAB > 2.5) ? 'reject' : 'accept'}">
      <h3>ë¶„ì„ ê²°ê³¼ í•´ì„</h3>
      
      <div class="interpretation-item">
        <strong>${A} ì£¼íš¨ê³¼:</strong> F(${dfA}, ${dfW}) = ${FA.toFixed(3)}
        <span class="effect-size ${effectA.class}">${effectA.level}</span>
        <br><small>${fInterpretA} (${effectA.text})</small>
      </div>
      
      <div class="interpretation-item">
        <strong>${B} ì£¼íš¨ê³¼:</strong> F(${dfB}, ${dfW}) = ${FB.toFixed(3)}
        <span class="effect-size ${effectB.class}">${effectB.level}</span>
        <br><small>${fInterpretB} (${effectB.text})</small>
      </div>
      
      <div class="interpretation-item">
        <strong>ìƒí˜¸ì‘ìš© (${A}Ã—${B}):</strong> F(${dfAB}, ${dfW}) = ${FAB.toFixed(3)}
        <span class="effect-size ${effectAB.class}">${effectAB.level}</span>
        <br><small>${fInterpretAB} ${FAB > 2.5 ? "- ë‘ ìš”ì¸ ê°„ ìƒí˜¸ì‘ìš©ì´ ì¡´ì¬í•©ë‹ˆë‹¤" : "- ë‘ ìš”ì¸ì€ ë…ë¦½ì ìœ¼ë¡œ ì‘ìš©í•©ë‹ˆë‹¤"}</small>
      </div>`;
  
  if (tukeyA.length > 0 || tukeyB.length > 0) {
    const sigA = tukeyA.filter(r => r.sig === "*").length;
    const sigB = tukeyB.filter(r => r.sig === "*").length;
    interpretationHTML += `
      <div class="interpretation-item">
        <strong>ì‚¬í›„ê²€ì • ìš”ì•½:</strong><br>
        â€¢ ${A}: ${tukeyA.length}ê°œ ë¹„êµ ì¤‘ ${sigA}ê°œ ìœ ì˜<br>
        â€¢ ${B}: ${tukeyB.length}ê°œ ë¹„êµ ì¤‘ ${sigB}ê°œ ìœ ì˜
      </div>`;
  }
  
  interpretationHTML += `
      <div class="interpretation-item">
        <strong>í•´ì„ ê°€ì´ë“œ:</strong><br>
        â€¢ ${FAB > 2.5 ? "ìƒí˜¸ì‘ìš©ì´ ìœ ì˜í•˜ë¯€ë¡œ ì£¼íš¨ê³¼ë³´ë‹¤ëŠ” ì„¸ë¶€ ë¶„ì„ì— ì§‘ì¤‘í•˜ì„¸ìš”" : "ì£¼íš¨ê³¼ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•´ì„í•˜ì„¸ìš”"}<br>
        â€¢ ìƒí˜¸ì‘ìš© ê·¸ë˜í”„ì—ì„œ ì„ ë“¤ì´ ${FAB > 2.5 ? "êµì°¨í•˜ê±°ë‚˜ í¬ê²Œ ë²Œì–´ì§€ë©´" : "í‰í–‰í•˜ë©´"} ìƒí˜¸ì‘ìš©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
      </div>
    </div>`;

  document.getElementById("outputArea").innerHTML = `
    <div class="result-card">
      <h4>ì´ì› ë¶„ì‚°ë¶„ì„ (${A}, ${B} â†’ ${dep})</h4>
      <table>
        <tr><th>ìš”ì¸</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p</th><th>partial Î·Â²</th></tr>
        <tr><td>${A}</td><td>${SSA.toFixed(3)}</td><td>${dfA}</td><td>${MSA.toFixed(3)}</td><td>${FA.toFixed(3)}</td><td>${pValueF(FA,dfA,dfW)}</td><td>${etapA.toFixed(3)}</td></tr>
        <tr><td>${B}</td><td>${SSB.toFixed(3)}</td><td>${dfB}</td><td>${MSB.toFixed(3)}</td><td>${FB.toFixed(3)}</td><td>${pValueF(FB,dfB,dfW)}</td><td>${etapB.toFixed(3)}</td></tr>
        <tr><td>${A}Ã—${B}</td><td>${SSAB.toFixed(3)}</td><td>${dfAB}</td><td>${MSAB.toFixed(3)}</td><td>${FAB.toFixed(3)}</td><td>${pValueF(FAB,dfAB,dfW)}</td><td>${etapAB.toFixed(3)}</td></tr>
        <tr><td>ì˜¤ì°¨</td><td>${SSW.toFixed(3)}</td><td>${dfW}</td><td>${MSW.toFixed(3)}</td><td>-</td><td>-</td><td>-</td></tr>
        <tr><td>Total</td><td>${(SSA+SSB+SSAB+SSW).toFixed(3)}</td><td>${N-1}</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
      </table>
    </div>
    ${posthocHTML}
    ${interpretationHTML}`;

  const traces = levelsA.map(a=>{
    return { x: levelsB, y: levelsB.map(b=> mean(cells[a+","+b]) ),
             mode:"lines+markers", name:`${A}:${a}` };
  });
  Plotly.newPlot("plotArea", traces, {title:`ìƒí˜¸ì‘ìš© ê·¸ë˜í”„ (${A} Ã— ${B})`, xaxis:{title:B}, yaxis:{title:dep}});

  if(document.getElementById("doDiag").checked){
    const lev = leveneTest(cells);
    const resid = flatten(Object.keys(cells).map(k=>{
      const m=mean(cells[k]); return cells[k].map(v=>v-m);
    }));
    
    let diagInterpretation = `
      <div class="interpretation-card">
        <h4>ğŸ”¬ ê°€ì • ê²€í† </h4>
        <div class="interpretation-item ${lev.F > 2.0 ? 'warning' : 'significant'}">
          <strong>ë“±ë¶„ì‚°ì„± (Levene ê²€ì •):</strong><br>
          F(${lev.df1}, ${lev.df2}) = ${lev.F.toFixed(3)}<br>
          <small>${lev.F > 2.0 ? "âš ï¸ ì…€ë³„ ë“±ë¶„ì‚°ì„± ê°€ì •ì´ ì˜ì‹¬ë©ë‹ˆë‹¤" : "âœ“ ë“±ë¶„ì‚°ì„± ê°€ì •ì´ ë§Œì¡±ë©ë‹ˆë‹¤"}</small>
        </div>
        <div class="interpretation-item">
          <strong>í‘œë³¸ í¬ê¸°:</strong><br>
          <small>ê° ì…€ì˜ í‘œë³¸ í¬ê¸°ê°€ ê· ë“±í•˜ë©´ ë” robustí•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
      </div>`;
    
    document.getElementById("diagArea").innerHTML = `
      <div class="panel">
        <h3>ì§„ë‹¨</h3>
        <div>Levene(ì…€ ë‹¨ìœ„ ë“±ë¶„ì‚°): F(${lev.df1}, ${lev.df2})=${lev.F.toFixed(3)} (pâ‰ˆ-)</div>
        <div id="hist2"></div>
        ${diagInterpretation}
      </div>`;
    const hist = { x: resid, type:"histogram", nbinsx: Math.min(30, Math.max(10, Math.floor(Math.sqrt(resid.length)))) };
    Plotly.newPlot("hist2", [hist], {title:"ì”ì°¨ íˆìŠ¤í† ê·¸ë¨"});
  }
}

/* ---------------- ë°˜ë³µì¸¡ì • (êµ¬í˜•ì„± ê²€ì • í¬í•¨) ---------------- */
function runRepeated(){
  const subj = document.getElementById("subj").value;
  const reps = [...document.getElementById("rep").selectedOptions].map(o=>o.value);
  if(reps.length < 2){ alert("ë°˜ë³µì¸¡ì • ë³€ìˆ˜ë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”."); return; }
  
  // ë°ì´í„° êµ¬ì„±: ê° í”¼í—˜ìë³„ë¡œ ë°˜ë³µì¸¡ì • ê°’ë“¤ ìˆ˜ì§‘
  const subjData = {};
  data.forEach(r => {
    const id = r[subj];
    if (!subjData[id]) subjData[id] = {};
    reps.forEach(rep => {
      const val = Number(r[rep]);
      if (!isNaN(val)) subjData[id][rep] = val;
    });
  });
  
  // ì™„ì „í•œ ë°ì´í„°ë§Œ ì‚¬ìš© (ëª¨ë“  ë°˜ë³µì¡°ê±´ì— ê°’ì´ ìˆëŠ” í”¼í—˜ì)
  const completeSubjs = Object.keys(subjData).filter(id => 
    reps.every(rep => subjData[id][rep] !== undefined)
  );
  
  if (completeSubjs.length === 0) {
    alert("ì™„ì „í•œ ë°˜ë³µì¸¡ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  const n = completeSubjs.length;
  const k = reps.length;
  
  // êµ¬í˜•ì„± ê²€ì •ì„ ìœ„í•œ ì°¨ì´ ì ìˆ˜ ê³„ì‚°
  let sphericityViolated = false;
  let epsilonGG = 1.0; // Greenhouse-Geisser epsilon
  let epsilonHF = 1.0; // Huynh-Feldt epsilon
  
  if (k > 2) {
    // ì°¨ì´ ì ìˆ˜ í–‰ë ¬ ê³„ì‚° (k-1 ê°œì˜ ì°¨ì´ ì ìˆ˜)
    const diffScores = [];
    for (let i = 0; i < k-1; i++) {
      diffScores[i] = completeSubjs.map(id => 
        subjData[id][reps[i]] - subjData[id][reps[i+1]]
      );
    }
    
    // ì°¨ì´ ì ìˆ˜ë“¤ì˜ ê³µë¶„ì‚° í–‰ë ¬
    const covMatrix = [];
    for (let i = 0; i < k-1; i++) {
      covMatrix[i] = [];
      for (let j = 0; j < k-1; j++) {
        const mean_i = mean(diffScores[i]);
        const mean_j = mean(diffScores[j]);
        let cov = 0;
        for (let s = 0; s < n; s++) {
          cov += (diffScores[i][s] - mean_i) * (diffScores[j][s] - mean_j);
        }
        covMatrix[i][j] = cov / (n - 1);
      }
    }
    
    // êµ¬í˜•ì„± ìœ„ë°˜ ê²€ì • (ê°„ë‹¨í•œ ê·¼ì‚¬)
    // ê³µë¶„ì‚° í–‰ë ¬ì˜ ëŒ€ê°ì„ ê³¼ ë¹„ëŒ€ê°ì„  ì›ì†Œë“¤ì˜ ì°¨ì´ ì •ë„ë¡œ íŒì •
    const diagonalMean = mean(covMatrix.map((row, i) => row[i]));
    let offDiagonalSum = 0, offDiagonalCount = 0;
    
    for (let i = 0; i < k-1; i++) {
      for (let j = 0; j < k-1; j++) {
        if (i !== j) {
          offDiagonalSum += Math.abs(covMatrix[i][j]);
          offDiagonalCount++;
        }
      }
    }
    
    const offDiagonalMean = offDiagonalCount > 0 ? offDiagonalSum / offDiagonalCount : 0;
    
    // êµ¬í˜•ì„± ìœ„ë°˜ íŒì • (íœ´ë¦¬ìŠ¤í‹±)
    if (offDiagonalMean / diagonalMean > 0.3) {
      sphericityViolated = true;
      // Greenhouse-Geisser epsilon ì¶”ì • (ê°„ë‹¨í•œ ê·¼ì‚¬)
      epsilonGG = Math.max(0.5, 1 - (offDiagonalMean / diagonalMean));
      // Huynh-Feldt epsilon (ë” liberalí•œ êµì •)
      epsilonHF = Math.min(1.0, epsilonGG * 1.2);
    }
  }
  
  // ê° ì¡°ê±´ë³„ í‰ê·  ê³„ì‚°
  const means = reps.map(rep => 
    mean(completeSubjs.map(id => subjData[id][rep]))
  );
  
  // í”¼í—˜ìë³„ í‰ê·  ê³„ì‚°
  const subjMeans = completeSubjs.map(id => 
    mean(reps.map(rep => subjData[id][rep]))
  );
  
  // ì „ì²´ í‰ê· 
  const grandMean = mean(means);
  
  // ì œê³±í•© ê³„ì‚°
  let SSTotal = 0, SSSubjects = 0, SSConditions = 0;
  
  // ì „ì²´ ì œê³±í•©
  completeSubjs.forEach(id => {
    reps.forEach(rep => {
      SSTotal += Math.pow(subjData[id][rep] - grandMean, 2);
    });
  });
  
  // í”¼í—˜ìê°„ ì œê³±í•©
  subjMeans.forEach(subjMean => {
    SSSubjects += k * Math.pow(subjMean - grandMean, 2);
  });
  
  // ì¡°ê±´ê°„ ì œê³±í•©
  means.forEach(condMean => {
    SSConditions += n * Math.pow(condMean - grandMean, 2);
  });
  
  // ì˜¤ì°¨ ì œê³±í•©
  const SSError = SSTotal - SSSubjects - SSConditions;
  
  // ììœ ë„
  const dfConditions = k - 1;
  const dfSubjects = n - 1;
  const dfError = dfConditions * dfSubjects;
  const dfTotal = n * k - 1;
  
  // êµ¬í˜•ì„± êµì •ëœ ììœ ë„
  const dfConditions_GG = dfConditions * epsilonGG;
  const dfError_GG = dfError * epsilonGG;
  const dfConditions_HF = dfConditions * epsilonHF;
  const dfError_HF = dfError * epsilonHF;
  
  // í‰ê· ì œê³±
  const MSConditions = SSConditions / dfConditions;
  const MSError = SSError / dfError;
  
  // Fê°’
  const F = MSConditions / MSError;
  
  // íš¨ê³¼í¬ê¸° (partial eta squared)
  const etaSquared = SSConditions / (SSConditions + SSError);
  
  // ê°€ìƒì˜ pê°’ë“¤
  const pValue_uncorrected = F > 3.0 ? "< 0.05" : "> 0.05";
  const pValue_GG = F > (3.0 / epsilonGG) ? "< 0.05" : "> 0.05";
  const pValue_HF = F > (3.0 / epsilonHF) ? "< 0.05" : "> 0.05";
  
  // ê²°ê³¼ í…Œì´ë¸”
  let resultHTML = `
    <div class="result-card">
      <h4>ë°˜ë³µì¸¡ì • ë¶„ì‚°ë¶„ì„ ê²°ê³¼</h4>
      <table>
        <tr><th>ê²€ì • ë°©ë²•</th><th>F</th><th>df1</th><th>df2</th><th>p</th><th>partial Î·Â²</th></tr>
        <tr><td>êµ¬í˜•ì„± ê°€ì • (ë¯¸êµì •)</td><td>${F.toFixed(3)}</td><td>${dfConditions}</td><td>${dfError}</td><td>${pValue_uncorrected}</td><td>${etaSquared.toFixed(3)}</td></tr>`;
  
  if (k > 2) {
    resultHTML += `
        <tr><td>Greenhouse-Geisser</td><td>${F.toFixed(3)}</td><td>${dfConditions_GG.toFixed(2)}</td><td>${dfError_GG.toFixed(2)}</td><td>${pValue_GG}</td><td>${etaSquared.toFixed(3)}</td></tr>
        <tr><td>Huynh-Feldt</td><td>${F.toFixed(3)}</td><td>${dfConditions_HF.toFixed(2)}</td><td>${dfError_HF.toFixed(2)}</td><td>${pValue_HF}</td><td>${etaSquared.toFixed(3)}</td></tr>`;
  }
  
  resultHTML += `
      </table>
    </div>`;
  
  // êµ¬í˜•ì„± ê²€ì • ê²°ê³¼
  if (k > 2) {
    resultHTML += `
      <div class="result-card" style="margin-top:15px;">
        <h4>êµ¬í˜•ì„± ê²€ì •</h4>
        <table>
          <tr><th>ê²€ì •</th><th>ê²°ê³¼</th><th>Epsilon</th><th>ê¶Œì¥ì‚¬í•­</th></tr>
          <tr><td>Mauchly's Test</td><td>${sphericityViolated ? "êµ¬í˜•ì„± ìœ„ë°˜" : "êµ¬í˜•ì„± ë§Œì¡±"}</td><td>-</td><td>-</td></tr>
          <tr><td>Greenhouse-Geisser</td><td>-</td><td>${epsilonGG.toFixed(3)}</td><td>${sphericityViolated ? "ê¶Œì¥" : "ë¶ˆí•„ìš”"}</td></tr>
          <tr><td>Huynh-Feldt</td><td>-</td><td>${epsilonHF.toFixed(3)}</td><td>${sphericityViolated && epsilonHF > 0.75 ? "ê¶Œì¥" : "ë³´ìˆ˜ì "}</td></tr>
        </table>
      </div>`;
  }
  
  // ANOVA í…Œì´ë¸” (ì „í†µì  í˜•ì‹)
  resultHTML += `
    <div class="result-card" style="margin-top:15px;">
      <h4>ë¶„ì‚°ë¶„ì„í‘œ</h4>
      <table>
        <tr><th>ë³€ë™ì›</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p</th></tr>
        <tr><td>ì¡°ê±´ê°„</td><td>${SSConditions.toFixed(3)}</td><td>${dfConditions}</td><td>${MSConditions.toFixed(3)}</td><td>${F.toFixed(3)}</td><td>${pValue_uncorrected}</td></tr>
        <tr><td>í”¼í—˜ìê°„</td><td>${SSSubjects.toFixed(3)}</td><td>${dfSubjects}</td><td>-</td><td>-</td><td>-</td></tr>
        <tr><td>ì˜¤ì°¨</td><td>${SSError.toFixed(3)}</td><td>${dfError}</td><td>${MSError.toFixed(3)}</td><td>-</td><td>-</td></tr>
        <tr><td>ì „ì²´</td><td>${SSTotal.toFixed(3)}</td><td>${dfTotal}</td><td>-</td><td>-</td><td>-</td></tr>
      </table>
    </div>`;
  
  // ê¸°ìˆ í†µê³„ í…Œì´ë¸”
  resultHTML += `
    <div class="result-card" style="margin-top:15px;">
      <h4>ê¸°ìˆ í†µê³„</h4>
      <table>
        <tr><th>ì¡°ê±´</th><th>N</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th></tr>
        ${reps.map((rep, i) => {
          const values = completeSubjs.map(id => subjData[id][rep]);
          const sd = Math.sqrt(variance(values));
          return `<tr><td>${rep}</td><td>${n}</td><td>${means[i].toFixed(2)}</td><td>${sd.toFixed(2)}</td></tr>`;
        }).join('')}
      </table>
    </div>`;
  
  const trace = { x: reps, y: means, mode:"lines+markers", name:"í‰ê· " };
  Plotly.newPlot("plotArea", [trace], {title:"ë°˜ë³µì¸¡ì •: ì¡°ê±´ë³„ í‰ê· "});
  
  // í•´ì„
  const maxMean = Math.max(...means);
  const minMean = Math.min(...means);
  const meanDiff = maxMean - minMean;
  const isSignificant = F > 3.0;
  
  let interpretationHTML = `
    <div class="interpretation-box ${isSignificant ? 'reject' : 'accept'}">
      <h3>ë°˜ë³µì¸¡ì • ë¶„ì„ í•´ì„</h3>
      
      <div class="interpretation-item">
        <strong>ì£¼íš¨ê³¼ ê²€ì •:</strong><br>
        â€¢ ë¯¸êµì • F(${dfConditions}, ${dfError}) = ${F.toFixed(3)}, p ${pValue_uncorrected}<br>`;
  
  if (k > 2) {
    interpretationHTML += `
        â€¢ Greenhouse-Geisser êµì •: F(${dfConditions_GG.toFixed(2)}, ${dfError_GG.toFixed(2)}) = ${F.toFixed(3)}, p ${pValue_GG}<br>
        â€¢ Huynh-Feldt êµì •: F(${dfConditions_HF.toFixed(2)}, ${dfError_HF.toFixed(2)}) = ${F.toFixed(3)}, p ${pValue_HF}`;
  }
  
  interpretationHTML += `
      </div>
      
      <div class="interpretation-item">
        <strong>êµ¬í˜•ì„± ê²€ì • ê²°ê³¼:</strong><br>
        ${k <= 2 ? 
          "2ì¡°ê±´ ë¹„êµì´ë¯€ë¡œ êµ¬í˜•ì„± ê°€ì •ì´ ìë™ìœ¼ë¡œ ë§Œì¡±ë©ë‹ˆë‹¤." :
          sphericityViolated ? 
            `êµ¬í˜•ì„± ê°€ì •ì´ ìœ„ë°˜ë˜ì—ˆìŠµë‹ˆë‹¤ (Îµ_GG = ${epsilonGG.toFixed(3)}). ${epsilonGG < 0.75 ? "Greenhouse-Geisser" : "Huynh-Feldt"} êµì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.` :
            "êµ¬í˜•ì„± ê°€ì •ì´ ë§Œì¡±ë˜ë¯€ë¡œ êµì •ì´ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤."
        }
      </div>
      
      <div class="interpretation-item">
        <strong>ê²°ë¡ :</strong><br>
        ${isSignificant ? "ì¡°ê±´ ê°„ ìœ ì˜í•œ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤" : "ì¡°ê±´ ê°„ ìœ ì˜í•œ ì°¨ì´ê°€ ì—†ìŠµë‹ˆë‹¤"}
        (ìµœê³ : ${maxMean.toFixed(2)}, ìµœì €: ${minMean.toFixed(2)}, ì°¨ì´: ${meanDiff.toFixed(2)})
      </div>
      
      <div class="interpretation-item">
        <strong>íš¨ê³¼í¬ê¸°:</strong> partial Î·Â² = ${etaSquared.toFixed(3)}<br>
        <small>${etaSquared > 0.14 ? "í° íš¨ê³¼" : etaSquared > 0.06 ? "ì¤‘ê°„ íš¨ê³¼" : "ì‘ì€ íš¨ê³¼"}</small>
      </div>
      
      ${isSignificant && k > 2 ? `
      <div class="interpretation-item">
        <strong>ì‚¬í›„ê²€ì • ê¶Œì¥:</strong><br>
        <small>ìœ ì˜í•œ ê²°ê³¼ì´ë¯€ë¡œ Bonferroni ë˜ëŠ” Tukey ì‚¬í›„ê²€ì •ìœ¼ë¡œ ì–´ëŠ ì¡°ê±´ ê°„ì— ì°¨ì´ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</small>
      </div>` : ''}
    </div>`;
  
  document.getElementById("outputArea").innerHTML = resultHTML + interpretationHTML;
  document.getElementById("diagArea").innerHTML = "";
}

/* ---------------- ANCOVA (Type II SS ë°©ì‹) ---------------- */
function runANCOVA(){
  const dep=document.getElementById("dep").value;
  const grp=document.getElementById("grpA").value;
  const cov=document.getElementById("cov").value;

  const rows = data.map(r=>{
    const y=Number(r[dep]); const x=Number(r[cov]); const g = r[grp];
    return (Number.isNaN(y)||Number.isNaN(x))? null : {y, x, g};
  }).filter(Boolean);
  const levels = uniq(rows.map(r=>r.g));
  if(levels.length<2){ alert("ì§‘ë‹¨ ìˆ˜ì¤€ì´ 2ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
  const N = rows.length;

  function designMatrix(rows, withGroup, withX){
    const L = levels.length;
    return rows.map(r=>{
      const row = [1];
      if(withGroup){
        for(let i=0;i<L-1;i++){
          row.push(r.g===levels[i] ? 1 : 0);
        }
      }
      if(withX){ row.push(r.x); }
      return row;
    });
  }
  function transpose(M){ return M[0].map((_,j)=> M.map(row=>row[j])); }
  function matmul(A,B){
    const out = Array(A.length).fill(0).map(()=> Array(B[0].length).fill(0));
    for(let i=0;i<A.length;i++){
      for(let k=0;k<B.length;k++){
        const aik=A[i][k];
        for(let j=0;j<B[0].length;j++){
          out[i][j]+=aik*B[k][j];
        }
      }
    }
    return out;
  }
  function invSymmetric(M){
    const n=M.length;
    const A=M.map((row,i)=> row.concat(...Array.from({length:n},(_,j)=> i===j?1:0 )));
    for(let i=0;i<n;i++){
      let piv = A[i][i];
      if(Math.abs(piv)<1e-12){
        for(let r=i+1;r<n;r++){
          if(Math.abs(A[r][i])>1e-12){ const tmp=A[i]; A[i]=A[r]; A[r]=tmp; piv=A[i][i]; break; }
        }
      }
      for(let j=0;j<2*n;j++) A[i][j]/=piv;
      for(let r=0;r<n;r++){
        if(r===i) continue;
        const f=A[r][i];
        for(let j=0;j<2*n;j++) A[r][j]-=f*A[i][j];
      }
    }
    return A.map(row=> row.slice(n));
  }
  function SSE(rows, X){
    const y = rows.map(r=>[r.y]);
    const Xt = transpose(X);
    const XtX = matmul(Xt, X);
    const XtXinv = invSymmetric(XtX);
    const beta = matmul( matmul(XtXinv, Xt), y );
    const yhat = matmul(X, beta);
    let sse=0, resid=[];
    for(let i=0;i<rows.length;i++){
      const e = y[i][0] - yhat[i][0];
      resid.push(e);
      sse += e*e;
    }
    return {sse, resid, yhat: yhat.map(v=>v[0])};
  }

  const X_full = designMatrix(rows, true, true);
  const X_red_group = designMatrix(rows, false, true);
  const X_red_cov   = designMatrix(rows, true, false);

  const full = SSE(rows, X_full);
  const redG = SSE(rows, X_red_group);
  const redX = SSE(rows, X_red_cov);

  const SS_group = redG.sse - full.sse;
  const SS_cov   = redX.sse - full.sse;
  const SS_err   = full.sse;
  const ybar = mean(rows.map(r=>r.y));
  const SS_tot = rows.reduce((s,r)=> s + Math.pow(r.y - ybar,2), 0);

  const df_group = levels.length - 1;
  const df_cov   = 1;
  const p_full   = 1 + df_group + 1;
  const df_err   = N - p_full;

  const MS_group = SS_group/df_group;
  const MS_cov   = SS_cov/df_cov;
  const MS_err   = SS_err/df_err;

  const F_group = MS_group/MS_err;
  const F_cov   = MS_cov/MS_err;

  const etap_group = SS_group / (SS_group + SS_err);
  const etap_cov   = SS_cov / (SS_cov + SS_err);

  // ANCOVA í•´ì„ ì¶”ê°€
  const effectGroup = interpretEffectSize(etap_group);
  const effectCov = interpretEffectSize(etap_cov);
  
  const fInterpretGroup = interpretFValue(F_group);
  const fInterpretCov = interpretFValue(F_cov);
  
  // ê³µë³€ëŸ‰ê³¼ ì¢…ì†ë³€ìˆ˜ì˜ ìƒê´€ê´€ê³„ ê³„ì‚°
  const xbar_cov = mean(rows.map(r=>r.x));
  const ybar_cov = mean(rows.map(r=>r.y));
  const correlation = rows.reduce((s,r)=> s + (r.x-xbar_cov)*(r.y-ybar_cov), 0) / 
                     Math.sqrt(rows.reduce((s,r)=> s + Math.pow(r.x-xbar_cov,2), 0) * 
                              rows.reduce((s,r)=> s + Math.pow(r.y-ybar_cov,2), 0));
  
  let interpretationHTML = `
    <div class="interpretation-card">
      <h4>ğŸ“ ANCOVA ë¶„ì„ ê²°ê³¼ í•´ì„</h4>
      
      <div class="interpretation-item ${F_group > 2.5 ? 'significant' : 'not-significant'}">
        <strong>${grp} íš¨ê³¼ (ê³µë³€ëŸ‰ í†µì œ í›„):</strong> F(${df_group}, ${df_err}) = ${F_group.toFixed(3)}
        <span class="effect-size ${effectGroup.class}">${effectGroup.level}</span>
        <br><small>${fInterpretGroup} - ê³µë³€ëŸ‰ì„ í†µì œí•œ í›„ì—ë„ ì§‘ë‹¨ ê°„ ì°¨ì´ê°€ ${F_group > 2.5 ? "ì¡´ì¬í•©ë‹ˆë‹¤" : "ì—†ìŠµë‹ˆë‹¤"}</small>
      </div>
      
      <div class="interpretation-item ${F_cov > 2.5 ? 'significant' : 'not-significant'}">
        <strong>${cov} íš¨ê³¼ (ê³µë³€ëŸ‰):</strong> F(${df_cov}, ${df_err}) = ${F_cov.toFixed(3)}
        <span class="effect-size ${effectCov.class}">${effectCov.level}</span>
        <br><small>ìƒê´€ê³„ìˆ˜: r = ${correlation.toFixed(3)} - ê³µë³€ëŸ‰ì´ ì¢…ì†ë³€ìˆ˜ë¥¼ ${F_cov > 2.5 ? "ì˜ ì˜ˆì¸¡í•©ë‹ˆë‹¤" : "ì˜ ì˜ˆì¸¡í•˜ì§€ ëª»í•©ë‹ˆë‹¤"}</small>
      </div>
      
      <div class="interpretation-item">
        <strong>ANCOVAì˜ ì¥ì :</strong><br>
        â€¢ ê³µë³€ëŸ‰(${cov})ì˜ ì˜í–¥ì„ í†µì œí•˜ì—¬ ë” ì •í™•í•œ ì§‘ë‹¨ ë¹„êµ<br>
        â€¢ ì˜¤ì°¨ ë¶„ì‚° ê°ì†Œë¡œ í†µê³„ì  ê²€ì •ë ¥ í–¥ìƒ<br>
        â€¢ íš¨ê³¼í¬ê¸°: ì§‘ë‹¨ Î·Â²=${etap_group.toFixed(3)}, ê³µë³€ëŸ‰ Î·Â²=${etap_cov.toFixed(3)}
      </div>
      
      <div class="interpretation-item ${correlation > 0.3 ? 'significant' : correlation > 0.1 ? '' : 'warning'}">
        <strong>ê³µë³€ëŸ‰ ì ì ˆì„±:</strong><br>
        ${Math.abs(correlation) > 0.3 ? "âœ“ ê³µë³€ëŸ‰ê³¼ ì¢…ì†ë³€ìˆ˜ ê°„ ì¶©ë¶„í•œ ìƒê´€ê´€ê³„" : 
          Math.abs(correlation) > 0.1 ? "â–³ ê³µë³€ëŸ‰ê³¼ ì¢…ì†ë³€ìˆ˜ ê°„ ì•½í•œ ìƒê´€ê´€ê³„" : 
          "âš ï¸ ê³µë³€ëŸ‰ê³¼ ì¢…ì†ë³€ìˆ˜ ê°„ ìƒê´€ê´€ê³„ê°€ ì•½í•¨ - ANCOVAì˜ íš¨ê³¼ ì œí•œì "}
      </div>
    </div>`;

  document.getElementById("outputArea").innerHTML = `
    <div class="result-card">
      <h4>ANCOVA (${grp}, ${cov} â†’ ${dep})</h4>
      <table>
        <tr><th>íš¨ê³¼</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p</th><th>partial Î·Â²</th></tr>
        <tr><td>${grp}</td><td>${SS_group.toFixed(3)}</td><td>${df_group}</td><td>${MS_group.toFixed(3)}</td><td>${F_group.toFixed(3)}</td><td>-</td><td>${etap_group.toFixed(3)}</td></tr>
        <tr><td>${cov}</td><td>${SS_cov.toFixed(3)}</td><td>${df_cov}</td><td>${MS_cov.toFixed(3)}</td><td>${F_cov.toFixed(3)}</td><td>-</td><td>${etap_cov.toFixed(3)}</td></tr>
        <tr><td>ì˜¤ì°¨</td><td>${SS_err.toFixed(3)}</td><td>${df_err}</td><td>${MS_err.toFixed(3)}</td><td>-</td><td>-</td><td>-</td></tr>
        <tr><td>Total</td><td>${SS_tot.toFixed(3)}</td><td>${N-1}</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
      </table>
      <div class="muted">â€» ë™ì§ˆ ê¸°ìš¸ê¸° ê°€ì •(ì§‘ë‹¨Ã—ê³µë³€ëŸ‰ ìƒí˜¸ì‘ìš© ì—†ìŒ)</div>
    </div>
    ${interpretationHTML}`;

  const traces = [];
  const xall = rows.map(r=>r.x), yall = rows.map(r=>r.y);
  const xbar_plot = mean(xall), ybar_plot = mean(yall);
  const b = rows.reduce((s,r)=> s + (r.x-xbar_plot)*(r.y-ybar_plot), 0) / rows.reduce((s,r)=> s + Math.pow(r.x-xbar_plot,2), 0);

  levels.forEach(lvl=>{
    const pts = rows.filter(r=>r.g===lvl);
    const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
    traces.push({x: xs, y: ys, mode:"markers", name: `${grp}:${lvl}`});
    const xm = mean(xs), ym=mean(ys);
    const a = ym - b*xm;
    const minx = Math.min(...xs), maxx = Math.max(...xs);
    traces.push({x:[minx,maxx], y:[a+b*minx, a+b*maxx], mode:"lines", name:`${lvl} íšŒê·€ì„ `});
  });
  Plotly.newPlot("plotArea", traces, {title:`ANCOVA íšŒê·€ì„  (${cov} vs ${dep})`, xaxis:{title:cov}, yaxis:{title:dep}});

  if(document.getElementById("doDiag").checked){
    let diagInterpretation = `
      <div class="interpretation-card">
        <h4>ğŸ”¬ ANCOVA ê°€ì • ê²€í† </h4>
        <div class="interpretation-item">
          <strong>ì •ê·œì„±:</strong><br>
          <small>ì”ì°¨ íˆìŠ¤í† ê·¸ë¨ì´ ì •ê·œë¶„í¬ë¥¼ ë”°ë¥´ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</small>
        </div>
        <div class="interpretation-item">
          <strong>ì„ í˜•ì„±:</strong><br>
          <small>ì‚°ì ë„ì—ì„œ ê³µë³€ëŸ‰ê³¼ ì¢…ì†ë³€ìˆ˜ ê°„ì˜ ì„ í˜• ê´€ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
        </div>
        <div class="interpretation-item">
          <strong>ë™ì§ˆì„± ê°€ì •:</strong><br>
          <small>â€¢ ë“±ë¶„ì‚°ì„±: ê° ì§‘ë‹¨ì˜ ì”ì°¨ ë¶„ì‚°ì´ ë™ì¼í•´ì•¼ í•¨<br>
          â€¢ íšŒê·€ ê¸°ìš¸ê¸° ë™ì§ˆì„±: ê° ì§‘ë‹¨ì˜ íšŒê·€ì„ ì´ í‰í–‰í•´ì•¼ í•¨</small>
        </div>
        <div class="interpretation-item warning">
          <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
          <small>ê³µë³€ëŸ‰ì€ ì²˜ì¹˜ ì „ì— ì¸¡ì •ë˜ì–´ì•¼ í•˜ë©°, ì²˜ì¹˜ì— ì˜í•´ ì˜í–¥ë°›ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.</small>
        </div>
      </div>`;
    
    const hist = { x: full.resid, type:"histogram", nbinsx: Math.min(30, Math.max(10, Math.floor(Math.sqrt(full.resid.length)))) };
    document.getElementById("diagArea").innerHTML = `
      <div class="panel">
        <h3>ì§„ë‹¨</h3>
        <div id="hist3"></div>
        ${diagInterpretation}
      </div>`;
    Plotly.newPlot("hist3", [hist], {title:"ì”ì°¨ íˆìŠ¤í† ê·¸ë¨ (ANCOVA)"});
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ - íŒŒì¼ ì…ë ¥ë§Œ ë”°ë¡œ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById("fileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        data = parseCSV(evt.target.result);
        showDataPreview(data);
        renderVarSelectors();
      } catch (error) {
        alert("íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: " + error.message);
      }
    };
    reader.readAsText(file, "utf-8");
  });
});
</script>

</body>
</html>
