<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>í†µê³„ë¶„ì„ ì¢…í•©ë„êµ¬</title>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ml-matrix/6.10.4/ml-matrix.min.js"></script>

<style>
  :root{
    --bg:#f4f5f7; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --success:#059669;
    --shadow:0 8px 30px rgba(16,24,40,0.06); --warning:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{font-family:"Inter","Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111827;padding:24px;display:flex;gap:20px;min-height:100vh}
  .sidebar{width:280px;background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);height:fit-content;position:sticky;top:24px}
  .sidebar h2{text-align:center;margin-bottom:15px;font-size:18px}
  .menu-category{margin-bottom:20px}
  .menu-category-title{font-size:14px;font-weight:600;color:var(--muted);margin-bottom:8px;padding:0 12px}
  .menu-item{display:block;padding:10px 12px;border-radius:12px;color:#374151;margin-bottom:4px;cursor:pointer;transition:all .18s ease;font-size:14px}
  .menu-item.active{background:var(--accent);color:white;font-weight:600;box-shadow:0 6px 18px rgba(37,99,235,0.14)}
  .menu-item:hover:not(.active){background:#f3f4f6}
  .main{flex:1;display:flex;flex-direction:column;gap:16px}
  .panel{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .analysis-section{display:none}
  .analysis-section.active{display:block}
  h1{margin:0;font-size:22px}
  h3{margin:0 0 15px 0;font-size:16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all .15s ease}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:#1d4ed8}
  .btn.success{background:var(--success);color:#fff}
  .btn.success:hover{background:#047857}
  .btn.warning{background:var(--warning);color:#fff}
  .btn.warning:hover{background:#d97706}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.danger:hover{background:#dc2626}
  .btn.ghost{background:#f3f4f6;color:#111827}
  .btn.ghost:hover{background:#e5e7eb}
  select,input[type="file"],input[type="number"],input[type="text"]{padding:8px 12px;border-radius:8px;border:1px solid #d1d5db;margin-top:8px;font-size:14px}
  input[type="file"]{width:auto}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th{background:#f9fafb;padding:10px 8px;border-bottom:2px solid #e5e7eb;text-align:center;font-weight:600}
  td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .resultCard{margin-top:20px;padding:18px;background:#fafbfc;border-radius:12px;border:1px solid #f1f3f4}
  .graphRow{display:flex;gap:20px;margin-top:15px}
  .graphCell{flex:1}
  .section{margin-bottom:15px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .var-select{width:240px;margin-top:6px;min-height:120px}
  .interpretation{background:#f8fafc;border-left:4px solid #64748b;padding:18px;margin-top:20px;border-radius:8px;border:1px solid #e2e8f0}
  .interpretation h4{margin:0 0 12px 0;color:#334155;font-size:16px}
  .status-badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
  .status-success{background:#d1fae5;color:#065f46}
  .status-warning{background:#fef3c7;color:#92400e}
  .status-danger{background:#fee2e2;color:#991b1b}
  .data-info{background:#f0f9ff;padding:12px;border-radius:8px;margin:10px 0;border:1px solid #e0f2fe}
  .variable-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .variable-tag{background:#e5e7eb;padding:4px 8px;border-radius:6px;font-size:12px}
  .test-result{background:#f8fafc;border:1px solid #e2e8f0;padding:15px;border-radius:8px;margin:10px 0}
  .p-value{font-weight:bold}
  .p-value.significant{color:var(--danger)}
  .p-value.not-significant{color:var(--muted)}
</style>
</head>
<body>

  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <h2>ğŸ“Š ë¶„ì„ ë©”ë‰´</h2>
    <div id="menuList">
      <div class="menu-category">ë°ì´í„° íƒìƒ‰</div>
      <div class="menu-item" data-target="stats.html">ê¸°ìˆ í†µê³„</div>

      <div class="menu-category">ì§‘ë‹¨ ê°„ ì°¨ì´ ê²€ì •</div>
      <div class="menu-item" data-target="t_test.html">t-ê²€ì • (ë…ë¦½/ëŒ€ì‘)</div>
      <div class="menu-item active" data-target="chisquare.html">ì¹´ì´ì œê³± ê²€ì •</div>
      <div class="menu-item" data-target="main-nonparam">ë¹„ëª¨ìˆ˜ ê²€ì •</div>
      <div class="menu-item" data-target="main-anova">ë¶„ì‚°ë¶„ì„ (ANOVA)</div>

      <div class="menu-category">ë³€ìˆ˜ ê°„ ê´€ê³„ ë¶„ì„</div>
      <div class="menu-item" data-target="main-corr">ìƒê´€ë¶„ì„</div>
      <div class="menu-item" data-target="main-reg">íšŒê·€ë¶„ì„</div>
      <div class="menu-item" data-target="main-probit">í”„ë¡œë¹—ë¶„ì„</div>
      <div class="menu-item" data-target="main-mediation">ë§¤ê°œíš¨ê³¼</div>
      <div class="menu-item" data-target="main-moderation">ì¡°ì ˆíš¨ê³¼</div>
      <div class="menu-item" data-target="main-discriminant">íŒë³„ë¶„ì„</div>
      <div class="menu-item" data-target="main-sem">SEM (êµ¬ì¡°ë°©ì •ì‹ ëª¨í˜•)</div>

      <div class="menu-category">ì°¨ì› ì¶•ì†Œ / êµ°ì§‘í™”</div>
      <div class="menu-item" data-target="main-pca">PCA</div>
      <div class="menu-item" data-target="main-efa">íƒìƒ‰ì  ìš”ì¸ë¶„ì„ (EFA)</div>
      <div class="menu-item" data-target="main-cfa">í™•ì¸ì  ìš”ì¸ë¶„ì„ (CFA)</div>
      <div class="menu-item" data-target="main-cluster">êµ°ì§‘ë¶„ì„</div>
    </div>
  </div>

  

  <div class="main">
    <!-- ê³µí†µ ë°ì´í„° ì—…ë¡œë“œ íŒ¨ë„ -->
    <div class="panel">
      <h1 id="mainTitle">ğŸ“Š ê¸°ìˆ í†µê³„</h1>
      <div class="muted" id="mainDescription">CSV ì—…ë¡œë“œ â†’ ë³€ìˆ˜ ì„ íƒ â†’ ë¶„ì„ ì‹¤í–‰</div>
      
      <div class="section" style="margin-top:15px">
        <div class="inline">
          <input id="file" type="file" accept=".csv">
          <button id="loadExample" class="btn success">ì˜ˆì œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="clearData" class="btn ghost">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
        
        <div id="dataInfo" class="data-info" style="display:none">
          <strong>ë°ì´í„° ì •ë³´:</strong>
          <div id="dataDetails"></div>
        </div>
      </div>
    </div>

    <!-- ê¸°ìˆ í†µê³„ ì„¹ì…˜ -->
    <div id="descriptiveSection" class="analysis-section active">
      <div class="panel">
        <h3>ë³€ìˆ˜ ì„ íƒ</h3>
        <div id="descriptiveVarPanel" style="display:none">
          <div style="margin-bottom:15px">
            <strong>ìˆ˜ì¹˜í˜• ë³€ìˆ˜ ì„ íƒ:</strong><br>
            <select id="descriptiveNumSelect" multiple size="6" class="var-select"></select>
          </div>
          <div style="margin-bottom:15px">
            <strong>ë²”ì£¼í˜• ë³€ìˆ˜ ì„ íƒ:</strong><br>
            <select id="descriptiveCatSelect" multiple size="6" class="var-select"></select>
          </div>
          <button id="runDescriptive" class="btn primary">ë¶„ì„ ì‹¤í–‰</button>
        </div>
      </div>

      <div class="panel" id="descriptiveResultPanel" style="display:none">
        <h3>ë¶„ì„ ê²°ê³¼</h3>
        <div id="descriptiveResults"></div>
      </div>

      <div class="panel" id="descriptiveInterpretationPanel" style="display:none">
        <h3>ê²°ê³¼ í•´ì„</h3>
        <div id="descriptiveInterpretation"></div>
      </div>
    </div>

    <!-- T-ê²€ì • ì„¹ì…˜ -->
    <div id="ttestSection" class="analysis-section">
      <div class="panel">
        <h3>T-ê²€ì • ì„¤ì •</h3>
        <div id="ttestVarPanel" style="display:none">
          <div class="section">
            <strong>ê²€ì • ìœ í˜•:</strong><br>
            <select id="ttestType" style="width:200px">
              <option value="onesample">ì¼í‘œë³¸ t-ê²€ì •</option>
              <option value="twosample">ë…ë¦½í‘œë³¸ t-ê²€ì •</option>
              <option value="paired">ëŒ€ì‘í‘œë³¸ t-ê²€ì •</option>
            </select>
          </div>
          
          <div class="section" id="ttestVarSelection">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ë³€ìˆ˜ ì„ íƒ ì˜ì—­ -->
          </div>
          
          <button id="runTtest" class="btn primary">ê²€ì • ì‹¤í–‰</button>
        </div>
      </div>

      <div class="panel" id="ttestResultPanel" style="display:none">
        <h3>T-ê²€ì • ê²°ê³¼</h3>
        <div id="ttestResults"></div>
      </div>
    </div>

    <!-- ë‹¤ë¥¸ ë¶„ì„ ì„¹ì…˜ë“¤ì€ í•„ìš”ì‹œ ì¶”ê°€ -->
    <div id="chisquareSection" class="analysis-section">
      <div class="panel">
        <h3>ì¹´ì´ì œê³±ê²€ì •</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="nonparametricSection" class="analysis-section">
      <div class="panel">
        <h3>ë¹„ëª¨ìˆ˜ê²€ì •</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="anovaSection" class="analysis-section">
      <div class="panel">
        <h3>ë¶„ì‚°ë¶„ì„(ANOVA)</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="regressionSection" class="analysis-section">
      <div class="panel">
        <h3>ë‹¨ìˆœÂ·ë‹¤ì¤‘íšŒê·€</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="logisticSection" class="analysis-section">
      <div class="panel">
        <h3>ë¡œì§€ìŠ¤í‹±íšŒê·€</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="probitSection" class="analysis-section">
      <div class="panel">
        <h3>í”„ë¡œë¹—ëª¨í˜•</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="factorSection" class="analysis-section">
      <div class="panel">
        <h3>ìš”ì¸ë¶„ì„</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="pcaSection" class="analysis-section">
      <div class="panel">
        <h3>ì£¼ì„±ë¶„ë¶„ì„(PCA)</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="clusterSection" class="analysis-section">
      <div class="panel">
        <h3>êµ°ì§‘ë¶„ì„</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <div id="discriminantSection" class="analysis-section">
      <div class="panel">
        <h3>íŒë³„ë¶„ì„</h3>
        <div class="muted">ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>
  </div>

<script>
// ì „ì—­ ë³€ìˆ˜
let parsedData = null;
let currentAnalysis = 'descriptive';
let analysisResults = {};

// ë©”ë‰´ ì‹œìŠ¤í…œ
const menuConfig = {
  descriptive: { title: 'ğŸ“Š ê¸°ìˆ í†µê³„', desc: 'CSV ì—…ë¡œë“œ â†’ ë³€ìˆ˜ ì„ íƒ â†’ ë¶„ì„ ì‹¤í–‰' },
  ttest: { title: 'ğŸ” T-ê²€ì •', desc: 'í‰ê·  ì°¨ì´ ê²€ì • (ì¼í‘œë³¸, ë…ë¦½í‘œë³¸, ëŒ€ì‘í‘œë³¸)' },
  chisquare: { title: 'ğŸ¯ ì¹´ì´ì œê³±ê²€ì •', desc: 'ë²”ì£¼í˜• ë³€ìˆ˜ ê°„ì˜ ë…ë¦½ì„± ê²€ì •' },
  nonparametric: { title: 'ğŸ“ˆ ë¹„ëª¨ìˆ˜ê²€ì •', desc: 'ë¶„í¬ë¥¼ ê°€ì •í•˜ì§€ ì•ŠëŠ” ê²€ì •' },
  anova: { title: 'ğŸ“Š ë¶„ì‚°ë¶„ì„(ANOVA)', desc: 'ì—¬ëŸ¬ ì§‘ë‹¨ ê°„ì˜ í‰ê·  ë¹„êµ' },
  regression: { title: 'ğŸ“ˆ ë‹¨ìˆœÂ·ë‹¤ì¤‘íšŒê·€', desc: 'ì—°ì†í˜• ì¢…ì†ë³€ìˆ˜ ì˜ˆì¸¡ ëª¨ë¸' },
  logistic: { title: 'ğŸ¯ ë¡œì§€ìŠ¤í‹±íšŒê·€', desc: 'ì´í•­ ì¢…ì†ë³€ìˆ˜ ì˜ˆì¸¡ ëª¨ë¸' },
  probit: { title: 'ğŸ“Š í”„ë¡œë¹—ëª¨í˜•', desc: 'ì´í•­ ì¢…ì†ë³€ìˆ˜ì˜ ë˜ ë‹¤ë¥¸ ì˜ˆì¸¡ ëª¨ë¸' },
  factor: { title: 'ğŸ” ìš”ì¸ë¶„ì„', desc: 'ì ì¬ ìš”ì¸ ë°œê²¬ ë° ì°¨ì› ì¶•ì†Œ' },
  pca: { title: 'ğŸ“Š ì£¼ì„±ë¶„ë¶„ì„(PCA)', desc: 'ì°¨ì› ì¶•ì†Œ ë° ì£¼ì„±ë¶„ ì¶”ì¶œ' },
  cluster: { title: 'ğŸ¯ êµ°ì§‘ë¶„ì„', desc: 'ìœ ì‚¬í•œ ê´€ì¸¡ì¹˜ë“¤ì„ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜' },
  discriminant: { title: 'ğŸ“ˆ íŒë³„ë¶„ì„', desc: 'ì§‘ë‹¨ ë¶„ë¥˜ ë° íŒë³„ í•¨ìˆ˜ ë„ì¶œ' }
};

// ë©”ë‰´ ì´ë²¤íŠ¸ ì²˜ë¦¬
document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', function() {
    const section = this.dataset.section;
    if (!section) return;
    
    // ë©”ë‰´ í™œì„±í™” ìƒíƒœ ë³€ê²½
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    this.classList.add('active');
    
    // ì„¹ì…˜ ë³€ê²½
    document.querySelectorAll('.analysis-section').forEach(s => s.classList.remove('active'));
    document.getElementById(section + 'Section').classList.add('active');
    
    // ì œëª©ê³¼ ì„¤ëª… ë³€ê²½
    const config = menuConfig[section];
    document.getElementById('mainTitle').textContent = config.title;
    document.getElementById('mainDescription').textContent = config.desc;
    
    currentAnalysis = section;
    
    // ë°ì´í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì„¹ì…˜ì˜ ë³€ìˆ˜ ì„ íƒ íŒ¨ë„ í‘œì‹œ
    if (parsedData) {
      showVariableSelection(section);
    }
  });
});

// ê³µí†µ í•¨ìˆ˜ë“¤
function parseCSV(text) {
  const {data, errors} = Papa.parse(text.trim(), {
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true
  });
  
  if (errors && errors.length) throw new Error('CSV íŒŒì‹± ì˜¤ë¥˜: ' + errors[0].message);
  if (!data.length) throw new Error('ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.');

  const headers = Object.keys(data[0]);
  const numericCols = headers.filter(h => 
    data.every(row => row[h] !== null && row[h] !== "" && !isNaN(row[h]))
  );
  const categoricalCols = headers.filter(h => !numericCols.includes(h));

  return {
    raw: data,
    headers: headers,
    numericCols: numericCols,
    categoricalCols: categoricalCols,
    rowCount: data.length
  };
}

function showDataInfo() {
  if (!parsedData) return;
  
  const info = `
    <strong>í–‰ ìˆ˜:</strong> ${parsedData.rowCount} | 
    <strong>ì—´ ìˆ˜:</strong> ${parsedData.headers.length}<br>
    <strong>ìˆ˜ì¹˜í˜• ë³€ìˆ˜ (${parsedData.numericCols.length}):</strong> 
    <div class="variable-list">
      ${parsedData.numericCols.map(col => `<span class="variable-tag">${col}</span>`).join('')}
    </div>
    <strong>ë²”ì£¼í˜• ë³€ìˆ˜ (${parsedData.categoricalCols.length}):</strong>
    <div class="variable-list">
      ${parsedData.categoricalCols.map(col => `<span class="variable-tag">${col}</span>`).join('')}
    </div>
  `;
  
  document.getElementById('dataDetails').innerHTML = info;
  document.getElementById('dataInfo').style.display = 'block';
}

function showVariableSelection(section) {
  if (!parsedData) return;
  
  if (section === 'descriptive') {
    updateDescriptiveVariables();
    document.getElementById('descriptiveVarPanel').style.display = 'block';
  } else if (section === 'ttest') {
    updateTtestVariables();
    document.getElementById('ttestVarPanel').style.display = 'block';
  }
  // ë‹¤ë¥¸ ë¶„ì„ë“¤ë„ í•„ìš”ì‹œ ì¶”ê°€
}

// ê¸°ìˆ í†µê³„ ê´€ë ¨ í•¨ìˆ˜ë“¤
function updateDescriptiveVariables() {
  const numSelect = document.getElementById("descriptiveNumSelect");
  numSelect.innerHTML = "";
  parsedData.numericCols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c; opt.selected = true;
    numSelect.appendChild(opt);
  });

  const catSelect = document.getElementById("descriptiveCatSelect");
  catSelect.innerHTML = "";
  parsedData.categoricalCols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    catSelect.appendChild(opt);
  });
}

// í†µê³„ í•¨ìˆ˜ë“¤
function mean(arr) { return arr.reduce((a,b) => a+b, 0) / arr.length; }
function median(arr) {
  const s = [...arr].sort((a,b) => a-b);
  const m = Math.floor(s.length/2);
  return s.length % 2 ? s[m] : (s[m-1] + s[m]) / 2;
}
function variance(arr) {
  const m = mean(arr);
  return mean(arr.map(x => (x-m)**2));
}
function stddev(arr) { return Math.sqrt(variance(arr)); }
function q1(arr) { return jStat.percentile([...arr].sort((a,b) => a-b), 0.25); }
function q3(arr) { return jStat.percentile([...arr].sort((a,b) => a-b), 0.75); }
function skewness(arr) { return jStat.skewness(arr); }
function kurtosis(arr) { return jStat.kurtosis(arr); }

function renderNumeric(col) {
  const arr = parsedData.raw.map(r => +r[col]).filter(v => !isNaN(v));
  if (arr.length === 0) return "";
  
  const n = arr.length;
  const miss = parsedData.rowCount - n;
  const m = mean(arr), md = median(arr), v = variance(arr), sd = stddev(arr);
  const mn = Math.min(...arr), mx = Math.max(...arr);
  const q_1 = q1(arr), q_3 = q3(arr), iqr = q_3 - q_1;
  const sk = skewness(arr), kt = kurtosis(arr);

  // ê²°ê³¼ ì €ì¥
  if (!analysisResults.numeric) analysisResults.numeric = {};
  analysisResults.numeric[col] = {
    n, miss, mean: m, median: md, variance: v, stddev: sd, 
    min: mn, max: mx, q1: q_1, q3: q_3, iqr, skewness: sk, kurtosis: kt
  };

  let html = `<div class='resultCard'><h4>ìˆ˜ì¹˜í˜• ë³€ìˆ˜: ${col}</h4>`;
  html += `<table><thead><tr><th>N</th><th>ê²°ì¸¡</th><th>í‰ê· </th><th>ì¤‘ì•™ê°’</th><th>ìµœì†Œ</th><th>ìµœëŒ€</th><th>í‘œì¤€í¸ì°¨</th><th>ë¶„ì‚°</th><th>Q1</th><th>Q3</th><th>IQR</th><th>ì™œë„</th><th>ì²¨ë„</th></tr></thead>`;
  html += `<tbody><tr><td>${n}</td><td>${miss}</td><td>${m.toFixed(4)}</td><td>${md.toFixed(4)}</td><td>${mn}</td><td>${mx}</td><td>${sd.toFixed(4)}</td><td>${v.toFixed(4)}</td><td>${q_1.toFixed(4)}</td><td>${q_3.toFixed(4)}</td><td>${iqr.toFixed(4)}</td><td>${sk.toFixed(4)}</td><td>${kt.toFixed(4)}</td></tr></tbody></table>`;

  const divId1 = `hist_${col}_desc`;
  const divId2 = `box_${col}_desc`;
  html += `<div class='graphRow'><div class='graphCell'><div id='${divId1}' style='height:300px'></div></div><div class='graphCell'><div id='${divId2}' style='height:300px'></div></div></div>`;
  html += `</div>`;

  setTimeout(() => {
    Plotly.newPlot(divId1, [{x: arr, type: "histogram", name: col}], {
      title: `${col} íˆìŠ¤í† ê·¸ë¨`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
    Plotly.newPlot(divId2, [{y: arr, type: "box", boxpoints: 'outliers', name: col}], {
      title: `${col} ë°•ìŠ¤í”Œë¡¯`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
  }, 100);

  return html;
}

function renderCategorical(col) {
  const vals = parsedData.raw.map(r => r[col]).filter(v => v !== null && v !== "");
  const freq = {};
  vals.forEach(v => { freq[v] = (freq[v] || 0) + 1; });
  const total = vals.length;
  const rows = Object.entries(freq).map(([k,v]) => ({cat: k, f: v, pct: v/total*100})).sort((a,b) => b.f - a.f);
  let cum = 0;

  // ê²°ê³¼ ì €ì¥
  if (!analysisResults.categorical) analysisResults.categorical = {};
  analysisResults.categorical[col] = {
    total: total,
    categories: rows.length,
    frequencies: freq,
    mostFrequent: rows[0]
  };

  let html = `<div class='resultCard'><h4>ë²”ì£¼í˜• ë³€ìˆ˜: ${col}</h4>`;
  html += `<table><thead><tr><th>ê°’</th><th>ë¹ˆë„</th><th>%</th><th>ëˆ„ì  %</th></tr></thead><tbody>`;
  rows.forEach(r => {
    cum += r.pct;
    html += `<tr><td>${r.cat}</td><td>${r.f}</td><td>${r.pct.toFixed(2)}</td><td>${cum.toFixed(2)}</td></tr>`;
  });
  html += `</tbody></table>`;

  const divId = `bar_${col}_desc`;
  html += `<div class='graphRow'><div class='graphCell'><div id='${divId}' style='height:300px'></div></div><div class='graphCell'></div></div>`;
  html += `</div>`;

  setTimeout(() => {
    Plotly.newPlot(divId, [{
      x: rows.map(r => r.cat), 
      y: rows.map(r => r.f), 
      type: 'bar',
      name: col
    }], {
      title: `${col} ë§‰ëŒ€ê·¸ë˜í”„`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
  }, 100);

  return html;
}

function generateDescriptiveInterpretation() {
  if (!analysisResults) return;

  let html = '';

  // ìˆ˜ì¹˜í˜• ë³€ìˆ˜ í•´ì„
  if (analysisResults.numeric) {
    html += '<div class="interpretation">';
    html += '<h4>ğŸ”¢ ìˆ˜ì¹˜í˜• ë³€ìˆ˜ ë¶„ì„ í•´ì„</h4>';
    
    Object.entries(analysisResults.numeric).forEach(([col, stats]) => {
      html += `<div style="margin-bottom:20px;"><strong>${col}:</strong><br>`;
      
      // ì¤‘ì‹¬ê²½í–¥ì„± í•´ì„
      const meanMedianDiff = Math.abs(stats.mean - stats.median);
      const relativeDiff = meanMedianDiff / stats.stddev;
      
      if (relativeDiff < 0.1) {
        html += `â€¢ í‰ê· (${stats.mean.toFixed(2)})ê³¼ ì¤‘ì•™ê°’(${stats.median.toFixed(2)})ì´ ê±°ì˜ ê°™ì•„ <strong>ëŒ€ì¹­ì  ë¶„í¬</strong>ë¥¼ ë³´ì…ë‹ˆë‹¤.<br>`;
      } else if (stats.mean > stats.median) {
        html += `â€¢ í‰ê· (${stats.mean.toFixed(2)})ì´ ì¤‘ì•™ê°’(${stats.median.toFixed(2)})ë³´ë‹¤ í¬ë¯€ë¡œ <strong>ìš°ì¸¡ ê¼¬ë¦¬ê°€ ê¸´ ë¶„í¬</strong>ì…ë‹ˆë‹¤.<br>`;
      } else {
        html += `â€¢ í‰ê· (${stats.mean.toFixed(2)})ì´ ì¤‘ì•™ê°’(${stats.median.toFixed(2)})ë³´ë‹¤ ì‘ìœ¼ë¯€ë¡œ <strong>ì¢Œì¸¡ ê¼¬ë¦¬ê°€ ê¸´ ë¶„í¬</strong>ì…ë‹ˆë‹¤.<br>`;
      }

      // ì‚°í¬ë„ í•´ì„
      const cv = stats.stddev / Math.abs(stats.mean) * 100;
      if (cv < 10) {
        html += `â€¢ ë³€ë™ê³„ìˆ˜(${cv.toFixed(1)}%)ê°€ ë‚®ì•„ <strong>ë°ì´í„°ê°€ í‰ê·  ì£¼ìœ„ì— ì§‘ì¤‘</strong>ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>`;
      } else if (cv > 30) {
        html += `â€¢ ë³€ë™ê³„ìˆ˜(${cv.toFixed(1)}%)ê°€ ë†’ì•„ <strong>ë°ì´í„°ì˜ ë³€ë™ì„±ì´ í½ë‹ˆë‹¤</strong>.<br>`;
      } else {
        html += `â€¢ ë³€ë™ê³„ìˆ˜(${cv.toFixed(1)}%)ë¡œ <strong>ì ë‹¹í•œ ìˆ˜ì¤€ì˜ ë³€ë™ì„±</strong>ì„ ë³´ì…ë‹ˆë‹¤.<br>`;
      }

      // ì™œë„ì™€ ì²¨ë„ í•´ì„
      if (Math.abs(stats.skewness) < 0.5) {
        html += `â€¢ ì™œë„(${stats.skewness.toFixed(2)})ê°€ 0ì— ê°€ê¹Œì›Œ <strong>ê±°ì˜ ëŒ€ì¹­ì </strong>ì…ë‹ˆë‹¤.<br>`;
      } else if (stats.skewness > 0) {
        html += `â€¢ ì™œë„(${stats.skewness.toFixed(2)})ê°€ ì–‘ìˆ˜ë¡œ <strong>ìš°ì¸¡ìœ¼ë¡œ ì¹˜ìš°ì¹œ</strong> ë¶„í¬ì…ë‹ˆë‹¤.<br>`;
      } else {
        html += `â€¢ ì™œë„(${stats.skewness.toFixed(2)})ê°€ ìŒìˆ˜ë¡œ <strong>ì¢Œì¸¡ìœ¼ë¡œ ì¹˜ìš°ì¹œ</strong> ë¶„í¬ì…ë‹ˆë‹¤.<br>`;
      }

      if (Math.abs(stats.kurtosis) < 0.5) {
        html += `â€¢ ì²¨ë„(${stats.kurtosis.toFixed(2)})ê°€ ì •ê·œë¶„í¬ì™€ <strong>ìœ ì‚¬í•œ ë´‰ìš°ë¦¬</strong>ë¥¼ ê°€ì§‘ë‹ˆë‹¤.<br>`;
      } else if (stats.kurtosis > 0) {
        html += `â€¢ ì²¨ë„(${stats.kurtosis.toFixed(2)})ê°€ ì–‘ìˆ˜ë¡œ ì •ê·œë¶„í¬ë³´ë‹¤ <strong>ë¾°ì¡±í•œ ë¶„í¬</strong>ì…ë‹ˆë‹¤.<br>`;
      } else {
        html += `â€¢ ì²¨ë„(${stats.kurtosis.toFixed(2)})ê°€ ìŒìˆ˜ë¡œ ì •ê·œë¶„í¬ë³´ë‹¤ <strong>í‰í‰í•œ ë¶„í¬</strong>ì…ë‹ˆë‹¤.<br>`;
      }

      html += `</div>`;
    });
    
    html += '</div>';
  }

  // ë²”ì£¼í˜• ë³€ìˆ˜ í•´ì„
  if (analysisResults.categorical) {
    html += '<div class="interpretation">';
    html += '<h4>ğŸ“Š ë²”ì£¼í˜• ë³€ìˆ˜ ë¶„ì„ í•´ì„</h4>';
    
    Object.entries(analysisResults.categorical).forEach(([col, stats]) => {
      html += `<div style="margin-bottom:20px;"><strong>${col}:</strong><br>`;
      html += `â€¢ ì´ ${stats.categories}ê°œì˜ ë²”ì£¼ê°€ ìˆìœ¼ë©°, ${stats.total}ê°œì˜ ê´€ì¸¡ê°’ì´ ìˆìŠµë‹ˆë‹¤.<br>`;
      html += `â€¢ ê°€ì¥ ë¹ˆë²ˆí•œ ë²”ì£¼ëŠ” '<strong>${stats.mostFrequent.cat}</strong>'ë¡œ ${stats.mostFrequent.f}íšŒ(${stats.mostFrequent.pct.toFixed(1)}%) ë‚˜íƒ€ë‚©ë‹ˆë‹¤.<br>`;
      
      // ê· ë“±ì„± í‰ê°€
      const maxFreq = Math.max(...Object.values(stats.frequencies));
      const minFreq = Math.min(...Object.values(stats.frequencies));
      
      if (maxFreq / minFreq < 2) {
        html += `â€¢ ê° ë²”ì£¼ì˜ ë¹ˆë„ê°€ <strong>ë¹„êµì  ê· ë“±</strong>í•˜ê²Œ ë¶„í¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>`;
      } else {
        html += `â€¢ ë²”ì£¼ë³„ ë¹ˆë„ì— <strong>í° ì°¨ì´</strong>ê°€ ìˆì–´ ë¶ˆê· ë“±í•˜ê²Œ ë¶„í¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>`;
      }
      
      html += `</div>`;
    });
    
    html += '</div>';
  }

  document.getElementById('descriptiveInterpretation').innerHTML = html;
  document.getElementById('descriptiveInterpretationPanel').style.display = 'block';
}

// T-ê²€ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
function updateTtestVariables() {
  const type = document.getElementById('ttestType').value;
  const container = document.getElementById('ttestVarSelection');
  
  let html = '';
  
  if (type === 'onesample') {
    html = `
      <div style="margin-bottom:10px">
        <strong>ê²€ì •í•  ë³€ìˆ˜:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>ê²€ì •ê°’ (Î¼â‚€):</strong><br>
        <input id="ttestMu0" type="number" step="0.01" value="0" style="width:120px">
      </div>
    `;
  } else if (type === 'twosample') {
    html = `
      <div style="margin-bottom:10px">
        <strong>ì²« ë²ˆì§¸ ë³€ìˆ˜:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>ë‘ ë²ˆì§¸ ë³€ìˆ˜:</strong><br>
        <select id="ttestVar2" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <label>
          <input type="checkbox" id="ttestEqualVar" checked> ë“±ë¶„ì‚° ê°€ì •
        </label>
      </div>
    `;
  } else if (type === 'paired') {
    html = `
      <div style="margin-bottom:10px">
        <strong>ì²« ë²ˆì§¸ ì¸¡ì •ê°’:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>ë‘ ë²ˆì§¸ ì¸¡ì •ê°’:</strong><br>
        <select id="ttestVar2" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function performTtest() {
  const type = document.getElementById('ttestType').value;
  const var1 = document.getElementById('ttestVar1').value;
  
  let result = {};
  
  if (type === 'onesample') {
    const mu0 = parseFloat(document.getElementById('ttestMu0').value);
    const data = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    
    const n = data.length;
    const sampleMean = mean(data);
    const sampleStd = stddev(data);
    const t = (sampleMean - mu0) / (sampleStd / Math.sqrt(n));
    const df = n - 1;
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: 'ì¼í‘œë³¸ t-ê²€ì •',
      variable: var1,
      n: n,
      mean: sampleMean,
      std: sampleStd,
      mu0: mu0,
      t: t,
      df: df,
      p: p,
      significant: p < 0.05
    };
  } else if (type === 'twosample') {
    const var2 = document.getElementById('ttestVar2').value;
    const equalVar = document.getElementById('ttestEqualVar').checked;
    
    const data1 = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    const data2 = parsedData.raw.map(r => r[var2]).filter(v => !isNaN(v));
    
    const n1 = data1.length, n2 = data2.length;
    const mean1 = mean(data1), mean2 = mean(data2);
    const var1_val = variance(data1), var2_val = variance(data2);
    
    let t, df, pooledSE;
    
    if (equalVar) {
      // ë“±ë¶„ì‚° ê°€ì •
      const pooledVar = ((n1 - 1) * var1_val + (n2 - 1) * var2_val) / (n1 + n2 - 2);
      pooledSE = Math.sqrt(pooledVar * (1/n1 + 1/n2));
      t = (mean1 - mean2) / pooledSE;
      df = n1 + n2 - 2;
    } else {
      // Welchì˜ t-ê²€ì •
      pooledSE = Math.sqrt(var1_val/n1 + var2_val/n2);
      t = (mean1 - mean2) / pooledSE;
      df = Math.pow(var1_val/n1 + var2_val/n2, 2) / (Math.pow(var1_val/n1, 2)/(n1-1) + Math.pow(var2_val/n2, 2)/(n2-1));
    }
    
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: 'ë…ë¦½í‘œë³¸ t-ê²€ì •',
      var1: var1,
      var2: var2,
      n1: n1,
      n2: n2,
      mean1: mean1,
      mean2: mean2,
      std1: Math.sqrt(var1_val),
      std2: Math.sqrt(var2_val),
      t: t,
      df: df,
      p: p,
      equalVar: equalVar,
      significant: p < 0.05
    };
  } else if (type === 'paired') {
    const var2 = document.getElementById('ttestVar2').value;
    
    const data1 = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    const data2 = parsedData.raw.map(r => r[var2]).filter(v => !isNaN(v));
    const minLength = Math.min(data1.length, data2.length);
    
    const differences = [];
    for (let i = 0; i < minLength; i++) {
      if (!isNaN(data1[i]) && !isNaN(data2[i])) {
        differences.push(data1[i] - data2[i]);
      }
    }
    
    const n = differences.length;
    const meanDiff = mean(differences);
    const stdDiff = stddev(differences);
    const t = meanDiff / (stdDiff / Math.sqrt(n));
    const df = n - 1;
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: 'ëŒ€ì‘í‘œë³¸ t-ê²€ì •',
      var1: var1,
      var2: var2,
      n: n,
      mean1: mean(data1.slice(0, minLength)),
      mean2: mean(data2.slice(0, minLength)),
      meanDiff: meanDiff,
      stdDiff: stdDiff,
      t: t,
      df: df,
      p: p,
      significant: p < 0.05
    };
  }
  
  return result;
}

function renderTtestResult(result) {
  let html = `<div class="test-result">`;
  html += `<h4>${result.type} ê²°ê³¼</h4>`;
  
  if (result.type === 'ì¼í‘œë³¸ t-ê²€ì •') {
    html += `
      <table>
        <tr><th>ë³€ìˆ˜</th><th>N</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ê²€ì •ê°’</th></tr>
        <tr><td>${result.variable}</td><td>${result.n}</td><td>${result.mean.toFixed(4)}</td><td>${result.std.toFixed(4)}</td><td>${result.mu0}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>ê²€ì •í†µê³„ëŸ‰:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>ììœ ë„:</strong> df = ${result.df}<br>
        <strong>p-ê°’:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>ê²°ë¡ :</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? 'ê·€ë¬´ê°€ì„¤ ê¸°ê° (ìœ ì˜í•¨)' : 'ê·€ë¬´ê°€ì„¤ ì±„íƒ (ìœ ì˜í•˜ì§€ ì•ŠìŒ)'}
        </span>
      </div>
    `;
  } else if (result.type === 'ë…ë¦½í‘œë³¸ t-ê²€ì •') {
    html += `
      <table>
        <tr><th>ë³€ìˆ˜</th><th>N</th><th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th></tr>
        <tr><td>${result.var1}</td><td>${result.n1}</td><td>${result.mean1.toFixed(4)}</td><td>${result.std1.toFixed(4)}</td></tr>
        <tr><td>${result.var2}</td><td>${result.n2}</td><td>${result.mean2.toFixed(4)}</td><td>${result.std2.toFixed(4)}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>ë“±ë¶„ì‚° ê°€ì •:</strong> ${result.equalVar ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤ (Welch ê²€ì •)'}<br>
        <strong>í‰ê·  ì°¨ì´:</strong> ${(result.mean1 - result.mean2).toFixed(4)}<br>
        <strong>ê²€ì •í†µê³„ëŸ‰:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>ììœ ë„:</strong> df = ${result.df.toFixed(2)}<br>
        <strong>p-ê°’:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>ê²°ë¡ :</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? 'ë‘ ì§‘ë‹¨ í‰ê· ì— ìœ ì˜í•œ ì°¨ì´ê°€ ìˆìŒ' : 'ë‘ ì§‘ë‹¨ í‰ê· ì— ìœ ì˜í•œ ì°¨ì´ê°€ ì—†ìŒ'}
        </span>
      </div>
    `;
  } else if (result.type === 'ëŒ€ì‘í‘œë³¸ t-ê²€ì •') {
    html += `
      <table>
        <tr><th>ë³€ìˆ˜</th><th>í‰ê· </th></tr>
        <tr><td>${result.var1}</td><td>${result.mean1.toFixed(4)}</td></tr>
        <tr><td>${result.var2}</td><td>${result.mean2.toFixed(4)}</td></tr>
        <tr><td>ì°¨ì´ (${result.var1} - ${result.var2})</td><td>${result.meanDiff.toFixed(4)}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>ëŒ€ì‘ ìŒ ìˆ˜:</strong> N = ${result.n}<br>
        <strong>ì°¨ì´ì˜ í‘œì¤€í¸ì°¨:</strong> ${result.stdDiff.toFixed(4)}<br>
        <strong>ê²€ì •í†µê³„ëŸ‰:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>ììœ ë„:</strong> df = ${result.df}<br>
        <strong>p-ê°’:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>ê²°ë¡ :</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? 'ë‘ ì¸¡ì •ê°’ ê°„ì— ìœ ì˜í•œ ì°¨ì´ê°€ ìˆìŒ' : 'ë‘ ì¸¡ì •ê°’ ê°„ì— ìœ ì˜í•œ ì°¨ì´ê°€ ì—†ìŒ'}
        </span>
      </div>
    `;
  }
  
  html += `</div>`;
  
  return html;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById("file").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  parsedData = parseCSV(text);
  showDataInfo();
  showVariableSelection(currentAnalysis);
});

document.getElementById("loadExample").addEventListener("click", async () => {
  const url = "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/iris.csv";
  const res = await fetch(url);
  const text = await res.text();
  parsedData = parseCSV(text);
  showDataInfo();
  showVariableSelection(currentAnalysis);
});

document.getElementById("clearData").addEventListener("click", () => {
  parsedData = null;
  analysisResults = {};
  document.getElementById('dataInfo').style.display = 'none';
  document.querySelectorAll('.analysis-section .panel').forEach(panel => {
    const varPanel = panel.querySelector('[id$="VarPanel"]');
    const resultPanel = panel.querySelector('[id$="ResultPanel"]');
    const interpretationPanel = panel.querySelector('[id$="InterpretationPanel"]');
    if (varPanel) varPanel.style.display = 'none';
    if (resultPanel) resultPanel.style.display = 'none';
    if (interpretationPanel) interpretationPanel.style.display = 'none';
  });
});

// ê¸°ìˆ í†µê³„ ì‹¤í–‰
document.getElementById("runDescriptive").addEventListener("click", () => {
  if (!parsedData) {
    alert("CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”");
    return;
  }

  const numSelected = Array.from(document.getElementById("descriptiveNumSelect").selectedOptions).map(o => o.value);
  const catSelected = Array.from(document.getElementById("descriptiveCatSelect").selectedOptions).map(o => o.value);

  analysisResults = {};
  let html = "";
  numSelected.forEach(col => { html += renderNumeric(col); });
  catSelected.forEach(col => { html += renderCategorical(col); });

  document.getElementById("descriptiveResults").innerHTML = html;
  document.getElementById("descriptiveResultPanel").style.display = "block";

  setTimeout(generateDescriptiveInterpretation, 500);
});

// T-ê²€ì • ìœ í˜• ë³€ê²½ ì‹œ
document.addEventListener('change', function(e) {
  if (e.target.id === 'ttestType' && parsedData) {
    updateTtestVariables();
  }
});

// T-ê²€ì • ì‹¤í–‰
document.getElementById("runTtest").addEventListener("click", () => {
  if (!parsedData) {
    alert("CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”");
    return;
  }

  try {
    const result = performTtest();
    const html = renderTtestResult(result);
    document.getElementById("ttestResults").innerHTML = html;
    document.getElementById("ttestResultPanel").style.display = "block";
  } catch (error) {
    alert("T-ê²€ì • ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
  }
});
</script>
</body>
</html>
