<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>통계분석 종합도구</title>

<!-- 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ml-matrix/6.10.4/ml-matrix.min.js"></script>

<style>
  :root{
    --bg:#f4f5f7; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --success:#059669;
    --shadow:0 8px 30px rgba(16,24,40,0.06); --warning:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{font-family:"Inter","Segoe UI",Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111827;padding:24px;display:flex;gap:20px;min-height:100vh}
  .sidebar{width:280px;background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);height:fit-content;position:sticky;top:24px}
  .sidebar h2{text-align:center;margin-bottom:15px;font-size:18px}
  .menu-category{margin-bottom:20px}
  .menu-category-title{font-size:14px;font-weight:600;color:var(--muted);margin-bottom:8px;padding:0 12px}
  .menu-item{display:block;padding:10px 12px;border-radius:12px;color:#374151;margin-bottom:4px;cursor:pointer;transition:all .18s ease;font-size:14px}
  .menu-item.active{background:var(--accent);color:white;font-weight:600;box-shadow:0 6px 18px rgba(37,99,235,0.14)}
  .menu-item:hover:not(.active){background:#f3f4f6}
  .main{flex:1;display:flex;flex-direction:column;gap:16px}
  .panel{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .analysis-section{display:none}
  .analysis-section.active{display:block}
  h1{margin:0;font-size:22px}
  h3{margin:0 0 15px 0;font-size:16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all .15s ease}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:#1d4ed8}
  .btn.success{background:var(--success);color:#fff}
  .btn.success:hover{background:#047857}
  .btn.warning{background:var(--warning);color:#fff}
  .btn.warning:hover{background:#d97706}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.danger:hover{background:#dc2626}
  .btn.ghost{background:#f3f4f6;color:#111827}
  .btn.ghost:hover{background:#e5e7eb}
  select,input[type="file"],input[type="number"],input[type="text"]{padding:8px 12px;border-radius:8px;border:1px solid #d1d5db;margin-top:8px;font-size:14px}
  input[type="file"]{width:auto}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th{background:#f9fafb;padding:10px 8px;border-bottom:2px solid #e5e7eb;text-align:center;font-weight:600}
  td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .resultCard{margin-top:20px;padding:18px;background:#fafbfc;border-radius:12px;border:1px solid #f1f3f4}
  .graphRow{display:flex;gap:20px;margin-top:15px}
  .graphCell{flex:1}
  .section{margin-bottom:15px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .var-select{width:240px;margin-top:6px;min-height:120px}
  .interpretation{background:#f8fafc;border-left:4px solid #64748b;padding:18px;margin-top:20px;border-radius:8px;border:1px solid #e2e8f0}
  .interpretation h4{margin:0 0 12px 0;color:#334155;font-size:16px}
  .status-badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
  .status-success{background:#d1fae5;color:#065f46}
  .status-warning{background:#fef3c7;color:#92400e}
  .status-danger{background:#fee2e2;color:#991b1b}
  .data-info{background:#f0f9ff;padding:12px;border-radius:8px;margin:10px 0;border:1px solid #e0f2fe}
  .variable-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .variable-tag{background:#e5e7eb;padding:4px 8px;border-radius:6px;font-size:12px}
  .test-result{background:#f8fafc;border:1px solid #e2e8f0;padding:15px;border-radius:8px;margin:10px 0}
  .p-value{font-weight:bold}
  .p-value.significant{color:var(--danger)}
  .p-value.not-significant{color:var(--muted)}
</style>
</head>
<body>

  <!-- 사이드바 -->
  <div class="sidebar">
    <h2>📊 분석 메뉴</h2>
    <div id="menuList">
      <div class="menu-category">데이터 탐색</div>
      <div class="menu-item" data-target="stats.html">기술통계</div>

      <div class="menu-category">집단 간 차이 검정</div>
      <div class="menu-item" data-target="t_test.html">t-검정 (독립/대응)</div>
      <div class="menu-item active" data-target="chisquare.html">카이제곱 검정</div>
      <div class="menu-item" data-target="main-nonparam">비모수 검정</div>
      <div class="menu-item" data-target="main-anova">분산분석 (ANOVA)</div>

      <div class="menu-category">변수 간 관계 분석</div>
      <div class="menu-item" data-target="main-corr">상관분석</div>
      <div class="menu-item" data-target="main-reg">회귀분석</div>
      <div class="menu-item" data-target="main-probit">프로빗분석</div>
      <div class="menu-item" data-target="main-mediation">매개효과</div>
      <div class="menu-item" data-target="main-moderation">조절효과</div>
      <div class="menu-item" data-target="main-discriminant">판별분석</div>
      <div class="menu-item" data-target="main-sem">SEM (구조방정식 모형)</div>

      <div class="menu-category">차원 축소 / 군집화</div>
      <div class="menu-item" data-target="main-pca">PCA</div>
      <div class="menu-item" data-target="main-efa">탐색적 요인분석 (EFA)</div>
      <div class="menu-item" data-target="main-cfa">확인적 요인분석 (CFA)</div>
      <div class="menu-item" data-target="main-cluster">군집분석</div>
    </div>
  </div>

  

  <div class="main">
    <!-- 공통 데이터 업로드 패널 -->
    <div class="panel">
      <h1 id="mainTitle">📊 기술통계</h1>
      <div class="muted" id="mainDescription">CSV 업로드 → 변수 선택 → 분석 실행</div>
      
      <div class="section" style="margin-top:15px">
        <div class="inline">
          <input id="file" type="file" accept=".csv">
          <button id="loadExample" class="btn success">예제 데이터 불러오기</button>
          <button id="clearData" class="btn ghost">데이터 초기화</button>
        </div>
        
        <div id="dataInfo" class="data-info" style="display:none">
          <strong>데이터 정보:</strong>
          <div id="dataDetails"></div>
        </div>
      </div>
    </div>

    <!-- 기술통계 섹션 -->
    <div id="descriptiveSection" class="analysis-section active">
      <div class="panel">
        <h3>변수 선택</h3>
        <div id="descriptiveVarPanel" style="display:none">
          <div style="margin-bottom:15px">
            <strong>수치형 변수 선택:</strong><br>
            <select id="descriptiveNumSelect" multiple size="6" class="var-select"></select>
          </div>
          <div style="margin-bottom:15px">
            <strong>범주형 변수 선택:</strong><br>
            <select id="descriptiveCatSelect" multiple size="6" class="var-select"></select>
          </div>
          <button id="runDescriptive" class="btn primary">분석 실행</button>
        </div>
      </div>

      <div class="panel" id="descriptiveResultPanel" style="display:none">
        <h3>분석 결과</h3>
        <div id="descriptiveResults"></div>
      </div>

      <div class="panel" id="descriptiveInterpretationPanel" style="display:none">
        <h3>결과 해석</h3>
        <div id="descriptiveInterpretation"></div>
      </div>
    </div>

    <!-- T-검정 섹션 -->
    <div id="ttestSection" class="analysis-section">
      <div class="panel">
        <h3>T-검정 설정</h3>
        <div id="ttestVarPanel" style="display:none">
          <div class="section">
            <strong>검정 유형:</strong><br>
            <select id="ttestType" style="width:200px">
              <option value="onesample">일표본 t-검정</option>
              <option value="twosample">독립표본 t-검정</option>
              <option value="paired">대응표본 t-검정</option>
            </select>
          </div>
          
          <div class="section" id="ttestVarSelection">
            <!-- 동적으로 생성될 변수 선택 영역 -->
          </div>
          
          <button id="runTtest" class="btn primary">검정 실행</button>
        </div>
      </div>

      <div class="panel" id="ttestResultPanel" style="display:none">
        <h3>T-검정 결과</h3>
        <div id="ttestResults"></div>
      </div>
    </div>

    <!-- 다른 분석 섹션들은 필요시 추가 -->
    <div id="chisquareSection" class="analysis-section">
      <div class="panel">
        <h3>카이제곱검정</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="nonparametricSection" class="analysis-section">
      <div class="panel">
        <h3>비모수검정</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="anovaSection" class="analysis-section">
      <div class="panel">
        <h3>분산분석(ANOVA)</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="regressionSection" class="analysis-section">
      <div class="panel">
        <h3>단순·다중회귀</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="logisticSection" class="analysis-section">
      <div class="panel">
        <h3>로지스틱회귀</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="probitSection" class="analysis-section">
      <div class="panel">
        <h3>프로빗모형</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="factorSection" class="analysis-section">
      <div class="panel">
        <h3>요인분석</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="pcaSection" class="analysis-section">
      <div class="panel">
        <h3>주성분분석(PCA)</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="clusterSection" class="analysis-section">
      <div class="panel">
        <h3>군집분석</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>

    <div id="discriminantSection" class="analysis-section">
      <div class="panel">
        <h3>판별분석</h3>
        <div class="muted">준비 중...</div>
      </div>
    </div>
  </div>

<script>
// 전역 변수
let parsedData = null;
let currentAnalysis = 'descriptive';
let analysisResults = {};

// 메뉴 시스템
const menuConfig = {
  descriptive: { title: '📊 기술통계', desc: 'CSV 업로드 → 변수 선택 → 분석 실행' },
  ttest: { title: '🔍 T-검정', desc: '평균 차이 검정 (일표본, 독립표본, 대응표본)' },
  chisquare: { title: '🎯 카이제곱검정', desc: '범주형 변수 간의 독립성 검정' },
  nonparametric: { title: '📈 비모수검정', desc: '분포를 가정하지 않는 검정' },
  anova: { title: '📊 분산분석(ANOVA)', desc: '여러 집단 간의 평균 비교' },
  regression: { title: '📈 단순·다중회귀', desc: '연속형 종속변수 예측 모델' },
  logistic: { title: '🎯 로지스틱회귀', desc: '이항 종속변수 예측 모델' },
  probit: { title: '📊 프로빗모형', desc: '이항 종속변수의 또 다른 예측 모델' },
  factor: { title: '🔍 요인분석', desc: '잠재 요인 발견 및 차원 축소' },
  pca: { title: '📊 주성분분석(PCA)', desc: '차원 축소 및 주성분 추출' },
  cluster: { title: '🎯 군집분석', desc: '유사한 관측치들을 그룹으로 분류' },
  discriminant: { title: '📈 판별분석', desc: '집단 분류 및 판별 함수 도출' }
};

// 메뉴 이벤트 처리
document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', function() {
    const section = this.dataset.section;
    if (!section) return;
    
    // 메뉴 활성화 상태 변경
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    this.classList.add('active');
    
    // 섹션 변경
    document.querySelectorAll('.analysis-section').forEach(s => s.classList.remove('active'));
    document.getElementById(section + 'Section').classList.add('active');
    
    // 제목과 설명 변경
    const config = menuConfig[section];
    document.getElementById('mainTitle').textContent = config.title;
    document.getElementById('mainDescription').textContent = config.desc;
    
    currentAnalysis = section;
    
    // 데이터가 있으면 해당 섹션의 변수 선택 패널 표시
    if (parsedData) {
      showVariableSelection(section);
    }
  });
});

// 공통 함수들
function parseCSV(text) {
  const {data, errors} = Papa.parse(text.trim(), {
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true
  });
  
  if (errors && errors.length) throw new Error('CSV 파싱 오류: ' + errors[0].message);
  if (!data.length) throw new Error('데이터가 비었습니다.');

  const headers = Object.keys(data[0]);
  const numericCols = headers.filter(h => 
    data.every(row => row[h] !== null && row[h] !== "" && !isNaN(row[h]))
  );
  const categoricalCols = headers.filter(h => !numericCols.includes(h));

  return {
    raw: data,
    headers: headers,
    numericCols: numericCols,
    categoricalCols: categoricalCols,
    rowCount: data.length
  };
}

function showDataInfo() {
  if (!parsedData) return;
  
  const info = `
    <strong>행 수:</strong> ${parsedData.rowCount} | 
    <strong>열 수:</strong> ${parsedData.headers.length}<br>
    <strong>수치형 변수 (${parsedData.numericCols.length}):</strong> 
    <div class="variable-list">
      ${parsedData.numericCols.map(col => `<span class="variable-tag">${col}</span>`).join('')}
    </div>
    <strong>범주형 변수 (${parsedData.categoricalCols.length}):</strong>
    <div class="variable-list">
      ${parsedData.categoricalCols.map(col => `<span class="variable-tag">${col}</span>`).join('')}
    </div>
  `;
  
  document.getElementById('dataDetails').innerHTML = info;
  document.getElementById('dataInfo').style.display = 'block';
}

function showVariableSelection(section) {
  if (!parsedData) return;
  
  if (section === 'descriptive') {
    updateDescriptiveVariables();
    document.getElementById('descriptiveVarPanel').style.display = 'block';
  } else if (section === 'ttest') {
    updateTtestVariables();
    document.getElementById('ttestVarPanel').style.display = 'block';
  }
  // 다른 분석들도 필요시 추가
}

// 기술통계 관련 함수들
function updateDescriptiveVariables() {
  const numSelect = document.getElementById("descriptiveNumSelect");
  numSelect.innerHTML = "";
  parsedData.numericCols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c; opt.selected = true;
    numSelect.appendChild(opt);
  });

  const catSelect = document.getElementById("descriptiveCatSelect");
  catSelect.innerHTML = "";
  parsedData.categoricalCols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    catSelect.appendChild(opt);
  });
}

// 통계 함수들
function mean(arr) { return arr.reduce((a,b) => a+b, 0) / arr.length; }
function median(arr) {
  const s = [...arr].sort((a,b) => a-b);
  const m = Math.floor(s.length/2);
  return s.length % 2 ? s[m] : (s[m-1] + s[m]) / 2;
}
function variance(arr) {
  const m = mean(arr);
  return mean(arr.map(x => (x-m)**2));
}
function stddev(arr) { return Math.sqrt(variance(arr)); }
function q1(arr) { return jStat.percentile([...arr].sort((a,b) => a-b), 0.25); }
function q3(arr) { return jStat.percentile([...arr].sort((a,b) => a-b), 0.75); }
function skewness(arr) { return jStat.skewness(arr); }
function kurtosis(arr) { return jStat.kurtosis(arr); }

function renderNumeric(col) {
  const arr = parsedData.raw.map(r => +r[col]).filter(v => !isNaN(v));
  if (arr.length === 0) return "";
  
  const n = arr.length;
  const miss = parsedData.rowCount - n;
  const m = mean(arr), md = median(arr), v = variance(arr), sd = stddev(arr);
  const mn = Math.min(...arr), mx = Math.max(...arr);
  const q_1 = q1(arr), q_3 = q3(arr), iqr = q_3 - q_1;
  const sk = skewness(arr), kt = kurtosis(arr);

  // 결과 저장
  if (!analysisResults.numeric) analysisResults.numeric = {};
  analysisResults.numeric[col] = {
    n, miss, mean: m, median: md, variance: v, stddev: sd, 
    min: mn, max: mx, q1: q_1, q3: q_3, iqr, skewness: sk, kurtosis: kt
  };

  let html = `<div class='resultCard'><h4>수치형 변수: ${col}</h4>`;
  html += `<table><thead><tr><th>N</th><th>결측</th><th>평균</th><th>중앙값</th><th>최소</th><th>최대</th><th>표준편차</th><th>분산</th><th>Q1</th><th>Q3</th><th>IQR</th><th>왜도</th><th>첨도</th></tr></thead>`;
  html += `<tbody><tr><td>${n}</td><td>${miss}</td><td>${m.toFixed(4)}</td><td>${md.toFixed(4)}</td><td>${mn}</td><td>${mx}</td><td>${sd.toFixed(4)}</td><td>${v.toFixed(4)}</td><td>${q_1.toFixed(4)}</td><td>${q_3.toFixed(4)}</td><td>${iqr.toFixed(4)}</td><td>${sk.toFixed(4)}</td><td>${kt.toFixed(4)}</td></tr></tbody></table>`;

  const divId1 = `hist_${col}_desc`;
  const divId2 = `box_${col}_desc`;
  html += `<div class='graphRow'><div class='graphCell'><div id='${divId1}' style='height:300px'></div></div><div class='graphCell'><div id='${divId2}' style='height:300px'></div></div></div>`;
  html += `</div>`;

  setTimeout(() => {
    Plotly.newPlot(divId1, [{x: arr, type: "histogram", name: col}], {
      title: `${col} 히스토그램`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
    Plotly.newPlot(divId2, [{y: arr, type: "box", boxpoints: 'outliers', name: col}], {
      title: `${col} 박스플롯`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
  }, 100);

  return html;
}

function renderCategorical(col) {
  const vals = parsedData.raw.map(r => r[col]).filter(v => v !== null && v !== "");
  const freq = {};
  vals.forEach(v => { freq[v] = (freq[v] || 0) + 1; });
  const total = vals.length;
  const rows = Object.entries(freq).map(([k,v]) => ({cat: k, f: v, pct: v/total*100})).sort((a,b) => b.f - a.f);
  let cum = 0;

  // 결과 저장
  if (!analysisResults.categorical) analysisResults.categorical = {};
  analysisResults.categorical[col] = {
    total: total,
    categories: rows.length,
    frequencies: freq,
    mostFrequent: rows[0]
  };

  let html = `<div class='resultCard'><h4>범주형 변수: ${col}</h4>`;
  html += `<table><thead><tr><th>값</th><th>빈도</th><th>%</th><th>누적 %</th></tr></thead><tbody>`;
  rows.forEach(r => {
    cum += r.pct;
    html += `<tr><td>${r.cat}</td><td>${r.f}</td><td>${r.pct.toFixed(2)}</td><td>${cum.toFixed(2)}</td></tr>`;
  });
  html += `</tbody></table>`;

  const divId = `bar_${col}_desc`;
  html += `<div class='graphRow'><div class='graphCell'><div id='${divId}' style='height:300px'></div></div><div class='graphCell'></div></div>`;
  html += `</div>`;

  setTimeout(() => {
    Plotly.newPlot(divId, [{
      x: rows.map(r => r.cat), 
      y: rows.map(r => r.f), 
      type: 'bar',
      name: col
    }], {
      title: `${col} 막대그래프`, 
      margin: {l: 60, r: 60, t: 50, b: 50}
    });
  }, 100);

  return html;
}

function generateDescriptiveInterpretation() {
  if (!analysisResults) return;

  let html = '';

  // 수치형 변수 해석
  if (analysisResults.numeric) {
    html += '<div class="interpretation">';
    html += '<h4>🔢 수치형 변수 분석 해석</h4>';
    
    Object.entries(analysisResults.numeric).forEach(([col, stats]) => {
      html += `<div style="margin-bottom:20px;"><strong>${col}:</strong><br>`;
      
      // 중심경향성 해석
      const meanMedianDiff = Math.abs(stats.mean - stats.median);
      const relativeDiff = meanMedianDiff / stats.stddev;
      
      if (relativeDiff < 0.1) {
        html += `• 평균(${stats.mean.toFixed(2)})과 중앙값(${stats.median.toFixed(2)})이 거의 같아 <strong>대칭적 분포</strong>를 보입니다.<br>`;
      } else if (stats.mean > stats.median) {
        html += `• 평균(${stats.mean.toFixed(2)})이 중앙값(${stats.median.toFixed(2)})보다 크므로 <strong>우측 꼬리가 긴 분포</strong>입니다.<br>`;
      } else {
        html += `• 평균(${stats.mean.toFixed(2)})이 중앙값(${stats.median.toFixed(2)})보다 작으므로 <strong>좌측 꼬리가 긴 분포</strong>입니다.<br>`;
      }

      // 산포도 해석
      const cv = stats.stddev / Math.abs(stats.mean) * 100;
      if (cv < 10) {
        html += `• 변동계수(${cv.toFixed(1)}%)가 낮아 <strong>데이터가 평균 주위에 집중</strong>되어 있습니다.<br>`;
      } else if (cv > 30) {
        html += `• 변동계수(${cv.toFixed(1)}%)가 높아 <strong>데이터의 변동성이 큽니다</strong>.<br>`;
      } else {
        html += `• 변동계수(${cv.toFixed(1)}%)로 <strong>적당한 수준의 변동성</strong>을 보입니다.<br>`;
      }

      // 왜도와 첨도 해석
      if (Math.abs(stats.skewness) < 0.5) {
        html += `• 왜도(${stats.skewness.toFixed(2)})가 0에 가까워 <strong>거의 대칭적</strong>입니다.<br>`;
      } else if (stats.skewness > 0) {
        html += `• 왜도(${stats.skewness.toFixed(2)})가 양수로 <strong>우측으로 치우친</strong> 분포입니다.<br>`;
      } else {
        html += `• 왜도(${stats.skewness.toFixed(2)})가 음수로 <strong>좌측으로 치우친</strong> 분포입니다.<br>`;
      }

      if (Math.abs(stats.kurtosis) < 0.5) {
        html += `• 첨도(${stats.kurtosis.toFixed(2)})가 정규분포와 <strong>유사한 봉우리</strong>를 가집니다.<br>`;
      } else if (stats.kurtosis > 0) {
        html += `• 첨도(${stats.kurtosis.toFixed(2)})가 양수로 정규분포보다 <strong>뾰족한 분포</strong>입니다.<br>`;
      } else {
        html += `• 첨도(${stats.kurtosis.toFixed(2)})가 음수로 정규분포보다 <strong>평평한 분포</strong>입니다.<br>`;
      }

      html += `</div>`;
    });
    
    html += '</div>';
  }

  // 범주형 변수 해석
  if (analysisResults.categorical) {
    html += '<div class="interpretation">';
    html += '<h4>📊 범주형 변수 분석 해석</h4>';
    
    Object.entries(analysisResults.categorical).forEach(([col, stats]) => {
      html += `<div style="margin-bottom:20px;"><strong>${col}:</strong><br>`;
      html += `• 총 ${stats.categories}개의 범주가 있으며, ${stats.total}개의 관측값이 있습니다.<br>`;
      html += `• 가장 빈번한 범주는 '<strong>${stats.mostFrequent.cat}</strong>'로 ${stats.mostFrequent.f}회(${stats.mostFrequent.pct.toFixed(1)}%) 나타납니다.<br>`;
      
      // 균등성 평가
      const maxFreq = Math.max(...Object.values(stats.frequencies));
      const minFreq = Math.min(...Object.values(stats.frequencies));
      
      if (maxFreq / minFreq < 2) {
        html += `• 각 범주의 빈도가 <strong>비교적 균등</strong>하게 분포되어 있습니다.<br>`;
      } else {
        html += `• 범주별 빈도에 <strong>큰 차이</strong>가 있어 불균등하게 분포되어 있습니다.<br>`;
      }
      
      html += `</div>`;
    });
    
    html += '</div>';
  }

  document.getElementById('descriptiveInterpretation').innerHTML = html;
  document.getElementById('descriptiveInterpretationPanel').style.display = 'block';
}

// T-검정 관련 함수들
function updateTtestVariables() {
  const type = document.getElementById('ttestType').value;
  const container = document.getElementById('ttestVarSelection');
  
  let html = '';
  
  if (type === 'onesample') {
    html = `
      <div style="margin-bottom:10px">
        <strong>검정할 변수:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>검정값 (μ₀):</strong><br>
        <input id="ttestMu0" type="number" step="0.01" value="0" style="width:120px">
      </div>
    `;
  } else if (type === 'twosample') {
    html = `
      <div style="margin-bottom:10px">
        <strong>첫 번째 변수:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>두 번째 변수:</strong><br>
        <select id="ttestVar2" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <label>
          <input type="checkbox" id="ttestEqualVar" checked> 등분산 가정
        </label>
      </div>
    `;
  } else if (type === 'paired') {
    html = `
      <div style="margin-bottom:10px">
        <strong>첫 번째 측정값:</strong><br>
        <select id="ttestVar1" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
      <div style="margin-bottom:10px">
        <strong>두 번째 측정값:</strong><br>
        <select id="ttestVar2" style="width:200px">
          ${parsedData.numericCols.map(col => `<option value="${col}">${col}</option>`).join('')}
        </select>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function performTtest() {
  const type = document.getElementById('ttestType').value;
  const var1 = document.getElementById('ttestVar1').value;
  
  let result = {};
  
  if (type === 'onesample') {
    const mu0 = parseFloat(document.getElementById('ttestMu0').value);
    const data = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    
    const n = data.length;
    const sampleMean = mean(data);
    const sampleStd = stddev(data);
    const t = (sampleMean - mu0) / (sampleStd / Math.sqrt(n));
    const df = n - 1;
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: '일표본 t-검정',
      variable: var1,
      n: n,
      mean: sampleMean,
      std: sampleStd,
      mu0: mu0,
      t: t,
      df: df,
      p: p,
      significant: p < 0.05
    };
  } else if (type === 'twosample') {
    const var2 = document.getElementById('ttestVar2').value;
    const equalVar = document.getElementById('ttestEqualVar').checked;
    
    const data1 = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    const data2 = parsedData.raw.map(r => r[var2]).filter(v => !isNaN(v));
    
    const n1 = data1.length, n2 = data2.length;
    const mean1 = mean(data1), mean2 = mean(data2);
    const var1_val = variance(data1), var2_val = variance(data2);
    
    let t, df, pooledSE;
    
    if (equalVar) {
      // 등분산 가정
      const pooledVar = ((n1 - 1) * var1_val + (n2 - 1) * var2_val) / (n1 + n2 - 2);
      pooledSE = Math.sqrt(pooledVar * (1/n1 + 1/n2));
      t = (mean1 - mean2) / pooledSE;
      df = n1 + n2 - 2;
    } else {
      // Welch의 t-검정
      pooledSE = Math.sqrt(var1_val/n1 + var2_val/n2);
      t = (mean1 - mean2) / pooledSE;
      df = Math.pow(var1_val/n1 + var2_val/n2, 2) / (Math.pow(var1_val/n1, 2)/(n1-1) + Math.pow(var2_val/n2, 2)/(n2-1));
    }
    
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: '독립표본 t-검정',
      var1: var1,
      var2: var2,
      n1: n1,
      n2: n2,
      mean1: mean1,
      mean2: mean2,
      std1: Math.sqrt(var1_val),
      std2: Math.sqrt(var2_val),
      t: t,
      df: df,
      p: p,
      equalVar: equalVar,
      significant: p < 0.05
    };
  } else if (type === 'paired') {
    const var2 = document.getElementById('ttestVar2').value;
    
    const data1 = parsedData.raw.map(r => r[var1]).filter(v => !isNaN(v));
    const data2 = parsedData.raw.map(r => r[var2]).filter(v => !isNaN(v));
    const minLength = Math.min(data1.length, data2.length);
    
    const differences = [];
    for (let i = 0; i < minLength; i++) {
      if (!isNaN(data1[i]) && !isNaN(data2[i])) {
        differences.push(data1[i] - data2[i]);
      }
    }
    
    const n = differences.length;
    const meanDiff = mean(differences);
    const stdDiff = stddev(differences);
    const t = meanDiff / (stdDiff / Math.sqrt(n));
    const df = n - 1;
    const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
    
    result = {
      type: '대응표본 t-검정',
      var1: var1,
      var2: var2,
      n: n,
      mean1: mean(data1.slice(0, minLength)),
      mean2: mean(data2.slice(0, minLength)),
      meanDiff: meanDiff,
      stdDiff: stdDiff,
      t: t,
      df: df,
      p: p,
      significant: p < 0.05
    };
  }
  
  return result;
}

function renderTtestResult(result) {
  let html = `<div class="test-result">`;
  html += `<h4>${result.type} 결과</h4>`;
  
  if (result.type === '일표본 t-검정') {
    html += `
      <table>
        <tr><th>변수</th><th>N</th><th>평균</th><th>표준편차</th><th>검정값</th></tr>
        <tr><td>${result.variable}</td><td>${result.n}</td><td>${result.mean.toFixed(4)}</td><td>${result.std.toFixed(4)}</td><td>${result.mu0}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>검정통계량:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>자유도:</strong> df = ${result.df}<br>
        <strong>p-값:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>결론:</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? '귀무가설 기각 (유의함)' : '귀무가설 채택 (유의하지 않음)'}
        </span>
      </div>
    `;
  } else if (result.type === '독립표본 t-검정') {
    html += `
      <table>
        <tr><th>변수</th><th>N</th><th>평균</th><th>표준편차</th></tr>
        <tr><td>${result.var1}</td><td>${result.n1}</td><td>${result.mean1.toFixed(4)}</td><td>${result.std1.toFixed(4)}</td></tr>
        <tr><td>${result.var2}</td><td>${result.n2}</td><td>${result.mean2.toFixed(4)}</td><td>${result.std2.toFixed(4)}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>등분산 가정:</strong> ${result.equalVar ? '예' : '아니오 (Welch 검정)'}<br>
        <strong>평균 차이:</strong> ${(result.mean1 - result.mean2).toFixed(4)}<br>
        <strong>검정통계량:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>자유도:</strong> df = ${result.df.toFixed(2)}<br>
        <strong>p-값:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>결론:</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? '두 집단 평균에 유의한 차이가 있음' : '두 집단 평균에 유의한 차이가 없음'}
        </span>
      </div>
    `;
  } else if (result.type === '대응표본 t-검정') {
    html += `
      <table>
        <tr><th>변수</th><th>평균</th></tr>
        <tr><td>${result.var1}</td><td>${result.mean1.toFixed(4)}</td></tr>
        <tr><td>${result.var2}</td><td>${result.mean2.toFixed(4)}</td></tr>
        <tr><td>차이 (${result.var1} - ${result.var2})</td><td>${result.meanDiff.toFixed(4)}</td></tr>
      </table>
      <div style="margin-top:15px">
        <strong>대응 쌍 수:</strong> N = ${result.n}<br>
        <strong>차이의 표준편차:</strong> ${result.stdDiff.toFixed(4)}<br>
        <strong>검정통계량:</strong> t = ${result.t.toFixed(4)}<br>
        <strong>자유도:</strong> df = ${result.df}<br>
        <strong>p-값:</strong> <span class="p-value ${result.significant ? 'significant' : 'not-significant'}">${result.p.toFixed(6)}</span><br>
        <strong>결론:</strong> 
        <span class="status-badge ${result.significant ? 'status-danger' : 'status-success'}">
          ${result.significant ? '두 측정값 간에 유의한 차이가 있음' : '두 측정값 간에 유의한 차이가 없음'}
        </span>
      </div>
    `;
  }
  
  html += `</div>`;
  
  return html;
}

// 이벤트 리스너
document.getElementById("file").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  parsedData = parseCSV(text);
  showDataInfo();
  showVariableSelection(currentAnalysis);
});

document.getElementById("loadExample").addEventListener("click", async () => {
  const url = "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/iris.csv";
  const res = await fetch(url);
  const text = await res.text();
  parsedData = parseCSV(text);
  showDataInfo();
  showVariableSelection(currentAnalysis);
});

document.getElementById("clearData").addEventListener("click", () => {
  parsedData = null;
  analysisResults = {};
  document.getElementById('dataInfo').style.display = 'none';
  document.querySelectorAll('.analysis-section .panel').forEach(panel => {
    const varPanel = panel.querySelector('[id$="VarPanel"]');
    const resultPanel = panel.querySelector('[id$="ResultPanel"]');
    const interpretationPanel = panel.querySelector('[id$="InterpretationPanel"]');
    if (varPanel) varPanel.style.display = 'none';
    if (resultPanel) resultPanel.style.display = 'none';
    if (interpretationPanel) interpretationPanel.style.display = 'none';
  });
});

// 기술통계 실행
document.getElementById("runDescriptive").addEventListener("click", () => {
  if (!parsedData) {
    alert("CSV 파일을 먼저 업로드하거나 예제를 불러오세요");
    return;
  }

  const numSelected = Array.from(document.getElementById("descriptiveNumSelect").selectedOptions).map(o => o.value);
  const catSelected = Array.from(document.getElementById("descriptiveCatSelect").selectedOptions).map(o => o.value);

  analysisResults = {};
  let html = "";
  numSelected.forEach(col => { html += renderNumeric(col); });
  catSelected.forEach(col => { html += renderCategorical(col); });

  document.getElementById("descriptiveResults").innerHTML = html;
  document.getElementById("descriptiveResultPanel").style.display = "block";

  setTimeout(generateDescriptiveInterpretation, 500);
});

// T-검정 유형 변경 시
document.addEventListener('change', function(e) {
  if (e.target.id === 'ttestType' && parsedData) {
    updateTtestVariables();
  }
});

// T-검정 실행
document.getElementById("runTtest").addEventListener("click", () => {
  if (!parsedData) {
    alert("CSV 파일을 먼저 업로드하거나 예제를 불러오세요");
    return;
  }

  try {
    const result = performTtest();
    const html = renderTtestResult(result);
    document.getElementById("ttestResults").innerHTML = html;
    document.getElementById("ttestResultPanel").style.display = "block";
  } catch (error) {
    alert("T-검정 실행 중 오류가 발생했습니다: " + error.message);
  }
});
</script>
</body>
</html>
