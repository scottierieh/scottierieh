<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìä Descriptive Statistics Analysis - Skari</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --accent:#3b82f6; --success:#10b981;
    --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6; --info:#06b6d4;
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1);
    --gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  }
  
  * {box-sizing:border-box;margin:0;padding:0;}
  
  body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#1e293b;line-height:1.6;margin:0;padding:0}
  
  /* Header Navigation */
  .header{background:white;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
  .header-content{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px}
  .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
  .logo-icon{width:40px;height:40px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white}
  
  .nav-tabs{display:flex;gap:4px;background:#f1f5f9;padding:4px;border-radius:12px}
  .nav-item{position:relative;}
  .nav-tab{padding:8px 16px;border-radius:8px;border:none;background:transparent;cursor:pointer;font-weight:500;color:#64748b;transition:all 0.2s;white-space:nowrap;font-size:14px;display:flex;align-items:center;gap:4px;}
  .nav-tab:hover{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  .nav-tab.active{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  
  .dropdown{position:absolute;top:100%;left:50%;transform:translateX(-50%);background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);padding:8px;min-width:200px;opacity:0;visibility:hidden;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none;z-index:1000;margin-top:8px;}
  .dropdown.active{opacity:1;visibility:visible;pointer-events:all;}
  .nav-item:hover .dropdown{opacity:1;visibility:visible;pointer-events:all;}
  .dropdown-item{padding:10px 16px;border-radius:8px;cursor:pointer;transition:all 0.2s;font-size:13px;color:#475569;display:block;text-decoration:none;}
  .dropdown-item:hover{background:#f8fafc;color:#1e293b;transform:translateX(4px);}
  
  .header-actions{display:flex;gap:12px;align-items:center}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
  
  /* Main Container */
  .main-container{max-width:1400px;margin:0 auto;padding:24px}
  .content-area{display:block}
  
  /* Panel Styles */
  .panel{background:var(--card);border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:16px}
  h1{margin:0;font-size:24px;color:#1e293b;font-weight:700}
  h2{margin:20px 0 12px 0;font-size:18px;color:var(--accent);font-weight:600}
  h3{margin:16px 0 12px 0;font-size:16px;color:#374151;font-weight:600}
  h4{margin:12px 0 8px 0;font-size:14px;color:var(--accent);font-weight:600}
  
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.success{background:var(--success);color:#fff}
  .btn.ghost{background:#f1f5f9;color:#475569}
  .btn.small{padding:6px 12px;font-size:13px}
  .btn.icon{padding:8px;width:36px;height:36px;justify-content:center}
  
  /* Table Styles */
  .table-container{overflow:auto;max-height:400px;border-radius:8px;border:1px solid #e2e8f0;margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px;}
  th,td{padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:center}
  th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:1}
  tr:hover{background:#f8fafc}
  
  .muted{color:var(--muted);font-size:13px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  
  /* Model Cards */
  .model-card {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    background: white;
  }
  .model-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  .model-card.selected {
    border-color: var(--accent);
    background: #f0f9ff;
  }
  .model-card h4 {
    margin: 0 0 12px 0;
    color: var(--accent);
    font-size: 18px;
  }
  .model-card .desc {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.5;
  }
  
  /* Form Elements */
  select,input[type="checkbox"]{
    padding:8px 12px;
    border:2px solid #e2e8f0;
    border-radius:8px;
    font-size:14px;
    background:white;
    cursor:pointer;
  }
  select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
  }
  
  /* Interpretation Boxes */
  .interpretation-box{
    background:#f0fdf4;
    border-left:4px solid var(--success);
    padding:20px;
    margin:20px 0;
    border-radius:0 8px 8px 0;
  }
  .interpretation-box.warning{
    background:#fef3c7;
    border-left-color:var(--warning);
  }
  .interpretation-box.info{
    background:#f0f9ff;
    border-left-color:var(--info);
  }
  
  /* Plot Styles */
  .plot-container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
    margin-top:20px;
  }
  .plot-item{
    height:350px;
    width:100%;
    border-radius:8px;
    border:1px solid #e2e8f0;
    overflow:hidden;
  }
  
  .var-checkbox-container{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:12px;
  }
  
  @media (max-width: 768px) {
    .header-content{padding:0 16px}
    .nav-tabs{display:none}
    .main-container{padding:16px}
    .grid-2, .grid-3 {
      grid-template-columns: 1fr;
    }
    .plot-container{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<!-- Header Navigation -->
<div class="header">
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">üìä</div>
      <span>Skari</span>
    </div>
    
    <div class="nav-tabs">
      <!-- 1. Descriptive Statistics -->
      <div class="nav-item">
        <button class="nav-tab active">üìä Descriptive</button>
      </div>
      
      <!-- 2. Assumption Check -->
      <div class="nav-item">
        <button class="nav-tab">üîç Assumption Check <span style="font-size:10px">‚ñº</span></button>
        <div class="dropdown">
          <a href="normality.html" class="dropdown-item">Normality Test</a>
          <a href="homogeneity.html" class="dropdown-item">Homogeneity Test</a>
        </div>
      </div>
      
      <!-- 3. Difference Tests -->
      <div class="nav-item">
        <button class="nav-tab">‚öñÔ∏è Difference Tests <span style="font-size:10px">‚ñº</span></button>
        <div class="dropdown">
          <a href="t_test.html" class="dropdown-item">t-Test</a>
          <a href="anova.html" class="dropdown-item">ANOVA</a>
          <a href="chi_square.html" class="dropdown-item">Chi-square Test</a>
          <a href="nonparametric.html" class="dropdown-item">Nonparametric Tests</a>
        </div>
      </div>
      
      <!-- 4. Relationship Analysis -->
      <div class="nav-item">
        <button class="nav-tab">üìà Relationship <span style="font-size:10px">‚ñº</span></button>
        <div class="dropdown">
          <a href="correlation.html" class="dropdown-item">Correlation Analysis</a>
          <a href="regression.html" class="dropdown-item">Regression Analysis</a>
        </div>
      </div>
      
      <!-- 5. Multivariate Analysis -->
      <div class="nav-item">
        <button class="nav-tab">üéØ Multivariate <span style="font-size:10px">‚ñº</span></button>
        <div class="dropdown">
          <a href="EFA.html" class="dropdown-item">EFA</a>
          <a href="CFA.html" class="dropdown-item">CFA</a>
          <a href="cluster.html" class="dropdown-item">Cluster Analysis</a>
          <a href="discriminant.html" class="dropdown-item">Discriminant Analysis</a>
          <a href="pca.html" class="dropdown-item">PCA</a>
          <a href="mds.html" class="dropdown-item">MDS</a>
          <a href="correspondence.html" class="dropdown-item">Correspondence Analysis</a>
        </div>
      </div>
      
      <!-- 6. Specialized Analyses -->
      <div class="nav-item">
        <button class="nav-tab">üî¨ Specialized <span style="font-size:10px">‚ñº</span></button>
        <div class="dropdown">
          <a href="survival.html" class="dropdown-item">Survival Analysis</a>
          <a href="timeseries.html" class="dropdown-item">Time Series Analysis</a>
        </div>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="btn ghost icon" onclick="showNotifications()">üîî</button>
      <button class="btn ghost icon" onclick="showSettings()">‚öôÔ∏è</button>
      <button class="btn primary small" onclick="exportResults()">üíæ Export</button>
      <div class="user-avatar">AD</div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">
  <div class="content-area active">
    <!-- Title Panel -->
    <div class="panel">
      <h1>üìà Descriptive Statistics Analysis</h1>
      <div class="muted">Upload CSV ‚Üí Select Analysis Type ‚Üí Configure Variables ‚Üí Run Analysis</div>
    </div>

    <!-- Data Input Panel -->
    <div class="panel">
      <div class="controls">
        <input id="fileInput" type="file" accept=".csv" style="padding:8px;">
        <button class="btn success" onclick="loadExample()">üìä Load Sample Data</button>
        <button class="btn ghost" onclick="resetAll()">üîÑ Reset</button>
        <button class="btn ghost" onclick="showHelp()">‚ùì Help</button>
      </div>
      <div id="dataPreview"></div>
    </div>

    <!-- Analysis Type Selection Panel -->
    <div class="panel" id="analysisTypePanel" style="display:none;">
      <h2>üìà Analysis Type Selection</h2>
      <div class="grid-3">
        <div class="model-card" onclick="selectAnalysisType('basic')" id="card-basic">
          <h4>üìä Basic Statistics</h4>
          <div class="desc">‚Ä¢ Mean, Median, Mode<br>‚Ä¢ Standard deviation<br>‚Ä¢ Min, Max, Range</div>
        </div>
        <div class="model-card" onclick="selectAnalysisType('distribution')" id="card-distribution">
          <h4>üìà Distribution Analysis</h4>
          <div class="desc">‚Ä¢ Skewness & Kurtosis<br>‚Ä¢ Normality tests<br>‚Ä¢ Q-Q plots</div>
        </div>
        <div class="model-card" onclick="selectAnalysisType('outlier')" id="card-outlier">
          <h4>üéØ Outlier Detection</h4>
          <div class="desc">‚Ä¢ IQR method<br>‚Ä¢ Z-score method<br>‚Ä¢ Box plots</div>
        </div>
      </div>
      <div class="grid-3" style="margin-top:16px;">
        <div class="model-card" onclick="selectAnalysisType('comparison')" id="card-comparison">
          <h4>‚öñÔ∏è Group Comparison</h4>
          <div class="desc">‚Ä¢ Compare by groups<br>‚Ä¢ Side-by-side plots<br>‚Ä¢ Statistical tests</div>
        </div>
        <div class="model-card" onclick="selectAnalysisType('categorical')" id="card-categorical">
          <h4>üìã Categorical Analysis</h4>
          <div class="desc">‚Ä¢ Frequency tables<br>‚Ä¢ Chi-square test<br>‚Ä¢ Bar charts</div>
        </div>
        <div class="model-card" onclick="selectAnalysisType('comprehensive')" id="card-comprehensive">
          <h4>üîç Comprehensive</h4>
          <div class="desc">‚Ä¢ All statistics<br>‚Ä¢ Correlation matrix<br>‚Ä¢ Full report</div>
        </div>
      </div>
    </div>

    <!-- Variable Configuration Panel -->
    <div class="panel" id="varPanel" style="display:none;">
      <h2>üéõÔ∏è Variable Configuration</h2>
      <div id="varSettings"></div>
      <div class="grid-3" style="margin-top:20px;">
        <div>
          <div style="margin-bottom:4px;font-weight:500;">Confidence Level</div>
          <select id="confidenceLevel">
            <option value="0.95">95%</option>
            <option value="0.99">99%</option>
            <option value="0.90">90%</option>
          </select>
        </div>
        <div>
          <div style="margin-bottom:4px;font-weight:500;">Missing Data Treatment</div>
          <select id="missingData">
            <option value="exclude">Exclude (listwise deletion)</option>
            <option value="mean">Replace with mean</option>
            <option value="median">Replace with median</option>
          </select>
        </div>
      </div>
      <div class="controls" style="margin-top:24px;">
        <button class="btn primary" onclick="runAnalysis()">üöÄ Run Analysis</button>
      </div>
    </div>

    <!-- Results Panel -->
    <div class="panel" id="resultsPanel" style="display:none;">
      <h2>üìà Analysis Results</h2>
      <div id="summarySection"></div>
      <div id="plotSection" class="plot-container"></div>
      <div id="interpretationSection"></div>
    </div>
  </div>
</div>

<script>
var currentData = null;
var selectedAnalysisType = null;
var analysisResults = {};

function loadExample() {
  var n = 150;
  var example = [];
  
  for (var i = 0; i < n; i++) {
    var groups = ['A', 'B', 'C'];
    var group = groups[Math.floor(i / (n/3))];
    
    var u1 = Math.random();
    var u2 = Math.random();
    var normal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2) * 15 + 100;
    
    example.push({
      id: i + 1,
      group: group,
      normal_var: parseFloat(normal.toFixed(2)),
      skewed_var: parseFloat((Math.pow(Math.random(), 2) * 100).toFixed(2)),
      uniform_var: parseFloat((Math.random() * 50 + 25).toFixed(2)),
      binary: Math.random() > 0.5 ? 'Yes' : 'No',
      category: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)]
    });
  }
  
  processData(example);
}

function processData(data) {
  if (!data || data.length === 0) return;
  
  currentData = data;
  identifyVariableTypes();
  
  var headers = Object.keys(currentData[0]);
  var preview = '<h3>üìã Data Preview</h3>';
  preview += '<div class="table-container"><table><thead><tr>';
  headers.forEach(function(h) { preview += '<th>' + h + '</th>'; });
  preview += '</tr></thead><tbody>';
  
  currentData.slice(0, 10).forEach(function(r) {
    preview += '<tr>';
    headers.forEach(function(h) { 
      var val = r[h] || '';
      if (typeof val === 'number') val = val.toFixed(2);
      preview += '<td>' + val + '</td>'; 
    });
    preview += '</tr>';
  });
  
  preview += '</tbody></table></div>';
  preview += '<div class="muted" style="margin-top:12px;">üìä Rows: ' + currentData.length + ' | üì¢ Columns: ' + headers.length + '</div>';
  
  document.getElementById('dataPreview').innerHTML = preview;
  document.getElementById('analysisTypePanel').style.display = 'block';
}

function identifyVariableTypes() {
  if (!currentData) return;
  
  var headers = Object.keys(currentData[0]);
  var varTypes = {};
  
  headers.forEach(function(header) {
    var values = currentData.map(function(row) { return row[header]; }).filter(function(v) { return v !== '' && v !== null; });
    var numericValues = values.filter(function(v) { return !isNaN(parseFloat(v)); });
    varTypes[header] = (numericValues.length / values.length > 0.8) ? 'numeric' : 'categorical';
  });
  
  currentData.varTypes = varTypes;
}

function selectAnalysisType(type) {
  selectedAnalysisType = type;
  
  document.querySelectorAll('.model-card').forEach(function(card) {
    card.classList.remove('selected');
  });
  document.getElementById('card-' + type).classList.add('selected');
  
  updateVarUI();
  document.getElementById('varPanel').style.display = 'block';
}

function updateVarUI() {
  if (!selectedAnalysisType || !currentData) return;
  
  var headers = Object.keys(currentData[0]);
  var numericVars = headers.filter(function(h) { return currentData.varTypes[h] === 'numeric'; });
  var categoricalVars = headers.filter(function(h) { return currentData.varTypes[h] === 'categorical'; });
  
  var html = '';
  
  if (selectedAnalysisType === 'basic' || selectedAnalysisType === 'comprehensive') {
    html = '<div class="grid-2">';
    html += '<div><div style="margin-bottom:8px;font-weight:500;">Numeric Variables</div>';
    html += '<div class="var-checkbox-container">';
    numericVars.forEach(function(v) {
      html += '<label><input type="checkbox" class="num-var" value="' + v + '" checked> ' + v + '</label>';
    });
    html += '</div></div>';
    html += '<div><div style="margin-bottom:8px;font-weight:500;">Categorical Variables</div>';
    html += '<div class="var-checkbox-container">';
    categoricalVars.forEach(function(v) {
      html += '<label><input type="checkbox" class="cat-var" value="' + v + '"> ' + v + '</label>';
    });
    html += '</div></div></div>';
    
  } else if (selectedAnalysisType === 'distribution' || selectedAnalysisType === 'outlier') {
    html = '<div><div style="margin-bottom:8px;font-weight:500;">Select Variables</div>';
    html += '<div class="var-checkbox-container">';
    numericVars.forEach(function(v) {
      html += '<label><input type="checkbox" class="analysis-var" value="' + v + '" checked> ' + v + '</label>';
    });
    html += '</div></div>';
    
  } else if (selectedAnalysisType === 'comparison') {
    html = '<div class="grid-2">';
    html += '<div><div style="margin-bottom:4px;font-weight:500;">Grouping Variable</div>';
    html += '<select id="groupVar">';
    categoricalVars.forEach(function(v) {
      html += '<option value="' + v + '">' + v + '</option>';
    });
    html += '</select></div>';
    html += '<div><div style="margin-bottom:8px;font-weight:500;">Variables to Compare</div>';
    html += '<div class="var-checkbox-container">';
    numericVars.forEach(function(v) {
      html += '<label><input type="checkbox" class="compare-var" value="' + v + '" checked> ' + v + '</label>';
    });
    html += '</div></div></div>';
    
  } else if (selectedAnalysisType === 'categorical') {
    html = '<div><div style="margin-bottom:8px;font-weight:500;">Select Variables</div>';
    html += '<div class="var-checkbox-container">';
    categoricalVars.forEach(function(v) {
      html += '<label><input type="checkbox" class="cat-analysis-var" value="' + v + '" checked> ' + v + '</label>';
    });
    html += '</div></div>';
  }
  
  document.getElementById('varSettings').innerHTML = html;
}

// Statistical Functions
function mean(arr) {
  return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
}

function median(arr) {
  var sorted = arr.slice().sort(function(a, b) { return a - b; });
  var mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

function mode(arr) {
  var frequency = {};
  var maxFreq = 0;
  var modes = [];
  
  arr.forEach(function(value) {
    frequency[value] = (frequency[value] || 0) + 1;
    if (frequency[value] > maxFreq) {
      maxFreq = frequency[value];
    }
  });
  
  for (var value in frequency) {
    if (frequency[value] === maxFreq) {
      modes.push(parseFloat(value));
    }
  }
  
  return modes.length === 1 ? modes[0] : modes;
}

function variance(arr) {
  var m = mean(arr);
  return arr.reduce(function(sum, x) { return sum + Math.pow(x - m, 2); }, 0) / (arr.length - 1);
}

function stddev(arr) {
  return Math.sqrt(variance(arr));
}

function percentile(arr, p) {
  var sorted = arr.slice().sort(function(a, b) { return a - b; });
  var index = (p / 100) * (sorted.length - 1);
  var lower = Math.floor(index);
  var upper = Math.ceil(index);
  var weight = index % 1;
  
  if (lower === upper) return sorted[lower];
  return sorted[lower] * (1 - weight) + sorted[upper] * weight;
}

function skewness(arr) {
  var n = arr.length;
  var m = mean(arr);
  var s = stddev(arr);
  
  var sum = 0;
  for (var i = 0; i < n; i++) {
    sum += Math.pow((arr[i] - m) / s, 3);
  }
  
  return (n / ((n - 1) * (n - 2))) * sum;
}

function kurtosis(arr) {
  var n = arr.length;
  var m = mean(arr);
  var s = stddev(arr);
  
  var sum = 0;
  for (var i = 0; i < n; i++) {
    sum += Math.pow((arr[i] - m) / s, 4);
  }
  
  return (n * (n + 1) / ((n - 1) * (n - 2) * (n - 3))) * sum - 
         (3 * Math.pow(n - 1, 2) / ((n - 2) * (n - 3)));
}

function calculateCorrelation(arr1, arr2) {
  if (arr1.length !== arr2.length) return 0;
  
  var n = arr1.length;
  var mean1 = mean(arr1);
  var mean2 = mean(arr2);
  
  var num = 0;
  var den1 = 0;
  var den2 = 0;
  
  for (var i = 0; i < n; i++) {
    var diff1 = arr1[i] - mean1;
    var diff2 = arr2[i] - mean2;
    num += diff1 * diff2;
    den1 += diff1 * diff1;
    den2 += diff2 * diff2;
  }
  
  if (den1 === 0 || den2 === 0) return 0;
  return num / Math.sqrt(den1 * den2);
}

function detectOutliers(arr, method) {
  var outliers = [];
  
  if (method === 'iqr') {
    var q1 = percentile(arr, 25);
    var q3 = percentile(arr, 75);
    var iqrVal = q3 - q1;
    var lowerBound = q1 - 1.5 * iqrVal;
    var upperBound = q3 + 1.5 * iqrVal;
    
    outliers = arr.filter(function(v) { return v < lowerBound || v > upperBound; });
    
    return {
      outliers: outliers,
      lowerBound: lowerBound,
      upperBound: upperBound,
      count: outliers.length,
      percentage: (outliers.length / arr.length) * 100,
      method: 'IQR'
    };
  } else {
    var m = mean(arr);
    var s = stddev(arr);
    var threshold = 3;
    
    arr.forEach(function(value) {
      if (Math.abs((value - m) / s) > threshold) {
        outliers.push(value);
      }
    });
    
    return {
      outliers: outliers,
      threshold: threshold,
      count: outliers.length,
      percentage: (outliers.length / arr.length) * 100,
      method: 'Z-score'
    };
  }
}

function handleMissingData(data, variable, method) {
  var values = data.map(function(row) { return row[variable]; });
  var validValues = values.filter(function(v) { return v !== '' && v !== null && !isNaN(parseFloat(v)); });
  
  if (method === 'exclude') {
    return validValues.map(function(v) { return parseFloat(v); });
  } else if (method === 'mean') {
    var m = mean(validValues.map(function(v) { return parseFloat(v); }));
    return values.map(function(v) {
      return (v === '' || v === null || isNaN(parseFloat(v))) ? m : parseFloat(v);
    });
  } else if (method === 'median') {
    var med = median(validValues.map(function(v) { return parseFloat(v); }));
    return values.map(function(v) {
      return (v === '' || v === null || isNaN(parseFloat(v))) ? med : parseFloat(v);
    });
  }
  return validValues.map(function(v) { return parseFloat(v); });
}

function analyzeBasicStats(variable) {
  var missingMethod = document.getElementById('missingData').value;
  var values = handleMissingData(currentData, variable, missingMethod);
  
  if (values.length === 0) return null;
  
  var n = values.length;
  var missing = currentData.length - values.length;
  var m = mean(values);
  var med = median(values);
  var mod = mode(values);
  var std = stddev(values);
  var vari = variance(values);
  var min = Math.min.apply(null, values);
  var max = Math.max.apply(null, values);
  var range = max - min;
  var q1 = percentile(values, 25);
  var q3 = percentile(values, 75);
  var iqrVal = q3 - q1;
  var skew = skewness(values);
  var kurt = kurtosis(values);
  var cv = (std / Math.abs(m)) * 100;
  var se = std / Math.sqrt(n);
  
  var confidence = parseFloat(document.getElementById('confidenceLevel').value);
  var zScore = confidence === 0.99 ? 2.576 : confidence === 0.95 ? 1.96 : 1.645;
  var ci = [m - zScore * se, m + zScore * se];
  
  return {
    n: n, missing: missing, mean: m, median: med, mode: mod, std: std, variance: vari,
    min: min, max: max, range: range, q1: q1, q3: q3, iqr: iqrVal,
    skewness: skew, kurtosis: kurt, cv: cv, se: se, ci: ci,
    values: values
  };
}

function analyzeCategorical(variable) {
  var values = currentData.map(function(row) { return row[variable]; })
    .filter(function(v) { return v !== '' && v !== null; });
  
  var freq = {};
  values.forEach(function(v) { freq[v] = (freq[v] || 0) + 1; });
  
  var total = values.length;
  var categories = Object.keys(freq);
  
  return {
    total: total,
    missing: currentData.length - total,
    categories: categories.length,
    frequency: freq,
    mode: categories.reduce(function(a, b) { return freq[a] > freq[b] ? a : b; })
  };
}

function analyzeGroupComparison(groupVar, compareVars) {
  var groups = {};
  
  currentData.forEach(function(row) {
    var group = row[groupVar];
    if (!groups[group]) groups[group] = {};
    
    compareVars.forEach(function(v) {
      if (!groups[group][v]) groups[group][v] = [];
      var val = parseFloat(row[v]);
      if (!isNaN(val)) groups[group][v].push(val);
    });
  });
  
  var results = {};
  
  Object.keys(groups).forEach(function(groupName) {
    results[groupName] = {};
    compareVars.forEach(function(v) {
      var values = groups[groupName][v];
      if (values && values.length > 0) {
        results[groupName][v] = {
          n: values.length,
          mean: mean(values),
          median: median(values),
          std: stddev(values),
          min: Math.min.apply(null, values),
          max: Math.max.apply(null, values),
          values: values
        };
      }
    });
  });
  
  return results;
}

function runAnalysis() {
  if (!selectedAnalysisType || !currentData) {
    alert('Please select an analysis type and load data first.');
    return;
  }
  
  analysisResults = {};
  var html = '';
  var interpretHtml = '';
  var type = selectedAnalysisType;
  
  if (type === 'basic') {
    var numVars = Array.from(document.querySelectorAll('.num-var:checked')).map(function(cb) { return cb.value; });
    
    html = '<h3>Basic Statistics</h3>';
    html += '<div class="table-container"><table><thead><tr>';
    html += '<th>Variable</th><th>N</th><th>Mean</th><th>Median</th><th>Mode</th><th>Std Dev</th><th>Min</th><th>Max</th>';
    html += '</tr></thead><tbody>';
    
    numVars.forEach(function(v) {
      var stats = analyzeBasicStats(v);
      if (stats) {
        analysisResults[v] = stats;
        var modeVal = Array.isArray(stats.mode) ? stats.mode.slice(0,2).join(', ') : stats.mode.toFixed(2);
        
        html += '<tr><td>' + v + '</td><td>' + stats.n + '</td>';
        html += '<td>' + stats.mean.toFixed(2) + '</td><td>' + stats.median.toFixed(2) + '</td>';
        html += '<td>' + modeVal + '</td><td>' + stats.std.toFixed(2) + '</td>';
        html += '<td>' + stats.min.toFixed(2) + '</td><td>' + stats.max.toFixed(2) + '</td></tr>';
        
        interpretHtml += interpretBasicStats(stats, v);
      }
    });
    html += '</tbody></table></div>';
    
    createVisualization(numVars);
    
  } else if (type === 'comprehensive') {
    var numVars = Array.from(document.querySelectorAll('.num-var:checked')).map(function(cb) { return cb.value; });
    
    html = '<h3>Comprehensive Statistics</h3>';
    html += '<h4>Descriptive Statistics</h4>';
    html += '<div class="table-container"><table><thead><tr>';
    html += '<th>Variable</th><th>N</th><th>Mean</th><th>Median</th><th>Mode</th><th>Std Dev</th><th>CV%</th>';
    html += '</tr></thead><tbody>';
    
    numVars.forEach(function(v) {
      var stats = analyzeBasicStats(v);
      if (stats) {
        analysisResults[v] = stats;
        var modeVal = Array.isArray(stats.mode) ? stats.mode.slice(0,2).join(', ') : stats.mode.toFixed(2);
        
        html += '<tr><td>' + v + '</td><td>' + stats.n + '</td>';
        html += '<td>' + stats.mean.toFixed(2) + '</td><td>' + stats.median.toFixed(2) + '</td>';
        html += '<td>' + modeVal + '</td><td>' + stats.std.toFixed(2) + '</td>';
        html += '<td>' + stats.cv.toFixed(1) + '</td></tr>';
      }
    });
    html += '</tbody></table></div>';
    
    // Distribution Stats
    html += '<h4>Distribution & Range</h4>';
    html += '<div class="table-container"><table><thead><tr>';
    html += '<th>Variable</th><th>Min</th><th>Q1</th><th>Q3</th><th>Max</th><th>IQR</th><th>Skewness</th><th>Kurtosis</th>';
    html += '</tr></thead><tbody>';
    
    numVars.forEach(function(v) {
      var stats = analysisResults[v];
      if (stats) {
        html += '<tr><td>' + v + '</td>';
        html += '<td>' + stats.min.toFixed(2) + '</td><td>' + stats.q1.toFixed(2) + '</td>';
        html += '<td>' + stats.q3.toFixed(2) + '</td><td>' + stats.max.toFixed(2) + '</td>';
        html += '<td>' + stats.iqr.toFixed(2) + '</td><td>' + stats.skewness.toFixed(3) + '</td>';
        html += '<td>' + stats.kurtosis.toFixed(3) + '</td></tr>';
        
        interpretHtml += interpretBasicStats(stats, v);
        interpretHtml += interpretDistribution(stats, v);
      }
    });
    html += '</tbody></table></div>';
    
    // Correlation Matrix
    if (numVars.length > 1) {
      html += '<h4>Correlation Matrix</h4>';
      html += '<div class="table-container"><table><thead><tr><th></th>';
      numVars.forEach(function(v) {
        html += '<th>' + v + '</th>';
      });
      html += '</tr></thead><tbody>';
      
      numVars.forEach(function(v1) {
        html += '<tr><td><strong>' + v1 + '</strong></td>';
        numVars.forEach(function(v2) {
          var corr = calculateCorrelation(analysisResults[v1].values, analysisResults[v2].values);
          var color = Math.abs(corr) > 0.7 ? 'color:#ef4444' : Math.abs(corr) > 0.4 ? 'color:#f59e0b' : 'color:#10b981';
          html += '<td style="' + color + '">' + corr.toFixed(3) + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      
      interpretHtml += interpretCorrelationMatrix(numVars);
    }
    
    createVisualization(numVars);
    
  } else if (type === 'distribution') {
    var vars = Array.from(document.querySelectorAll('.analysis-var:checked')).map(function(cb) { return cb.value; });
    
    html = '<h3>Distribution Analysis</h3>';
    html += '<div class="table-container"><table><thead><tr>';
    html += '<th>Variable</th><th>Skewness</th><th>Kurtosis</th><th>Normality</th>';
    html += '</tr></thead><tbody>';
    
    vars.forEach(function(v) {
      var stats = analyzeBasicStats(v);
      if (stats) {
        analysisResults[v] = stats;
        var normal = Math.abs(stats.skewness) < 0.5 && Math.abs(stats.kurtosis) < 0.5;
        html += '<tr><td>' + v + '</td><td>' + stats.skewness.toFixed(3) + '</td>';
        html += '<td>' + stats.kurtosis.toFixed(3) + '</td>';
        html += '<td>' + (normal ? '‚úì Normal' : '‚úó Non-normal') + '</td></tr>';
        
        interpretHtml += interpretDistribution(stats, v);
      }
    });
    html += '</tbody></table></div>';
    
    createQQPlot(vars);
    
  } else if (type === 'outlier') {
    var vars = Array.from(document.querySelectorAll('.analysis-var:checked')).map(function(cb) { return cb.value; });
    
    html = '<h3>Outlier Detection</h3>';
    
    vars.forEach(function(v) {
      var stats = analyzeBasicStats(v);
      if (stats) {
        analysisResults[v] = stats;
        var iqrOut = detectOutliers(stats.values, 'iqr');
        var zOut = detectOutliers(stats.values, 'zscore');
        
        html += '<div style="margin:16px 0;padding:16px;background:#f8fafc;border-radius:8px;">';
        html += '<h4>' + v + '</h4>';
        html += '<div><strong>IQR Method:</strong> ' + iqrOut.count + ' outliers (' + iqrOut.percentage.toFixed(1) + '%)</div>';
        html += '<div>Bounds: [' + iqrOut.lowerBound.toFixed(2) + ', ' + iqrOut.upperBound.toFixed(2) + ']</div>';
        html += '<div style="margin-top:8px;"><strong>Z-Score Method:</strong> ' + zOut.count + ' outliers (' + zOut.percentage.toFixed(1) + '%)</div>';
        html += '<div>Threshold: |Z| > ' + zOut.threshold + '</div>';
        html += '</div>';
        
        interpretHtml += interpretOutliers(iqrOut, v);
      }
    });
    
    createVisualization(vars);
    
  } else if (type === 'comparison') {
    var groupVar = document.getElementById('groupVar').value;
    var compareVars = Array.from(document.querySelectorAll('.compare-var:checked')).map(function(cb) { return cb.value; });
    
    if (!groupVar || compareVars.length === 0) {
      alert('Please select variables.');
      return;
    }
    
    var groupResults = analyzeGroupComparison(groupVar, compareVars);
    analysisResults = groupResults;
    
    html = '<h3>Group Comparison: ' + groupVar + '</h3>';
    
    compareVars.forEach(function(v) {
      html += '<h4>' + v + '</h4>';
      html += '<div class="table-container"><table><thead><tr>';
      html += '<th>Group</th><th>N</th><th>Mean</th><th>Median</th><th>Std Dev</th>';
      html += '</tr></thead><tbody>';
      
      Object.keys(groupResults).forEach(function(group) {
        var stats = groupResults[group][v];
        if (stats) {
          html += '<tr><td>' + group + '</td><td>' + stats.n + '</td>';
          html += '<td>' + stats.mean.toFixed(2) + '</td><td>' + stats.median.toFixed(2) + '</td>';
          html += '<td>' + stats.std.toFixed(2) + '</td></tr>';
        }
      });
      
      html += '</tbody></table></div>';
    });
    
    interpretHtml += interpretGroupComparison(groupResults, groupVar, compareVars);
    
  } else if (type === 'categorical') {
    var vars = Array.from(document.querySelectorAll('.cat-analysis-var:checked')).map(function(cb) { return cb.value; });
    
    html = '<h3>Categorical Analysis</h3>';
    
    vars.forEach(function(v) {
      var stats = analyzeCategorical(v);
      if (stats) {
        html += '<h4>' + v + '</h4>';
        html += '<div class="table-container"><table><thead><tr>';
        html += '<th>Category</th><th>Frequency</th><th>Percentage</th>';
        html += '</tr></thead><tbody>';
        
        Object.entries(stats.frequency).forEach(function(entry) {
          html += '<tr><td>' + entry[0] + '</td><td>' + entry[1] + '</td>';
          html += '<td>' + (entry[1]/stats.total*100).toFixed(1) + '%</td></tr>';
        });
        
        html += '</tbody></table></div>';
        
        interpretHtml += interpretCategorical(stats, v);
      }
    });
  }
  
  document.getElementById('summarySection').innerHTML = html;
  document.getElementById('interpretationSection').innerHTML = interpretHtml;
  document.getElementById('resultsPanel').style.display = 'block';
}

// Interpretation Functions
function interpretBasicStats(stats, varName) {
  var html = '<div class="interpretation-box info">';
  html += '<h4>üìä Basic Statistics for ' + varName + '</h4>';
  
  var meanMedianDiff = Math.abs(stats.mean - stats.median);
  var relDiff = (meanMedianDiff / Math.abs(stats.mean)) * 100;
  
  if (relDiff < 5) {
    html += '<p>‚Ä¢ Central Tendency: Mean and median are similar, suggesting symmetric distribution.</p>';
  } else if (stats.mean > stats.median) {
    html += '<p>‚Ä¢ Central Tendency: Mean > Median, indicating right-skewed distribution.</p>';
  } else {
    html += '<p>‚Ä¢ Central Tendency: Mean < Median, indicating left-skewed distribution.</p>';
  }
  
  if (stats.cv < 15) {
    html += '<p>‚Ä¢ Variability: Low CV (' + stats.cv.toFixed(1) + '%) - data clustered around mean.</p>';
  } else if (stats.cv < 30) {
    html += '<p>‚Ä¢ Variability: Moderate CV (' + stats.cv.toFixed(1) + '%) - moderate spread.</p>';
  } else {
    html += '<p>‚Ä¢ Variability: High CV (' + stats.cv.toFixed(1) + '%) - substantial variation.</p>';
  }
  
  html += '<p>‚Ä¢ 95% CI: [' + stats.ci[0].toFixed(2) + ', ' + stats.ci[1].toFixed(2) + ']</p>';
  html += '</div>';
  return html;
}

function interpretDistribution(stats, varName) {
  var isNormal = Math.abs(stats.skewness) < 0.5 && Math.abs(stats.kurtosis) < 0.5;
  var html = '<div class="interpretation-box ' + (isNormal ? 'success' : 'warning') + '">';
  html += '<h4>üìà Distribution Analysis for ' + varName + '</h4>';
  
  if (Math.abs(stats.skewness) < 0.5) {
    html += '<p>‚Ä¢ Skewness (' + stats.skewness.toFixed(3) + '): Approximately symmetric.</p>';
  } else if (stats.skewness > 0) {
    html += '<p>‚Ä¢ Skewness (' + stats.skewness.toFixed(3) + '): Positive skew - tail extends right.</p>';
  } else {
    html += '<p>‚Ä¢ Skewness (' + stats.skewness.toFixed(3) + '): Negative skew - tail extends left.</p>';
  }
  
  if (Math.abs(stats.kurtosis) < 0.5) {
    html += '<p>‚Ä¢ Kurtosis (' + stats.kurtosis.toFixed(3) + '): Normal peak and tails.</p>';
  } else if (stats.kurtosis > 0) {
    html += '<p>‚Ä¢ Kurtosis (' + stats.kurtosis.toFixed(3) + '): Heavy-tailed with sharp peak.</p>';
  } else {
    html += '<p>‚Ä¢ Kurtosis (' + stats.kurtosis.toFixed(3) + '): Light-tailed with flat peak.</p>';
  }
  
  html += '<p>‚Ä¢ Normality: ' + (isNormal ? '‚úì Appears normal' : '‚úó Non-normal') + '</p>';
  html += '</div>';
  return html;
}

function interpretOutliers(result, varName) {
  var severity = result.percentage < 1 ? 'success' : result.percentage < 5 ? 'info' : 'warning';
  var html = '<div class="interpretation-box ' + severity + '">';
  html += '<h4>üéØ Outlier Detection (' + result.method + ') for ' + varName + '</h4>';
  
  if (result.count === 0) {
    html += '<p>No outliers detected.</p>';
  } else if (result.percentage < 5) {
    html += '<p>' + result.count + ' outliers (' + result.percentage.toFixed(1) + '%) - acceptable level.</p>';
  } else {
    html += '<p>' + result.count + ' outliers (' + result.percentage.toFixed(1) + '%) - review data quality.</p>';
  }
  
  html += '</div>';
  return html;
}

function interpretGroupComparison(groupResults, groupVar, compareVars) {
  var html = '<div class="interpretation-box info">';
  html += '<h4>‚öñÔ∏è Group Comparison Analysis</h4>';
  
  compareVars.forEach(function(v) {
    var means = Object.keys(groupResults).map(function(g) {
      return groupResults[g][v] ? groupResults[g][v].mean : null;
    }).filter(function(m) { return m !== null; });
    
    if (means.length > 1) {
      var maxMean = Math.max.apply(null, means);
      var minMean = Math.min.apply(null, means);
      var diff = ((maxMean - minMean) / minMean * 100).toFixed(1);
      
      html += '<p>' + v + ': ' + diff + '% difference between groups</p>';
    }
  });
  
  html += '</div>';
  return html;
}

function interpretCategorical(stats, varName) {
  var html = '<div class="interpretation-box info">';
  html += '<h4>üìã Categorical Analysis for ' + varName + '</h4>';
  html += '<p>‚Ä¢ Categories: ' + stats.categories + '</p>';
  html += '<p>‚Ä¢ Mode: "' + stats.mode + '"</p>';
  
  var maxFreq = Math.max.apply(null, Object.values(stats.frequency));
  var concentration = (maxFreq / stats.total * 100).toFixed(1);
  html += '<p>‚Ä¢ Top category concentration: ' + concentration + '%</p>';
  
  html += '</div>';
  return html;
}

function interpretCorrelationMatrix(numVars) {
  var html = '<div class="interpretation-box info">';
  html += '<h4>üìä Correlation Matrix Interpretation</h4>';
  
  var strongPairs = [];
  for (var i = 0; i < numVars.length; i++) {
    for (var j = i + 1; j < numVars.length; j++) {
      var corr = calculateCorrelation(analysisResults[numVars[i]].values, analysisResults[numVars[j]].values);
      if (Math.abs(corr) > 0.7) {
        strongPairs.push(numVars[i] + ' & ' + numVars[j] + ': r=' + corr.toFixed(3));
      }
    }
  }
  
  if (strongPairs.length > 0) {
    html += '<p><strong>Strong correlations detected:</strong></p>';
    strongPairs.forEach(function(pair) {
      html += '<p>‚Ä¢ ' + pair + '</p>';
    });
  } else {
    html += '<p>No strong correlations detected.</p>';
  }
  
  html += '</div>';
  return html;
}

// Visualization Functions
function createVisualization(variables) {
  if (variables.length === 0) return;
  
  var plotHtml = '<div id="histogramPlot" class="plot-item"></div>';
  plotHtml += '<div id="boxPlot" class="plot-item"></div>';
  
  document.getElementById('plotSection').innerHTML = plotHtml;
  
  var firstVar = variables[0];
  var stats = analysisResults[firstVar];
  if (!stats || !stats.values) return;
  
  // Histogram
  var histData = [{
    x: stats.values,
    type: 'histogram',
    marker: { color: '#3b82f6' }
  }];
  
  var histLayout = {
    title: 'Distribution of ' + firstVar,
    xaxis: { title: firstVar },
    yaxis: { title: 'Frequency' },
    margin: { l: 50, r: 20, t: 40, b: 40 }
  };
  
  // Box plot
  var boxData = variables.map(function(v) {
    var s = analysisResults[v];
    if (s && s.values) {
      return { y: s.values, type: 'box', name: v };
    }
  }).filter(Boolean);
  
  var boxLayout = {
    title: 'Box Plots',
    yaxis: { title: 'Value' },
    margin: { l: 50, r: 20, t: 40, b: 40 }
  };
  
  setTimeout(function() {
    Plotly.newPlot('histogramPlot', histData, histLayout, {displayModeBar: false, responsive: true});
    Plotly.newPlot('boxPlot', boxData, boxLayout, {displayModeBar: false, responsive: true});
  }, 100);
}

function createQQPlot(variables) {
  if (variables.length === 0) return;
  
  var plotHtml = '<div id="qqPlot" class="plot-item" style="grid-column:1/-1;height:400px;"></div>';
  document.getElementById('plotSection').innerHTML = plotHtml;
  
  var traces = [];
  variables.forEach(function(v) {
    var stats = analysisResults[v];
    if (stats && stats.values) {
      var sortedValues = stats.values.slice().sort(function(a, b) { return a - b; });
      var n = sortedValues.length;
      var theoretical = [];
      
      for (var i = 0; i < n; i++) {
        var p = (i + 0.5) / n;
        var z = qnorm(p);
        theoretical.push(stats.mean + z * stats.std);
      }
      
      traces.push({
        x: theoretical,
        y: sortedValues,
        mode: 'markers',
        type: 'scatter',
        name: v,
        marker: { size: 5 }
      });
    }
  });
  
  var layout = {
    title: 'Q-Q Plot',
    xaxis: { title: 'Theoretical Quantiles' },
    yaxis: { title: 'Sample Quantiles' }
  };
  
  setTimeout(function() {
    Plotly.newPlot('qqPlot', traces, layout, {displayModeBar: false, responsive: true});
  }, 100);
}

function qnorm(p) {
  // Approximate inverse normal CDF
  var a = [2.50662823884, -18.61500062529, 41.39119773534, -25.44106049637];
  var b = [-8.47351093090, 23.08336743743, -21.06224101826, 3.13082909833];
  
  var y = p - 0.5;
  var r, x;
  
  if (Math.abs(y) < 0.42) {
    r = y * y;
    x = y * (((a[3] * r + a[2]) * r + a[1]) * r + a[0]) / 
            ((((b[3] * r + b[2]) * r + b[1]) * r + b[0]) * r + 1.0);
  } else {
    r = p;
    if (y > 0) r = 1 - p;
    r = Math.log(-Math.log(r));
    x = 1.238 * r + 0.146;
    if (y < 0) x = -x;
  }
  
  return x;
}

// Utility Functions
function exportResults() {
  if (Object.keys(analysisResults).length === 0) {
    alert('No results to export.');
    return;
  }
  
  var data = JSON.stringify(analysisResults, null, 2);
  var blob = new Blob([data], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'analysis-results.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function showNotifications() {
  alert('üîî No new notifications');
}

function showSettings() {
  alert('‚öôÔ∏è Settings panel coming soon');
}

function showHelp() {
  alert('üìà Descriptive Statistics Guide:\n\n‚Ä¢ Basic: Mean, median, mode, standard deviation\n‚Ä¢ Distribution: Skewness, kurtosis, Q-Q plots\n‚Ä¢ Outliers: IQR and Z-score detection\n‚Ä¢ Comparison: Group-by-group analysis\n‚Ä¢ Categorical: Frequency tables\n‚Ä¢ Comprehensive: All statistics combined\n\nInterpretation includes practical insights for each measure.');
}

function resetAll() {
  currentData = null;
  selectedAnalysisType = null;
  analysisResults = {};
  
  document.getElementById('dataPreview').innerHTML = '';
  document.getElementById('analysisTypePanel').style.display = 'none';
  document.getElementById('varPanel').style.display = 'none';
  document.getElementById('resultsPanel').style.display = 'none';
  
  alert('Reset completed!');
}

// CSV Loading
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('fileInput').addEventListener('change', function(event) {
    var file = event.target.files[0];
    if (file) {
      Papa.parse(file, {
        complete: function(results) {
          if (results.data && results.data.length > 1) {
            processData(results.data);
          }
        },
        header: true,
        skipEmptyLines: true,
        dynamicTyping: true
      });
    }
  });
});
</script>
</body>
</html>
